---
title: "clinical-metadata-functions"
author: "Giulia"
date: '2022-11-08'
output: html_document
---


# Extract clinical

```{r}
extract_clinical <- function(clinical_metadata){
  #Change checked/unchecked
  clinical_metadata[] <- lapply(clinical_metadata, gsub, pattern = "Checked|Yes|Positive|Postitive", replacement = 1)
  clinical_metadata[] <- lapply(clinical_metadata, gsub, pattern = "Unchecked|Negative", replacement = 0)
  
  # Remove training white space
  colnames(clinical_metadata) <- str_squish(colnames(clinical_metadata))
  
  # Fix up column names
  colnames(clinical_metadata) <- gsub("Current.Medications.at.Bronchoscopy..choice.|Bronchoalveolar.Growth..choice.", "", colnames(clinical_metadata))
  colnames(clinical_metadata) <- gsub("Pre.Transplant.Therapy..choice.", "PreTx", colnames(clinical_metadata))
  colnames(clinical_metadata) <- gsub("Induction.Therapy..choice.", "Induction", colnames(clinical_metadata))
  colnames(clinical_metadata) <- gsub("Sputum.Growth..choice.", "BalSputum", colnames(clinical_metadata))
  colnames(clinical_metadata) <- gsub("Respiratory.Viral.PCR.Result..choice.", "ResViralPCR", colnames(clinical_metadata))
  colnames(clinical_metadata) <- gsub("MMF.", "Mycophenolate-Mofetil", colnames(clinical_metadata))

  clinical_metadata$Donation.Pathway <- str_replace_all(clinical_metadata$Donation.Pathway, c(" - Donation after Brain Death" = "", " - Donation after Cardiac Death" = ""))
  clinical_metadata$Type.of.Transplant <- str_replace_all(clinical_metadata$Type.of.Transplant, c("Bilateral Lung Transplant" = "BLT", 
                                                                                                  "Left Single Lung Transplant" = "LSLT", 
                                                                                                  "Right Single Lung Transplant" = "RSLT",
                                                                                                  "Re-do BLT" = "BLT", 
                                                                                                  "Heart & Lung Transplant" = "BLT"))
   clinical_metadata <- clinical_metadata %>%
    dplyr::rename(transplant_date = Date.of.Transplant) %>%
    mutate(transplant_date = as.Date(transplant_date, format = "%d/%m/%Y")) %>%
    dplyr::rename(Transplant_indication_other = If.Primary.Resp.Diagnosis.is..Other...document... ,
           Age = Age.at.Transplant, 
           Hospital_stay = Hospital.Stay..Days. ,
           Donor.positive.sputum.at.tx = Donor.Positive.Sputum.BAL.Growth.at.Transplant, 
           Transplant_indication = Primary.Respiratory.Diagnosis.at.Listing, 
           First_transplant_indication = Primary.Respiratory.Diagnosis.prior.to.First.Transplant
           ) 
   
    clinical_metadata$Transplant_indication <- str_replace_all(clinical_metadata$Transplant_indication, c("Interstitial Lung Disease" = "ILD", 
                                                                                                          "Idiopathic Pulmonary Fibrosis" = "ILD", 
                                                                                                          "Combined Pulmonary fibrosis and emphysema" = "ILD",
                                                                                                          "Cystic Fibrosis" = "CF/NCFB", 
                                                                                                          "Non-CF Bronchiectasis" = "CF/NCFB",
                                                                                                          "Pulmonary Hypertension" = "Other"))
    clinical_metadata$First_transplant_indication <- str_replace_all(clinical_metadata$First_transplant_indication, c("Interstitial Lung Disease" = "ILD", 
                                                                                                          "Idiopathic Pulmonary Fibrosis" = "ILD", 
                                                                                                          "Combined Pulmonary fibrosis and emphysema" = "ILD",
                                                                                                          "Cystic Fibrosis" = "CF/NCFB", 
                                                                                                          "Non-CF Bronchiectasis" = "CF/NCFB",
                                                                                                          "Pulmonary Hypertension" = "Other"))
    
  # Fill empty cells
  clinical_metadata$Donor.positive.sputum.at.tx[which(clinical_metadata$Donor.positive.sputum.at.tx == "")] <- "Not Done"
  clinical_metadata$Pre.Transplant.Sputum.Specimens[which(clinical_metadata$Pre.Transplant.Sputum.Specimens == "")] <- "Not Done"
  clinical_metadata$DSA.at.Transplant[which(clinical_metadata$DSA.at.Transplant == "")] <- "Not Done"
  
  #bronch_metadata$`EBV.Mismatch`[which(bronch_metadata$`EBV.Mismatch` == "")] <- "Not Done"
  #general_metadata$`T.Cell.X.Match`[which(general_metadata$`T.Cell.X.Match` == "")] <- "Not Done"
  #general_metadata$`B.Cell.X.Match` <- str_replace_all(general_metadata$`B.Cell.X.Match`, c("\\s*\\([1-8]+\\)" = ""))
  #general_metadata$`Post.Transplant.ECMO`[which(general_metadata$`Post.Transplant.ECMO` == "")] <- "Not Done"
  
  clinical_metadata$Record.ID <- as.numeric(clinical_metadata$Record.ID)
  
  return(clinical_metadata)
}
```

# General

```{r}
# GENERAL METADATA
extract_general <- function(general_metadata, metadata){
  
  #metadata <- list()
  
  general_metadata <- general_metadata %>% 
    filter(Repeat.Instrument == "") %>%
    mutate(across(where(is.character), ~na_if(trimws(.),""))) %>% 
    remove_empty("cols") %>% #remove empty columns
    dplyr::select(!contains(c('Repeat.Instrument', 'Complete.','Birth','Consent', 
                                                                     'Height', 'Weight', 'Body.Mass.Index', 
                                                                     'Extubation', 'ATAGC', 'Biopsy', 'Exit', "HLA",
                                                                     'Study.Completed', 'Blood', 'EVLP', 'Status', 
                                                                     'EBV', 'T.Cell', 'B.Cell', 'Pre.Transplant.ECMO', 'Post.Transplant.ECMO', 
                                                                     'Withdrawn', 'Date.of.Death', "TLCO", "RV", "TLC", "DSA.Details", 
                                                                     "If.other..please.document.medication", "X12Month.CLAD.Assessment.Completed",
                                                                     "X2.Year.CLAD.Assessment.Completed", "X3.Year.CLAD.Assessment.Completed", 
                                                                     "If.Other..please.detail.reason", "CLAD", "Intubated.at.24.Hours",
                                                                     "Death.with.a.Functional.Graft", "Relocation",
                                                                     "FEV1", "FEV1...predicted", "FVC", "FVC...predicted", "FEV1.FVC", 
                                                                     "Time.From.Transplant.6", "Date.of.Re.Transplant", "Study.Completion.Outcome", "Reason.for.Withdrawal",
                                                                     "Date.of.lung.function", "Days.from.Transplant"))) %>%
    mutate(across(contains(c("Age", "Intubation.Hours", "Hospital_stay", "ICU.Hours")), ~as.numeric(.))) # turn values to numeric
  
  # Turn values to numeric
  #numeric_cols <- general_metadata %>% dplyr::select(contains(c("Age", "Intubation.Hours", "Hospital_stay", "ICU.Hours"))) %>% colnames(.)
  #general_metadata[,c(numeric_cols)] <- sapply(general_metadata[,c(numeric_cols)], function(x) as.numeric(as.character(x)))
  
  # Change values in cells
  columns <- c("CMV.Mismatch", "DSA.at.Transplant", "Donor.CMV", "Donor.positive.sputum.at.tx", "PreTxNone.", "PreTxIVIg.Therapy.", "PreTxSteroid.Therapy.", "PreTxImmunosuppression.Therapy.", "Pre.Transplant.Sputum.Specimens", "InductionTacrolimus.", "InductionAzathioprine.", "InductionMycophenolate.", "InductionBasilimax.", "InductionOther.")
  
  for (i in 1:length(columns)){
    general_metadata[,columns[i]] <- ifelse(general_metadata[,columns[i]] %in% c(1, "1"), gsub("\\.", "", as.character(columns[i])), 
                                            ifelse(general_metadata[,columns[i]] %in% c(0, "0", "No"), paste0("No", gsub("\\.", "", as.character(columns[i]))), general_metadata[,columns[i]]))}
  
  colnames(general_metadata) <- gsub("\\.", "", colnames(general_metadata))
  colnames(general_metadata)[1] <- "Record.ID"
  
  # add tx modified
  general_metadata$Transplant_indication <- factor(general_metadata$Transplant_indication, levels = c("CF/NCFB", "CLAD", "ILD", "COPD", "Other"))
  
  metadata[["general_metadata"]] <- general_metadata %>% dplyr::select(Record.ID:Hospital_stay)
  return(metadata)
}
```

# Bronch

```{r}
# BRONCHOSCOPHY
extract_bronchs <- function(clinical_metadata, metadata){

  bronch_metadata <- clinical_metadata %>% filter(Repeat.Instrument == 'Bronchoscopies') 
  
  bronch_metadata <- bronch_metadata %>%
    dplyr::select(Record.ID, Days.From.Transplant:If.Positive..record.findings.1) %>% 
    dplyr::select(!contains(c('Biomarker', 'Volume', 'Biopsy', 'IGG', 'AFB')))
  
# Fix medications
## Antifungals
  bronch_metadata$Posaconazole <- ifelse(str_detect(bronch_metadata$`List.Anti.Fungal`, c("pos|Pos|poz|Poz")), "Posaconazole", "NoPosaconazole")
  bronch_metadata$Voriconazole <- ifelse(str_detect(bronch_metadata$`List.Anti.Fungal`, c("vori|Vori")), "Voriconazole", "NoVoriconazole")
  bronch_metadata$AmphothericinB <- ifelse(str_detect(bronch_metadata$`List.Anti.Fungal`, c("photer")), "AmphothericinB", "NoAmphothericinB")
  ## Antibiotics
  bronch_metadata$Ciprofloxacin <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("iproflo|Cipro")), "Ciprofloxacin", "NoCiprofloxacin")
  bronch_metadata$`Piperacillin-Tazobactam` <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("tazo|Tazo")), "Piperacillin-Tazobactam", "NoPiperacillin-Tazobactam")
  bronch_metadata$Augmentin <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("Aug|aug")), "Augmentin", "NoAugmentin")
  bronch_metadata$Meropenem <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("penem|erope")), "Meropenem", "NoMeropenem")
  bronch_metadata$Tobramycin <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("obram|Tobi|bipod|odinh")), "Tobramycin",  "NoTobramycin")
  bronch_metadata$Trimethoprim <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("meth")), "Trimethoprim",  "NoTrimethoprim")
  bronch_metadata$Pentamidine <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("midine")), "Pentamidine", "NoPentamidine")
  bronch_metadata$Moxifloxacin <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("oxiflo")), "Moxifloxacin", "NoMoxifloxacin")
  bronch_metadata$Colistin <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("listin")), "Colistin", "NoColistin")
  bronch_metadata$Resprim <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("esprim")), "Resprim", "NoResprim")
  bronch_metadata$Vancomycin <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("ancomycin")), "Vancomycin", "NoVancomycin")
  bronch_metadata$Amoxycillin <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("Amoxy|amoxy")), "Amoxycillin", "NoAmoxycillin")
  bronch_metadata$Isozianid <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("oniazid")), "Isozianid", "NoIsozianid")
  bronch_metadata$Ceftazidime <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("eftazidine")), "Ceftazidime", "NoCeftazidime")
  bronch_metadata$Flucloxacillin <- ifelse(str_detect(bronch_metadata$List.Antibiotics, c("lucloxa")), "Flucloxacillin", "NoFlucloxacillin")

# Create patient_days column 
  bronch_metadata <- bronch_metadata %>%
     mutate(Patient_days = paste0(Record.ID, "_", Days.From.Transplant)) %>%
     relocate(Patient_days, .after = Days.From.Transplant) %>%
     dplyr::rename(Days = Days.From.Transplant)
  
  # Change values in cells
  columns <- c("Tacrolimus.", "Cyclosporin.", "Everolimus.", "Azathioprine.", "Mycophenolate-Mofetil", "Prednisolone.", "Bactrim.DS.", "Valganciclovir.", "Ganciclovir.", "Azithromycin." , "Anti.Fungal.", "Antibiotics.", "Valaciclovir.", "CMV.in.BAL", "Not.Growth.", "Yeast.Species.", "Staphylococcus.Aureus..MRSA..", "Pseudomonas.Species.", "Klebsiella.Pneumoniae.", "Serratia.Marcescens.","Stenotrophomonas.Maltophilia.","Aspergillus.Species.", "Penicillium.Species.","Scedosporium.Species.","Escherichia.Coli.", "Enterobacter.Aerogenes.")
  
    for (i in 1:length(columns)){
    bronch_metadata[,columns[i]] <- ifelse(bronch_metadata[,columns[i]] %in% c(1, "1"), gsub("\\.", "", as.character(columns[i])), 
                                            ifelse(bronch_metadata[,columns[i]] %in% c(0, "0", "No"), paste0("No", gsub("\\.", "", as.character(columns[i]))), bronch_metadata[,columns[i]]))}
  
  # Convert to numeric and eliminate columns with all 0
  numeric_cols <- bronch_metadata %>% dplyr::select(contains(c("Days.From", "WCC", "Neutrophils", "Lymphocytes", "If.Positive..CMV.BAL.Viral.Load"))) %>% colnames(.)
  bronch_metadata[,c(numeric_cols)] <- sapply(bronch_metadata[,c(numeric_cols)], function(x) as.numeric(as.character(x))) 
  
  empty <- bronch_metadata %>%
    summarise_if(is.numeric, sum) %>%
    select_if(~ !any(is.na(.))) %>% # remove NAs
    select_if(., colSums(.) == 0) %>%
    colnames()
  
  # Remove columns with NAs or non relevant ones
  bronch_metadata <- bronch_metadata[ , !(colnames(bronch_metadata) %in% empty)] %>%
    remove_empty("cols") %>% 
    dplyr::select(!contains(c("List.Anti"))) %>%
    mutate(Days = as.numeric(Days))
  
  colnames(bronch_metadata) <- gsub("\\.", "", colnames(bronch_metadata))
  colnames(bronch_metadata)[1] <- "Record.ID"
  
  ## Merge same columns
  bronch_metadata <- bronch_metadata %>%
    mutate(BactrimDS = case_when(BactrimDS == "BactrimDS" | Resprim == "Resprim" | Trimethoprim == "Trimethoprim" ~ "BactrimDS",
                                 BactrimDS != "BactrimDS" & Resprim != "Resprim" & Trimethoprim != "Trimethoprim" ~ "NoBactrimDS"),
           `Tacrolimus/Cyclosporin` = case_when(Tacrolimus == "Tacrolimus" & Cyclosporin == "Cyclosporin" ~ "Tacrolimus/Cyclosporin",
                                              Tacrolimus != "Tacrolimus" & Cyclosporin == "Cyclosporin" ~ "Tacrolimus/Cyclosporin",
                                              Tacrolimus == "Tacrolimus" & Cyclosporin != "Cyclosporin" ~ "Tacrolimus/Cyclosporin",
                                              Tacrolimus != "Tacrolimus" & Cyclosporin != "Cyclosporin" ~ "NoTacrolimus/Cyclosporin")
        )
  
  metadata[["bronch_metadata"]] <- bronch_metadata

  return(metadata)
}
```


# Microbiology

```{r}
extract_micro <- function(clinical_metadata, metadata) {
  
micro_metadata <- clinical_metadata %>%
  dplyr::select(Record.ID, Days, BronchoalveolarLavageCulture, BALFungalCulture, 
                NotGrowth, StaphylococcusAureusMRSA, PseudomonasSpecies, KlebsiellaPneumoniae, 
                SerratiaMarcescens, StenotrophomonasMaltophilia, EscherichiaColi, EnterobacterAerogenes, Other,
                AspergillusSpecies, ScedosporiumSpecies, PenicilliumSpecies, YeastSpecies,
                IfPositiverecordfindings1) %>%
  mutate(Other = case_when(Other == "1" ~ "Other", 
                            Other == "0" ~ "NoOther")) %>%
  na.omit()
  
# Incorporate fungal findings
micro_metadata$YeastSpecies <- ifelse(micro_metadata$YeastSpecies == "YeastSpecies" | micro_metadata$BALFungalCulture == "1 - Yeast Only", "YeastSpecies", micro_metadata$YeastSpecies)
micro_metadata$AspergillusSpecies <- ifelse(micro_metadata$AspergillusSpecies == "AspergillusSpecies" | str_detect(micro_metadata$IfPositiverecordfindings1, "spergill|sperfill"), "AspergillusSpecies", micro_metadata$AspergillusSpecies)
micro_metadata$Other <- ifelse(micro_metadata$Other == "Other" | micro_metadata$BALFungalCulture == "1 - Other" & !str_detect(micro_metadata$IfPositiverecordfindings1, "spergill|sperfill"), "Other", micro_metadata$Other)

micro_metadata <- micro_metadata %>%
   mutate(BronchoalveolarLavageCulture = case_when(BronchoalveolarLavageCulture == "0" ~ "Negative",
                             BronchoalveolarLavageCulture == "1" ~ "Positive",
                             BronchoalveolarLavageCulture == "Not Done" ~ "Unavailable"),
         BALFungalCulture = gsub("\\ - Other|\\ - Yeast Only", "", BALFungalCulture),
         BALFungalCulture = case_when(BALFungalCulture == "0" ~ "Negative",
                             BALFungalCulture == "1" ~ "Positive",
                             BALFungalCulture == "Not Done" ~ "Unavailable")) %>%
  dplyr::select(!IfPositiverecordfindings1)

micro_metadata$BAL_micro_results <- ifelse(micro_metadata$BronchoalveolarLavageCulture == "Unavailable" & micro_metadata$BALFungalCulture == "Unavailable", "Unavailable",
                                 ifelse(micro_metadata$BronchoalveolarLavageCulture == "Positive" | micro_metadata$BALFungalCulture == "Positive", "Positive",
                                        ifelse(micro_metadata$BronchoalveolarLavageCulture == "Negative" | micro_metadata$BALFungalCulture == "Negative" &
                                               str_detect(micro_metadata$StaphylococcusAureusMRSA, "No") & str_detect(micro_metadata$PseudomonasSpecies, "No") &
                                               str_detect(micro_metadata$KlebsiellaPneumoniae, "No") & str_detect(micro_metadata$SerratiaMarcescens, "No") &
                                               str_detect(micro_metadata$StenotrophomonasMaltophilia, "No") & str_detect(micro_metadata$EscherichiaColi, "No") &
                                               str_detect(micro_metadata$EnterobacterAerogenes, "No") & str_detect(micro_metadata$Other, "No") &  
                                               str_detect(micro_metadata$AspergillusSpecies, "No") & str_detect(micro_metadata$ScedosporiumSpecies, "No") & 
                                               str_detect(micro_metadata$PenicilliumSpecies, "No") & str_detect(micro_metadata$YeastSpecies, "No"), "Negative", "Check")))
micro_metadata <- micro_metadata %>%
  dplyr::select(!c(BronchoalveolarLavageCulture, BALFungalCulture, NotGrowth)) %>%
  relocate(BAL_micro_results, .after = "Days")

for (i in 4:dim(micro_metadata)[2]){
    micro_metadata[,i] <- ifelse(grepl("No", micro_metadata[,i]), 0, 1)}

micro_metadata <- micro_metadata %>%
  rowwise() %>%
  mutate(BAL_micro_results_num = sum(c_across(StaphylococcusAureusMRSA:PenicilliumSpecies)),
         BAL_micro_results = case_when(BAL_micro_results_num == 0 ~ "Negative",
                                       BAL_micro_results_num > 0 ~ "Positive")) %>%
  relocate(BAL_micro_results_num, .after = BAL_micro_results)

metadata[["micro_metadata"]] <- micro_metadata

metadata[["bronch_metadata"]] <- metadata[["bronch_metadata"]] %>%
  dplyr::select(!c(StaphylococcusAureusMRSA, PseudomonasSpecies, KlebsiellaPneumoniae, SerratiaMarcescens, StenotrophomonasMaltophilia, EscherichiaColi, EnterobacterAerogenes, Other, AspergillusSpecies, ScedosporiumSpecies,  PenicilliumSpecies, YeastSpecies))

  return(metadata)
}
```

# Meds at bronch

```{r}
extract_meds <- function(clinical_metadata, metadata, meds_list) {
  
 #clinical_metadata <- master.metadata$bronch_metadata

## antibiotics
antibiotics <- clinical_metadata %>% 
  dplyr::select(Patient_days, meds_list %>% filter(Type == "Antibiotic") %>% pull(Name)) %>%
  na.omit()
rownames(antibiotics) <- antibiotics$Patient_days
for (i in 2:dim(antibiotics)[2]){
    antibiotics[,i] <- ifelse(grepl("No", antibiotics[,i]), 0, 1)}

antibiotics.use <- antibiotics %>%
  rowwise() %>%
  mutate(Total_ant_num = sum(c_across(Amoxycillin:Vancomycin))) %>%
  na.omit() %>%
  mutate(Total_ant_cat = case_when(Total_ant_num >= 3 ~ "3-5",
                           Total_ant_num < 3 ~ "0-2"),
         Total_ant_cat = factor(Total_ant_cat, levels = c("0-2", "3-5"))) %>%
  as.data.frame() %>% 
  distinct() # less because data has not been inputed in Redcap yet

meta <- antibiotics.use[,c("Patient_days", "Total_ant_num", "Total_ant_cat")]


antibiotics.type <- antibiotics %>% 
  dplyr::select(Amoxycillin:Vancomycin) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Name") %>%
  left_join(meds_list, by = "Name") %>%
  relocate(colnames(meds_list)) %>%
  group_by(Group) %>%
  summarise_at(.vars = names(.)[6:dim(.)[2]],
               .funs = c(sum="sum")) %>%
  column_to_rownames("Group") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  mutate(Patient_days = gsub("_sum", "", Patient_days),
         blactamother_cat = ifelse(blactamother == 0, "0", "1-3"),
         blactamother_cat = factor(blactamother_cat, levels = c("0", "1-3")),
         macrolide_cat = ifelse(macrolide == 0, "0", "1"),
         macrolide_cat = factor(macrolide_cat, levels = c("0", "1")),
         sulfbenz_cat = ifelse(`sulfonamide-benzylpyrimidine` == 0, "0", "1"),
         sulfbenz_cat = factor(sulfbenz_cat, levels = c("0", "1"))) 

meta <- meta %>% left_join(antibiotics.type, by = "Patient_days")


## antifungals
antifungals <- clinical_metadata %>% 
  dplyr::select(Patient_days, meds_list %>% filter(Type == "Antifungal") %>% pull(Name)) %>%
  na.omit()
for (i in 2:dim(antifungals)[2]){
    antifungals[,i] <- ifelse(grepl("No", antifungals[,i]), 0, 1)}

antifungals.use <- antifungals %>%
  rowwise() %>%
  mutate(Total_antf_num = sum(c_across(AmphothericinB:Voriconazole))) %>%
  na.omit() %>%
  mutate(Total_antf_cat = case_when(Total_antf_num == 0 ~ "0",
                           Total_antf_num > 0 ~ "1-2"),
         Total_antf_cat = factor(Total_antf_cat, levels = c("0", "1-2"))) %>%
  as.data.frame() %>% 
  distinct() # less because data has not been inputed in Redcap yet

meta <- meta %>% left_join(antifungals.use[,c("Patient_days", "Total_antf_num", "Total_antf_cat")], by = c("Patient_days"))


## immunosuppressants
immunos <- clinical_metadata %>% 
  dplyr::select(Patient_days, meds_list %>% filter(Type == "Immunosuppressant") %>% pull(Name)) %>%
  na.omit()
for (i in 2:dim(immunos)[2]){
    immunos[,i] <- ifelse(grepl("No", immunos[,i]), 0, 1)}

immunos.use <- immunos %>%
  rowwise() %>%
  mutate(Total_imm_num = sum(c_across(Azathioprine:Tacrolimus))) %>%
  na.omit() %>%
  mutate(Total_imm_cat = ifelse(Total_imm_num <= 1, "0-1", "2-3"),
         Total_imm_cat = factor(Total_imm_cat, levels = c("0-1", "2-3"))) %>%
  as.data.frame() %>%
  distinct()

meta <- meta %>% 
  left_join(immunos.use[,c("Patient_days", "Total_imm_num", "Total_imm_cat")], by = c("Patient_days"))

  metadata[["meds_metadata"]] <- meta
  
  return(metadata)

}
```


# Hospitalisations

```{r}
extract_hosp <- function(clinical_metadata, metadata){
  
  hosp_metadata <- droplevels(clinical_metadata[which(clinical_metadata$Repeat.Instrument == 'Hospital Readmission'),]) %>%
  filter(Has.the.Participant.had.a.Hospital.Admission. == 1) %>%
  dplyr::select(Record.ID, 
                "Days" = Time.From.Transplant, 
                "Admission_indication" = Indication.for.Admission, 
                "Admission_reason" = Reason.for.Admission..please.detail)
  
  hosp_metadata$Admission_infection <- ifelse(hosp_metadata$Admission_indication == "Respiratory" & str_detect(hosp_metadata$Admission_reason, c("viral|Viral|nfection|RTI|BAL|neumonia|RSV|CMV|MRSA|neumonitis|ryptococ|gillus|eudomon|cornav|bacter|epsis|Cough|cough|Fungal|hingles|ecretions|Febrile|nfective|Mycetoma|Fevers|ronchitis|COVID|eptic|ntibiotic|nfiltrate")), "Yes", "No")
  
    hosp_metadata$Admission_inflammation <- ifelse(hosp_metadata$Admission_indication == "Respiratory" & str_detect(hosp_metadata$Admission_reason,
c("leural|Effu|ejection|SVT|esaturation|ypoxia|ypozia|yspnea|Dysp|ysfunction|mboli|yspno|emorrhage|leeding|Fevers|hortness|reathlessness|ailure|tricture|ecrosis|leuritis|aemoptysis|naphylaxis|PE|leurisy|leuritic|hernia|Hernia|neumothorax|Sternal|sternal|mphysema|Cough|cough|nfiltrate")), "Yes", "No")
  
  hosp_metadata$Days <- as.numeric(hosp_metadata$Days)
  colnames(hosp_metadata) <- gsub("\\.", "", colnames(hosp_metadata))
  colnames(hosp_metadata)[1] <- "Record.ID"
  
  h <- hosp_metadata %>% 
  filter(Admission_indication == "Respiratory") %>% 
  group_by(Record.ID) %>% 
  arrange(Record.ID, Days) %>%
  mutate(Hosp_admission_cumsum = row_number())
  
  hosp_metadata <- hosp_metadata %>% 
    left_join(h) %>%
    group_by(Record.ID) %>%
    arrange(Record.ID, Days) 
  
  metadata[["hosp_metadata"]] <- hosp_metadata
  return(metadata)
}
```

# Sputum

```{r}
# SPUTUM
extract_sputum <- function(clinical_metadata, metadata){

sputum_metadata <- droplevels(clinical_metadata[which(clinical_metadata$Repeat.Instrument == 'Sputum Specimens'),]) %>%
  dplyr::select(Record.ID, Time.From.Transplant.3:BalSputumOther.) %>% # checked and no need to include detail columns
  dplyr::rename(Days = Time.From.Transplant.3) %>%
  filter(!is.na(Days))
colnames(sputum_metadata) <- gsub("BalSputum", "", colnames(sputum_metadata))
colnames(sputum_metadata) <- gsub("\\.", "", colnames(sputum_metadata))
colnames(sputum_metadata)[1] <- "Record.ID"

  sputum_metadata[] <- data.frame(sapply(sputum_metadata, as.numeric)) 

  sputum_metadata <- sputum_metadata %>%
  select_if(~ !any(is.na(.))) %>% # remove NAs
  select_if(., colSums(.) != 0) # remove empty cols

    for (i in 3:length(colnames(sputum_metadata))){
    sputum_metadata[,colnames(sputum_metadata)[i]] <- ifelse(sputum_metadata[,colnames(sputum_metadata)[i]] %in% c(1, "1"), gsub("\\.", "", as.character(colnames(sputum_metadata)[i])), 
                                            ifelse(sputum_metadata[,colnames(sputum_metadata)[i]] %in% c(0, "0", "No"), "No", sputum_metadata[,colnames(sputum_metadata)[i]]))} 
  
  metadata[["sputum_metadata"]] <- sputum_metadata
  return(metadata)
  
}
```

# Viral PCR

```{r}
extract_viral_pcr <- function(clinical_metadata, metadata){
  
  respcr_metadata <- droplevels(clinical_metadata[which(clinical_metadata$`Repeat.Instrument` == 'Respiratory Viral PCR Tests'),]) %>%
    filter(Has.the.Participant.had.a.Respiratory.PCR.Test.Performed. == 1) %>%
    dplyr::select(Record.ID, "Days" = Time.From.Transplant.4, ResViralPCRNegative.:If.Other..please.comment)# ResViralPCROther.) 
  colnames(respcr_metadata) <- gsub("ResViralPCR", "", colnames(respcr_metadata))
  
  respcr_metadata <- data.frame(sapply(respcr_metadata, as.numeric))
  respcr_metadata <- respcr_metadata %>%
    select_if(~ !any(is.na(.))) %>% # remove NAs
    select_if(., colSums(.) != 0) # remove empty cols

  colnames(respcr_metadata) <- gsub("\\.", "", colnames(respcr_metadata))
  colnames(respcr_metadata)[1] <- "Record.ID"
  
  # add total column
  respcr_metadata <- respcr_metadata %>%
    rowwise() %>%
    mutate(Total_viruses_num = sum(c_across(Picornavirus:Other))) %>%
    dplyr::select(Record.ID, Days, Total_viruses_num)
  
  metadata[["respcr_metadata"]] <- respcr_metadata
  
  return(metadata)
}
```


# Groups spirometry

```{r}
select_groups_spirometry <- function(spirometry_metadata, clad_blad_assessment, patients) {

 #spirometry_metadata <- spirometry.raw
 #clad_blad_assessment <- clad.blad.assessment
 #patients <- clad.blad.assessment$Record.ID
  
spirometry_metadata <- spirometry_metadata %>% right_join(clad_blad_assessment, by = "Record.ID")

# CLAD
spirometry_metadata$max_avg <- NA
spirometry_metadata$mean_days <- NA
spirometry_metadata$max_last_day <- NA
spirometry_metadata$trend <- NA
spirometry_metadata$status <- NA
spirometry_metadata$lost <- NA
spirometry_metadata$score <- NA
spirometry_metadata$sig_decline_day <- NA

# BLAD
spirometry_metadata$blad <- NA
spirometry_metadata$blad_grade <- NA
spirometry_metadata$baseline_day <- NA
spirometry_metadata$normal_day <- NA

pat.trend <- list()

for (i in seq_along(patients)){
  
  sp.sub <- spirometry_metadata %>% 
    filter(Record.ID %in% patients[i]) #i
  
  if (nrow(sp.sub) == 0)
    next
  
  # Calculate the mean of best 2 post-operative values
  if (all(is.na(sp.sub$FEV1_pre_value)))
    next
  
    max_table <- sp.sub %>% arrange(desc(FEV1_pre_value)) %>% head(., 2) # table of top 2 FEV values
    sp.sub$max_avg <- mean(max_table %>% pull(FEV1_pre_value)) 
    mean_days <- max_table %>% pull(Days)
    sp.sub$mean_days <- abs(mean_days[1] - mean_days[2]) # best measurements need to be at least 3 weeks apart
    sp.sub$max_last_day <- max_table %>% arrange(desc(Days)) %>% head(., 1) %>% pull(Days)
  
  for (e in 1:nrow(sp.sub)){
    # Calculate trend at each day/row based on max_avg
    c <- c(mean_days[1], mean_days[2], sp.sub$Days[e]) #e
    trend <- sp.sub %>% filter(Days %in% c) 
    sp.sub$trend[e] <- coef(lm(FEV1_pre_value ~ Days, data = trend))[2]
    
    # Positive lm coefficient if FEV1 increasing over time and vice versa
    if (sp.sub$trend[e] > 0){
      sp.sub$status[e] <- "Positive"}
    if (sp.sub$trend[e] < 0){
      sp.sub$status[e] <- "Negative"} 
    if (sp.sub$trend[e] == 0){
      sp.sub$status[e] <- "Positive"}
    
    # Assign CLAD score at that timepoint 
    sp.sub$lost[e] <- 100 * (sp.sub$max_avg[e] - sp.sub$FEV1_pre_value[e]) / abs(sp.sub$FEV1_pre_value[e])
        
    # Assign clad scores and adjust percentage lost column
    # A positive value corresponds to a decrease from the max_avg. 
    # A negative value corresponds to an increase from the max_avg.
    if (isTRUE(sp.sub$status[e] == "Positive")){
      sp.sub$score[e] <- 0
      sp.sub$lost[e] <- -1 * sp.sub$lost[e]}
    if (isTRUE(sp.sub$status[e] == "Negative")){
        if (sp.sub$lost[e] <= 20){
        sp.sub$score[e] <- 0}
        if (sp.sub$lost[e] > 20 & sp.sub$lost[e] <= 35){
        sp.sub$score[e] <- 1}
        if (sp.sub$lost[e] > 35 & sp.sub$lost[e] <= 50){
        sp.sub$score[e] <- 2}
        if (sp.sub$lost[e] > 50 & sp.sub$lost[e] <= 65){
        sp.sub$score[e] <- 3}
        if (sp.sub$lost[e] > 65){
        sp.sub$score[e] <- 4}}}
      
      # Assign sig decline day
      if (isTRUE(any(sp.sub$clad_clinical == "FALSE"))){
        sp.sub$sig_decline_day <- NA}
      if (isTRUE(any(sp.sub$clad_clinical == "TRUE"))){
        if (all(sp.sub$score == 0)){
          sp.sub$sig_decline_day <- NA}
        else sp.sub$sig_decline_day <- sp.sub %>% filter(score != 0) %>% slice_min(Days) %>% pull(Days) %>% unique()}
      
    # Define BLAD
      ## No BLAD
      if (isTRUE(any(sp.sub$FEV1_pre_percentage >= 80))){
      sp.sub$blad <- FALSE
      sp.sub$baseline_day <- max_table %>% pull(Days) %>% min() # earliest of top 2 baseline measurements
      sp.sub$blad_grade <- 0
      sp.sub$normal_day <- sp.sub %>% filter(FEV1_pre_percentage > 80 #& FVC_percentage > 80
                                             ) %>% pull(Days) %>% min()} # earliest of both measurements above 80%
      
      ## BLAD for those that never reach above 80%
      if (isTRUE(all(sp.sub$FEV1_pre_percentage < 80))){
      sp.sub$blad <- TRUE
      sp.sub$baseline_day <- max_table %>% pull(Days) %>% min() # earliest of top 2 baseline measurements
      sp.sub$normal_day <- NA
        
        # Define grades of BLAD = FEV % at baseline day
        fev_baseline <- max_table %>% filter(Days == sp.sub$baseline_day[1]) %>% pull(FEV1_pre_percentage) # FEV1 % at baseline day
        if (fev_baseline >= 65){
        sp.sub$blad_grade <- 1}
        if (fev_baseline > 50 & fev_baseline < 65){
        sp.sub$blad_grade <- 2}
        if (fev_baseline <= 50){
        sp.sub$blad_grade <- 3}}
      
  # Once this is done for one patient, save output to list
  pat.trend[[i]] <- sp.sub #i
}

spirometry_metadata <- dplyr::bind_rows(pat.trend)

return(spirometry_metadata)
}
```

# Fev at bronch

```{r}
fev_at_bronch <- function(select_metadata, spirometry_metadata, patients, buffer = 7) {

  #select_metadata <- transcriptomics_sample_list
  #spirometry_metadata <- spirometry_metadata
  #buffer <- 7
  #patients <- unique(transcriptomics_sample_list$Record.ID)
  
# Remove lobe if needed
select_metadata$Patient_days <- gsub("_Left|_Right", "", select_metadata$Patient_days)

# Initialise tables
samples <- select_metadata %>% dplyr::select(Record.ID, Days, Patient_days) %>% distinct()
select_metadata <- samples

new.spir <- list()
  
# Assign patient_days to FEV values in spirometry.metadata
for (i in seq_along(patients)){
  
  new.spir.pat <- list()
  sp.sub <- spirometry_metadata %>% filter(Record.ID %in% patients[i]) #i
  meta.spir.sub <- samples %>% filter(Record.ID %in% patients[i]) #i
  
  # Next iteration if that patient was not found
  if (nrow(meta.spir.sub) == 0)
        next
  
  # For every row in meta.spir.sub
  for (e in 1:nrow(meta.spir.sub)){

    # Subset sp.sub with the closest day to meta.spir.sub day, need strict buffer or duplicates will come up
      b.spir <- sp.sub %>% filter(Days <= meta.spir.sub$Days[e] + buffer & Days >= meta.spir.sub$Days[e] - buffer) #ee
      
      # Next iteration if not found
      if (nrow(b.spir) == 0)
        next #or {
        #new.spir.int <- meta.spir.sub[e,] %>% inner_join(b.spir, by = c("Record.ID")) # e
        # Assign it as a new row to the new spirometry table for that patient
        #new.spir.pat[[e]] <- new.spir.int}
    
      # If one match is found, save that row
      if (nrow(b.spir) == 1){
        new.spir.int <- meta.spir.sub[e,] %>% inner_join(b.spir, by = c("Record.ID")) # e
        # Assign it as a new row to the new spirometry table for that patient
        new.spir.pat[[e]] <- new.spir.int} #e
      
      # If more than one value is found take the one closest to the corresponding day in bact.spir.sub
      if (nrow(b.spir) > 1){
        vec <- abs(b.spir$Days - meta.spir.sub$Days[e]) #e
        # Filter table depending on index of the closest value to the corresponding day and if two values are found filter for the first one
        int <- b.spir[which(vec == min(vec)),] %>% head(., 1)
        new.spir.int <- meta.spir.sub[e,] %>% inner_join(int, by = "Record.ID") #e
        # Assign it as a new row to the new spirometry table
        new.spir.pat[[e]] <- new.spir.int}#e
      } 
        
  # Once this is done for one patient, save output to new spir list
  new.spir.pat <- dplyr::bind_rows(new.spir.pat)
  new.spir[[i]] <- new.spir.pat #i
}

# Bind all rows into a final dataframe
new.spir <- dplyr::bind_rows(new.spir)

# Add extra condition here if no duplicates are found or all rows will be removed
if (isTRUE(duplicated(new.spir$Patient_days))){
  new.spir <- new.spir[-c(which(duplicated(new.spir$Patient_days))),]
}

# Determine which bronchoscopies were taken before or after CLAD onset or/decline in lung function
new.spir$sig_decline_status <- NA 
new.spir$clad_status <- NA 
new.spir$days_to_sig_decline <- NA
new.spir$days_to_clad <- NA

n.spir.clad <- list()

for (i in unique(new.spir$Record.ID)){ 
  # Subset n.spir for each patient
  sub.trend.pat <- new.spir %>% filter(Record.ID == i) #i
  
    # For every row, determine whether the FEV value was recorded before or after sig decline or CLAD onset
    for (e in 1:dim(sub.trend.pat)[1]){
      if (isTRUE(all(sub.trend.pat$clad_clinical == "FALSE"))){
        sub.trend.pat$sig_decline_status[e] <- "Before"
        sub.trend.pat$clad_status[e] <- "Before"} #e
     
       if (isTRUE(all(sub.trend.pat$clad_clinical == "TRUE"))){
        if (isTRUE(sub.trend.pat$Days.x[e] < unique(sub.trend.pat$sig_decline_day))){ #e 
          sub.trend.pat$sig_decline_status[e] <- "Before"} # e
        if (isTRUE(sub.trend.pat$Days.x[e] < unique(sub.trend.pat$clad_day_clinical))){ #e 
          sub.trend.pat$clad_status[e] <- "Before"} # e
         
        if (isTRUE(sub.trend.pat$Days.x[e] >= unique(sub.trend.pat$sig_decline_day))){ #e 
          sub.trend.pat$sig_decline_status[e] <- "After"} # e
        if (isTRUE(sub.trend.pat$Days.x[e] >= unique(sub.trend.pat$clad_day_clinical))){ #e 
          sub.trend.pat$clad_status[e] <- "After"} # e
         }} 
      
      # When done for one patient, save output to a list
      n.spir.clad[[i]] <- sub.trend.pat 
      }

# Bind all rows into a final dataframe
new.spir <- dplyr::bind_rows(n.spir.clad)

# Fill in information for those values for which no spirometry was recorded
new.spir <- new.spir %>% right_join(select_metadata[, c("Patient_days", "Record.ID", "Days")], by = c("Patient_days", "Record.ID"))
new.spir$Days.x <- NULL

# Add missing information on clad sample status
n.spir2 <- list()
for (i in unique(new.spir$Record.ID)){
  
  n.spir.int <- new.spir %>% filter(Record.ID == i) #i
  
  # Add group info if na
  n.spir.int$clad_clinical <- ifelse(spirometry_metadata %>% filter(Record.ID == i) %>% pull(clad_clinical) %>% unique() == "FALSE", "FALSE", "TRUE")
  
  # Next iteration if that patient was not found
  if (nrow(n.spir.int) == 0)
        next
  
  for (e in 1:nrow(n.spir.int)){ #e
    
    if (isTRUE(any(n.spir.int$clad_clinical == "FALSE"))){
      if (is.na(n.spir.int$sig_decline_status[e]) | is.na(n.spir.int$clad_status[e])){ #e
        n.spir.int$sig_decline_status[e] <- "Before" #e
        n.spir.int$clad_status[e] <- "Before"
        n.spir.int$score[e] <- 0}} #e
    
    if (isTRUE(any(n.spir.int$clad_clinical == "TRUE"))){
      if (is.na(n.spir.int$sig_decline_status[e]) | is.na(n.spir.int$clad_status[e])){
    
      if (isTRUE(n.spir.int$Days[e] < max(na.omit(unique(n.spir.int$sig_decline_day))))){ #e
          n.spir.int$sig_decline_status[e] <- "Before"} #e
      if (isTRUE(n.spir.int$Days[e] < max(na.omit(unique(n.spir.int$clad_day_clinical))))){ #e
          n.spir.int$clad_status[e] <- "Before"} #e
        
        if (isTRUE(n.spir.int$Days[e] >= max(na.omit(unique(n.spir.int$sig_decline_day))))){ #e
          n.spir.int$sig_decline_status[e] <- "After"} #e
        if (isTRUE(n.spir.int$Days[e] >= max(na.omit(unique(n.spir.int$clad_day_clinical))))){ #e
          n.spir.int$clad_status[e] <- "After"} #e
        }}
    
    # Fill remaining NA values
    #n.spir.int$lost_avg <- unique(n.spir.int$lost_avg)[1]
    #n.spir.int$lm_time <- unique(n.spir.int$lm_time)[1]
    n.spir.int$max_avg <- unique(n.spir.int$max_avg)[1]
    n.spir.int$sig_decline_day <- unique(n.spir.int$sig_decline_day)[1]
    n.spir.int$clad_day_clinical <- unique(n.spir.int$clad_day_clinical)[1]
    n.spir.int$max_last_day <- unique(n.spir.int$max_last_day)[1]
    #n.spir.int$final_score <- unique(n.spir.int$final_score)[1]
    } #e
  
  # Days to decline or clad
  n.spir.int$days_to_sig_decline <- n.spir.int$sig_decline_day - n.spir.int$Days
  n.spir.int$days_to_clad <- n.spir.int$clad_day_clinical - n.spir.int$Days
    
  # When done for one patient, save output to a list
    n.spir2[[i]] <- n.spir.int
}

# Bind all rows into a final dataframe
new.spir <- dplyr::bind_rows(n.spir2)

# Final
spir.metadata <- new.spir %>% 
  mutate(Group = case_when(clad_clinical == "TRUE" ~ "CLAD",
                           clad_clinical == "FALSE" ~ "CLAD-free")) %>%
  dplyr::select(Patient_days, Record.ID, Days, Weight, FEV1_pre_value, FEV1_pre_percentage, lost, score, 
                                            sig_decline_day, sig_decline_status, days_to_sig_decline, 
                                            clad_day_clinical, clad_status, days_to_clad, max_last_day,
                                            Group, clad_clinical) %>%
  distinct() #remove lobe duplicates

# Interpolate missing FEV values and percentages using the original spirometry metadata table
n.spir3 <- list()
for (i in unique(spir.metadata$Record.ID)){
  
  # Filter original table per patient
  sp.full <- spirometry_metadata %>% filter(Record.ID == i) %>% arrange(Days) # i
  # Initialise new column
  spir.metadata$FEV1_pre_value_int <- NA 
  spir.metadata$FEV1_pre_percentage_int <- NA
  
  # Filter and extract row ids to interpolate 
  spir.metadata.int <- spir.metadata %>% filter(Record.ID == i) %>% arrange(Days) #i
  # Location of NA values in table
  row.id <- which(is.na(spir.metadata.int$FEV1_pre_percentage))
  
  # Select day row by row
  for (e in row.id){
    sel.day <- spir.metadata.int[e, ] %>% pull(Days) # e
    spir.metadata.int$FEV1_pre_value_int[e] <- round(approx(sp.full$Days, sp.full$FEV1_pre_value, xout = sel.day, ties = "ordered")$y, 2) # e
    spir.metadata.int$FEV1_pre_percentage_int[e] <- round(approx(sp.full$Days, sp.full$FEV1_pre_percentage, xout = sel.day, ties = "ordered")$y, 2) # e
  }
  
  # Combined FEV
  spir.metadata.int <- tidyr::unite(spir.metadata.int, col = "FEV1_pre_value_comb", FEV1_pre_value, FEV1_pre_value_int, na.rm=TRUE, sep = "", remove = FALSE) %>%
    mutate(FEV1_pre_value_comb = as.numeric(FEV1_pre_value_comb))
  spir.metadata.int <- tidyr::unite(spir.metadata.int, col = "FEV1_pre_percentage_comb", FEV1_pre_percentage, FEV1_pre_percentage_int, na.rm=TRUE, sep = "", remove = FALSE) %>%
    mutate(FEV1_pre_percentage_comb = as.numeric(FEV1_pre_percentage_comb))
  
# When done for one patient, save output to a list
    n.spir3[[i]] <- spir.metadata.int
}

# Bind all rows into a final dataframe
spir.metadata <- dplyr::bind_rows(n.spir3) %>% relocate(FEV1_pre_value_int, FEV1_pre_percentage_int, .after = Patient_days)

# Interpolate weight
n.spir4 <- list()
for (i in unique(spir.metadata$Record.ID)){
  
  # Filter original table per patient
  sp.full <- spirometry_metadata %>% filter(Record.ID == i) %>% arrange(Days) # i
  # Initialise new column
  spir.metadata$Weight_int <- NA
  
  # Filter and extract row ids to interpolate 
  spir.metadata.int <- spir.metadata %>% filter(Record.ID == i) %>% arrange(Days) #i
  # Location of NA values in table
  row.id <- which(is.na(spir.metadata.int$Weight))
  
  # Select day row by row
  for (e in row.id){
    sel.day <- spir.metadata.int[e, ] %>% pull(Days) # e
    spir.metadata.int$Weight_int[e] <- round(approx(sp.full$Days, sp.full$Weight, xout = sel.day, ties = "ordered")$y) # e
  }

  # Combined Weight
  spir.metadata.int <- tidyr::unite(spir.metadata.int, col = "Weight_comb", Weight, Weight_int, na.rm=TRUE, sep = "", remove = TRUE) %>%
    mutate(Weight_comb = as.numeric(Weight_comb))
  
    # Add missing starting and ending weight (interpolate as same as first measurement)
  if (is.na(spir.metadata.int$Weight_comb[1])) {
    spir.metadata.int$Weight_comb[1] <- spir.metadata.int$Weight_comb[2]
  }
  if (is.na(spir.metadata.int$Weight_comb[1]) & is.na(spir.metadata.int$Weight_comb[2]) & nrow(spir.metadata.int) > 1) {
    spir.metadata.int$Weight_comb[1] <- spir.metadata.int$Weight_comb[3]
    spir.metadata.int$Weight_comb[2] <- spir.metadata.int$Weight_comb[3]
  }
  if (is.na(spir.metadata.int$Weight_comb[length(spir.metadata.int$Weight_comb)]) & nrow(spir.metadata.int) > 1 ) {
    spir.metadata.int$Weight_comb[length(spir.metadata.int$Weight_comb)] <- spir.metadata.int$Weight_comb[length(spir.metadata.int$Weight_comb)-1]
  }
  
# When done for one patient, save output to a list
    n.spir4[[i]] <- spir.metadata.int
}

# Bind all rows into a final dataframe
spir.metadata <- dplyr::bind_rows(n.spir4) %>% dplyr::select(-Record.ID, -Days)

return(spir.metadata)
}
```

# Match at bronch hosp and respcr

```{r}
match_at_bronch <- function(bronch_metadata, select_metadata, patients, buffer = 7) {

  #patients <- unique(bact.metadata$Record.ID)
  #select_metadata <- master.metadata$respcr_metadata
  #bronch_metadata <- bact.metadata
  #buffer <- 7
  
# Remove lobe if needed
  bronch_metadata$Patient_days <- gsub("_Left|_Right", "", bronch_metadata$Patient_days)

# Initialise tables
  samples <- bronch_metadata %>% dplyr::select(Record.ID, "Days_bronch" = Days, Patient_days)
  matched_metadata <- list()
  
# Assign patient_days to hosp values in hosp metadata
for (i in seq_along(patients)){
  
  matched_metadata_pat <- list()
  metadata_pat <- select_metadata %>% filter(Record.ID %in% patients[i]) #i
  bronch_pat <- samples %>% filter(Record.ID %in% patients[i]) #i
  
  # Next iteration if that patient was not found
  if (nrow(bronch_pat) == 0)
        next
  
  # For every row in bronch_pat
  for (e in 1:nrow(bronch_pat)){

    # Subset sp.sub with the closest day to meta.spir.sub day, need strict buffer or duplicates will come up
      metadata_pat_closest_days <- metadata_pat %>% filter(Days <= bronch_pat$Days_bronch[e] + buffer & Days >= bronch_pat$Days_bronch[e] - buffer) #ee
      
      # Next iteration if not found
      if (nrow(metadata_pat_closest_days) == 0)
        next 
    
      # If one match is found, save that row
      if (nrow(metadata_pat_closest_days) == 1){
        matched_metadata_pat_closest_days <- bronch_pat[e,] %>% inner_join(metadata_pat_closest_days, by = c("Record.ID")) # e
        # Assign it as a new row to the new spirometry table for that patient
        matched_metadata_pat[[e]] <- matched_metadata_pat_closest_days} #e
      
      # If more than one value is found take the one closest to the corresponding day in bact.spir.sub
      if (nrow(metadata_pat_closest_days) > 1){
        abs_day_difference <- abs(metadata_pat_closest_days$Days - bronch_pat$Days_bronch[e]) #e
        # Filter table depending on index of the closest value to the corresponding day and if two values are found filter for the first one
        closest_day_index <- metadata_pat_closest_days[which(abs_day_difference == min(abs_day_difference)),] %>% head(., 1)
        matched_metadata_pat_closest_days <- bronch_pat[e,] %>% inner_join(closest_day_index, by = "Record.ID") #e
        # Assign it as a new row to the new spirometry table
        matched_metadata_pat[[e]] <- matched_metadata_pat_closest_days}#e
      } 
        
  # Once this is done for one patient, save output to new spir list
  matched_metadata_pat_df <- dplyr::bind_rows(matched_metadata_pat)
  matched_metadata[[i]] <- matched_metadata_pat_df #i
}

# Bind all rows into a final dataframe
matched_metadata_df <- dplyr::bind_rows(matched_metadata)

# Add extra condition here if no duplicates are found or all rows will be removed
if (isTRUE(duplicated(matched_metadata_df$Patient_days))){
  matched_metadata_df <- matched_metadata_df[-c(which(duplicated(matched_metadata_df$Patient_days))),] }

# Final
matched_metadata_df <- matched_metadata_df %>% # remove days_metadata
  dplyr::select(contains("Patient_days"), !contains(c("Days_bronch", "Days", "Record.ID"))) %>%
  distinct() #remove lobe duplicates

return(matched_metadata_df)
}


```


# Classify infection

Antibiotics usage in infection classification

```{r}
classify_infection <- function(metadata) {
  
  #metadata <- bact.metadata
  
 metadata <- metadata %>%
    #dplyr::select(Reason_inf, SecretionsPresent, BAL_micro_results, CMVinBAL, Total_viruses_num, Total_ant_num, Admission_infection, Admission_reason, Diversity) %>%
    mutate(Class_infection = case_when(SecretionsPresent %in% c("None", "Mild", "Not Documented") &
                                      Admission_infection %in% c("No", NA) &
                                      (BAL_micro_results %in% c("Negative", "Positive", "Unavailable") |
                                      CMVinBAL %in% c("NoCMVinBAL", "Not done") |
                                      Total_viruses_num %in% c(0, NA)
                                      )  ~ "Routine",
                                      
                                      SecretionsPresent %in% c("Moderate", "Severe") &
                                      Admission_infection %in% c("No", NA, "Yes") &
                                      (BAL_micro_results %in% c("Positive") |
                                      CMVinBAL == "CMVinBAL" |
                                      Total_viruses_num > 0
                                      )
                                      ~ "Infection"#,
                                       
                                      #SecretionsPresent %in% c("Moderate", "Severe") &
                                      #Admission_infection %in% c("Yes") &
                                      #(BAL_micro_results == "Positive" |
                                      #CMVinBAL == "CMVinBAL" |
                                      #Total_viruses_num > 0
                                      #)
                                      #~ "Infection",
                                      
                                      #Admission_infection %in% c("Yes")
                                      #~ "Infection"
                                      ),
           
           Class_infection = ifelse(is.na(Class_infection), "Routine", Class_infection),
           Class_infection = factor(Class_infection, levels = c("Routine", "Infection"))) 
}

# Better spread if including viruses, seems there could be a correlation
```

# Classify inflammation

```{r}
classify_inflammation <- function(metadata) {
  
# metadata <- bact.metadata
  
metadata <- metadata %>%

   mutate(BAL_inflammation = ifelse(ReasonforBronchoscopy %in% c("Anastomotic stricture") | 
                                       str_detect(Otherreason, c("ffusion|nodules|nfiltrate|njury|SOB|lesion|ough|rejection|ranulomatous")), "Yes", "No"),
          BAL_inflammation = ifelse(is.na(BAL_inflammation), "No", BAL_inflammation),
          
          Class_inflammation = case_when(Admission_inflammation == "No" & BAL_inflammation == "No" ~ "Routine",
                                         is.na(Admission_inflammation) & BAL_inflammation == "No" ~ "Routine",
                                        Admission_inflammation == "Yes" | BAL_inflammation == "Yes" ~ "Inflammation"),
          Class_inflammation = factor(Class_inflammation, levels = c("Routine", "Inflammation"))) %>%
    relocate(Class_inflammation, .after = Days) 
}

#  see(metadata, c("Patient_days", "Class_inflammation", "ReasonforBronchoscopy", "Otherreason", "BAL_inflammation", "Admission_inflammation"))
```

# Classify BAL

```{r}
classify_bal <- function(metadata) {
  
#metadata <- bact.metadata
  
metadata <- metadata %>%

   mutate(BAL_class_combined = case_when(Class_infection %in% c("Infection") | Class_inflammation == "Inflammation" ~ "Clinical",
                                Class_infection == "Routine" & Class_inflammation == "Routine" ~ "Routine"),
          BAL_class_combined = factor(BAL_class_combined, levels = c("Routine", "Clinical")),
          
          BAL_class_separate = case_when(Class_infection %in% c("Infection") & Class_inflammation == "Inflammation" ~ "Infection+Inflammation",
                                 Class_infection %in% c("Infection") & Class_inflammation == "Routine" ~ "Infection",
                                 Class_infection %in% c("Routine") & Class_inflammation == "Inflammation" ~ "Inflammation",
                                 Class_infection == "Routine" & Class_inflammation == "Routine" ~ "Routine"),
          BAL_class_separate = factor(BAL_class_separate, levels = c("Routine", "Inflammation", "Infection", "Infection+Inflammation")))
}
```

# Cumulative BAL class

```{r}
bal_class_cumulative <- function(metadata) {
  
  hosp_exp <- metadata$hosp_metadata %>% 
    filter(Admission_indication == "Respiratory") %>%
    full_join(metadata$bronch_metadata[, c("Record.ID", "Days")]) %>% 
    group_by(Record.ID) %>% 
    arrange(Record.ID, Days) %>%
    mutate(Hosp_admission_cumsum = ifelse(is.na(Hosp_admission_cumsum) & Days == min(Days), 0, Hosp_admission_cumsum)) %>%
    fill(Hosp_admission_cumsum, .direction = "downup") %>%
    mutate(Hosp_admission_cumsum = ifelse(is.na(Hosp_admission_cumsum), 0, Hosp_admission_cumsum)) %>% 
    ungroup() 
  
  h <- match_at_bronch(bronch_metadata = metadata$bronch_metadata, 
                         select_metadata = hosp_exp, 
                         patients = unique(metadata$bronch_metadata$Record.ID))
  v <- match_at_bronch(bronch_metadata = metadata$bronch_metadata, 
                         select_metadata = metadata$respcr_metadata, 
                         patients = unique(metadata$bronch_metadata$Record.ID))
  infection <- metadata$bronch_metadata %>%
    left_join(h) %>%
    left_join(v) %>%
    left_join(metadata$micro_metadata, by = c("Record.ID", "Days")) 
  infection <- classify_infection(infection)
  infection <- classify_inflammation(infection)
  infection <- classify_bal(infection)
  
  d <- infection %>% 
    filter(BAL_class_combined == "Clinical") %>% 
    group_by(Record.ID) %>% 
    arrange(Record.ID, Days) %>%
    mutate(BAL_class_combined_cumsum = row_number()) %>%
    dplyr::select(Patient_days, BAL_class_combined_cumsum)
  
  infection_df <- infection %>% 
    left_join(d) %>%
    #dplyr::select(Record.ID, Days, BAL_class_combined, BAL_class_combined_cumsum, Hosp_admission_cumsum, Admission_indication) %>%
    group_by(Record.ID) %>%
    arrange(Record.ID, Days) %>%
    mutate(BAL_class_combined_cumsum = ifelse(is.na(BAL_class_combined_cumsum) & Days == min(Days), 0, BAL_class_combined_cumsum)) %>%
    fill(BAL_class_combined_cumsum, .direction = "downup") %>%
    mutate(BAL_class_combined_cumsum = ifelse(is.na(BAL_class_combined_cumsum), 0, BAL_class_combined_cumsum)) 
    
  metadata[["bal_class_hosp"]] <- infection_df
  
  return(metadata)
    
}

# view(metadata[, c("Record.ID", "Days", "BAL_class_combined", "BAL_class_combined_cumsum")])
```


# Classify dosage

Aza there are 25 and 50 mg tablets that are not split typically patients are within range 25-100mg

Pred - 5mg tablets (which can be split). Patients are down to 20 mg tablet by 2 weeks post-to, and the dose is slowly weaned over the next 12 months in 2.5mg increments

MMF 250 and 500mg tablets not split. Most patients are between total dose of 500 and 2000mg/day

```{r}
classify_dosage <- function(metadata) {
  
  metadata <- metadata %>%
    
  mutate(Tacrolimus_dosage = case_when(Days <= 183 & Tacrolimus == "Tacrolimus" ~ "10-12",
                                         Days > 183 & Days <= 365 & Tacrolimus == "Tacrolimus"  ~ "8-10",
                                         Days > 365 & Tacrolimus == "Tacrolimus" ~ "5-8",
                                         Tacrolimus == "NoTacrolimus" ~ "0"),
         Tacrolimus_dosage = factor(Tacrolimus_dosage, levels = c("0", "5-8", "8-10", "10-12")),
         
         Cyclosporin_dosage = case_when(Days <= 183 & Cyclosporin == "Cyclosporin" ~ "250-300",
                                         Days > 183 & Days <= 365 & Cyclosporin == "Cyclosporin" ~ "200-250",
                                         Days > 365 & Cyclosporin == "Cyclosporin" ~ "100-200",
                                         Cyclosporin == "NoCyclosporin" ~ "0"),
         Cyclosporin_dosage = factor(Cyclosporin_dosage, levels = c("0", "100-200", "200-250", "250-300")),
         
         Prednisolone_dosage = case_when(Days <= 92 & Prednisolone == "Prednisolone" ~ 0.25 * Weight_comb,
                               Days > 92 & Days <= 183 & Prednisolone == "Prednisolone" ~ 0.2 * Weight_comb,
                               Days > 183 & Days <= 365 & Prednisolone == "Prednisolone" ~ 0.15 * Weight_comb,
                               Days > 365 & Prednisolone == "Prednisolone" ~ 7.5,
                               Prednisolone == "NoPrednisolone" ~ 0),
        
         Prednisolone_dosage_cat = case_when(Prednisolone_dosage <= 7.5 ~ "<7.5",
                                             Prednisolone_dosage > 7.5 & Prednisolone_dosage < 12.5 ~ "7.5-12.5",
                                             Prednisolone_dosage >= 12.5 & Prednisolone_dosage < 19 ~ "20-30"),
         Prednisolone_dosage_cat = factor(Prednisolone_dosage_cat, c("<7.5", "7.5-20", "20-30")),
         
         # These do not change over time
         Azathioprine_dosage = case_when(Azathioprine == "Azathioprine" ~ 1.5 * Weight_comb,
                                         Azathioprine == "NoAzathioprine" ~ 0),
         #Azathioprine_dosage_cat = round.choose(Azathioprine_dosage,25,0),
         
         Mycophenolate_dosage = case_when(`Mycophenolate-Mofetil` == "Mycophenolate-Mofetil" & Weight_comb >= 50 ~ 1000 * 2,
                                          `Mycophenolate-Mofetil` == "Mycophenolate-Mofetil" & Weight_comb < 50 ~ 15 * Weight_comb * 2,
                                          `Mycophenolate-Mofetil` == "NoMycophenolate-Mofetil" ~ 0))
}

#deseq_list$`days+isc+fev+tx`$metadata %>% 
#mutate(Azathioprine_dosage_cat = case_when(Azathioprine_dosage != 0 ~ round.choose(Azathioprine_dosage,25),
#                                           Azathioprine_dosage == 0 ~ Azathioprine_dosage)) %>%
#  dplyr::select(Azathioprine_dosage_cat, Azathioprine_dosage)
```

```{r}
round.choose <- function(x, roundTo) {
  if(isTRUE(x/roundTo <= round(x/roundTo))) {  ##ROUND UP x - roundTo >= 0.5
    x + (roundTo - x %% roundTo)
  } else {
    if(isFALSE(x/roundTo <= round(x/roundTo))) {  ##ROUND DOWN
      x - (x %% roundTo)
    }
  }
}

#   25/25 <= round(25/25) # round up
```


# Annotate CLAD

```{r}
annotate_clad <- function(metadata) {
  
  metadata <- metadata %>%
    mutate(Days_clad_onset = case_when(is.na(clad_day_clinical) ~ "None", 
                                     clad_day_clinical <= 560 ~ "0-560", 
                                     clad_day_clinical > 560 & clad_day_clinical <= 730 ~ "561-730",
                                     clad_day_clinical > 730 & clad_day_clinical <= 1127 ~ "731-1127"),
         Days_clad_onset = factor(Days_clad_onset, levels = c("None", "0-560", "561-730", "731-1127")),
         Days_to_clad = case_when(is.na(days_to_clad) ~ " ",
                                  days_to_clad <= 365 ~ "<365", 
                                  days_to_clad > 365 ~ ">365"),
         Days_to_clad = factor(Days_to_clad, levels = c(" ", ">365", "<365")),
         Group = factor(Group, levels = c("CLAD-free", "CLAD")),
         clad_status = factor(clad_status, levels = c("Before", "After"))) %>%
    dplyr::rename(Status = clad_status) 
  
  return(metadata)

}
```

# Match immunosuppressants

```{r}
match_immunosuppressants <- function(bronch_metadata, select_metadata, patients, buffer = 7) {

  #patients <- unique(bact.metadata$Record.ID)
  #select_metadata <- master.metadata$respcr_metadata
  #bronch_metadata <- bact.metadata
  #buffer <- 7
  
  # Remove lobe if needed
  bronch_metadata$Patient_days <- gsub("_Left|_Right", "", bronch_metadata$Patient_days)

  # Initialise tables
  samples <- bronch_metadata %>% dplyr::select(Record.ID, "Days_bronch" = Days, Patient_days)
  matched_metadata <- list()
  
  # Assign patient_days to hosp values in hosp metadata
  for (i in seq_along(patients)){
    
    matched_metadata_pat <- list()
    metadata_pat <- select_metadata %>% filter(Record.ID %in% patients[i]) #i
    bronch_pat <- samples %>% filter(Record.ID %in% patients[i]) #i
    
    # Next iteration if that patient was not found
    if (nrow(bronch_pat) == 0)
          next
    
    # For every row in bronch_pat
    for (e in 1:nrow(bronch_pat)){
  
      # Subset sp.sub with the closest day to meta.spir.sub day, need strict buffer or duplicates will come up
        metadata_pat_closest_days <- metadata_pat %>% filter(Days <= bronch_pat$Days_bronch[e] + buffer & Days >= bronch_pat$Days_bronch[e] - buffer) #ee
        
        # Next iteration if not found
        if (nrow(metadata_pat_closest_days) == 0)
          next 
      
        # If one match is found, save that row
        if (nrow(metadata_pat_closest_days) == 1){
          matched_metadata_pat_closest_days <- bronch_pat[e,] %>% 
            inner_join(metadata_pat_closest_days, by = c("Record.ID")) # e
          # Assign it as a new row to the new spirometry table for that patient
          matched_metadata_pat[[e]] <- matched_metadata_pat_closest_days} #e
        
        # If more than one value is found take the one closest to the corresponding day in bact.spir.sub
        if (nrow(metadata_pat_closest_days) > 1){
          abs_day_difference <- abs(metadata_pat_closest_days$Days - bronch_pat$Days_bronch[e]) #e
          # Filter table depending on index of the closest value to the corresponding day and if two values are found filter for the first one
          closest_day_index <- metadata_pat_closest_days[which(abs_day_difference == min(abs_day_difference)),] %>%
            head(., 1)
          matched_metadata_pat_closest_days <- bronch_pat[e,] %>% inner_join(closest_day_index, by = "Record.ID") #e
          # Assign it as a new row to the new spirometry table
          matched_metadata_pat[[e]] <- matched_metadata_pat_closest_days}#e
        } 
          
    # Once this is done for one patient, save output to new spir list
    matched_metadata_pat_df <- dplyr::bind_rows(matched_metadata_pat)
    matched_metadata[[i]] <- matched_metadata_pat_df #i
  }
  
  # Bind all rows into a final dataframe
  matched_metadata_df <- dplyr::bind_rows(matched_metadata)
  
  # Add extra condition here if no duplicates are found or all rows will be removed
  if (isTRUE(duplicated(matched_metadata_df$Patient_days))){
    matched_metadata_df <- matched_metadata_df[-c(which(duplicated(matched_metadata_df$Patient_days))),] }
  
  # Final
  matched_metadata_df <- matched_metadata_df %>% # remove days_metadata
    dplyr::select(contains("Patient_days"), !contains(c("Days_bronch", "Days", "Record.ID"))) %>%
    distinct() #remove lobe duplicates
  
  return(matched_metadata_df)
}
```



