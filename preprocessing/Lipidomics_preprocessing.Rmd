---
title: "Lipidomics_preprocessing"
author: "Giulia"
date: "18/03/2022"
output: html_document
---

# Preprocessing
## Injection order

```{r}
lip_inj_order <- read.csv("Lipidomics/Data/combined/injection-order-combined.csv")

lip_inj_order <- lip_inj_order %>%
  mutate(order = seq(1:dim(.)[1])) %>%
  filter(!grepl("MSMS", SampleID))
rownames(lip_inj_order) <- lip_inj_order$SampleID
```

## Import tables

```{r}
# Combined
lip.pos.full <- read.delim("Lipidomics/Data/combined/20220224_pos_2_005_gp_height.txt", check.names = F, skip = 4)
rownames(lip.pos.full) <- paste0(lip.pos.full$`Alignment ID`, '_pos') 
dim(lip.pos.full) # 2min 005 gp 8955  316  

lip.neg.full <- read.delim("Lipidomics/Data/combined/20220224_neg_2_005_gp_height.txt", check.names = F, skip = 4)
rownames(lip.neg.full) <- paste0(lip.neg.full$`Alignment ID`, '_neg') 
dim(lip.neg.full) # 2min 005 gp 17222   316 
```

## Positive
### Create object

```{r}
lip.pos.int <- as.matrix(lip.pos.full[, 33:310])
lip.pos.info <- lip.pos.full[,1:32]

lip.pos.int <-  lip.pos.int[, !grepl(c("MSMS"), colnames(lip.pos.int))]
lip.pos.int <- lip.pos.int[, lip_inj_order$SampleID]
identical(colnames(lip.pos.int), lip_inj_order$SampleID) #TRUE

lip.se.pos <- SummarizedExperiment(assays = list(counts = lip.pos.int),
                                     rowData = list(info = lip.pos.info),
                                     colData = lip_inj_order)

dim(lip.se.pos) #8955  274

rm(lip.pos.full)
rm(lip.pos.int)
```

```{r}
# Check TIC across samples
total <- data.frame(Total.intensity = colSums(lip.pos.int)) %>%
  mutate(Class = lip_inj_order$class, Run = lip_inj_order$run) %>%
  rownames_to_column(., var = "SampleID") 
total$SampleID <- factor(total$SampleID, levels = total$SampleID)

ggplot(total, aes(x = SampleID, y = Total.intensity, fill = Class)) +
  geom_bar(stat = "identity") +
  geom_smooth(aes(colour = Class, group = Class), method = "loess", se = FALSE) +
  labs(title = "Total positive intensity across samples - combined runs") +
  facet_wrap(~Run, scales = "free_x")
```

```{r}
# Check individual features
selected_feature <- "5752_pos" 

total <- data.frame(Intensity = lip.pos.int[which(rownames(lip.pos.int) == selected_feature),]) %>%
  rownames_to_column(., var = "SampleID") %>%
  right_join(lip.metadata, by = "SampleID")

ggplot(total %>% filter(Days >= 120, Reason %in% c("Routine", "Spirometry loss", "Unknown")), aes(x = Days_to_clad, y = Intensity)) + 
  geom_boxplot(fill = "grey", alpha = 0.25, outlier.shape = NA) +
  geom_jitter(aes(colour = Days_post_transplant), width = 0.1) +
  theme_light() +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold", colour = "black")) +
  labs(colour = "Days post-transplant",
       x = "Days to CLAD",
       y = "Intensity") +
  plot_fill(Group = T) +
  plot_colours(Days_post_transplant = T) +
  facet_grid(.~Group, space = "free_x", scales = "free_x") +
  theme(legend.position = "bottom", legend.justification = c("left")) +
  scale_y_log10()
```

```{r}
# Perform the PCA and retrieve the explained variance values
data <- lip.se.pos
PCA <- prcomp(t(assay(data)), center = TRUE, scale = TRUE)
varexp <- c(summary(PCA)$importance[2,1]*100,summary(PCA)$importance[2,2]*100)

# Create a dataset for plotting
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x),
                                   PC1 = PCA$x[,1],
                                   PC2 = PCA$x[,2],
                             class = data$class,
                             run = data$run))

# Plot results
ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = class)) +
  stat_ellipse(aes(group = run), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) +
  labs(title = 'Lipidomics - combined runs',
         x = paste0('PC1 ', round(varexp[1], 2), '%'),
         y = paste0('PC2 ', round(varexp[2], 2), '%'))
```

### Blank and QC filtering

```{r}
# Replace missing values with NA to be compatible with next steps
assay(lip.se.pos) <- replace(assay(lip.se.pos), assay(lip.se.pos) == 0, NA)

# Filter peaks and optionally samples based on blanks (here fold change 5)
lip.filt.pos <- filter_peaks_by_blank(df = lip.se.pos, fold_change = 5, # how many times more in samples over blanks
                                    fraction_in_blank = 0.3, # value between 0 and 1 to specify fraction in how many blanks peaks should be present
                                    classes = lip.se.pos$class, 
                                    remove_samples = TRUE, remove_peaks = TRUE, 
                                    blank_label = "Blank", qc_label = "QC")

dim(lip.filt.pos)[1] # 2995

# Check missing values in columns
#names(which(colSums(is.na(assay(lip.filt.pos)))/nrow(assay(lip.filt.pos)) >= 0.60))

# Check missing values in columns and rows
#table(colSums(is.na(assay(lip.filt.pos)))/nrow(assay(lip.filt.pos)) >= 0.7) 
#names(rowSums(is.na(assay(lip.filt.pos)))/ncol(assay(lip.filt.pos)) >= 0.8) 

# Eliminate rows with more than 70% values missing
#lip.mv.filt.pos <- SummarizedExperiment::subset(lip.filt.pos, subset = rownames(lip.filt.pos) %in% names(which(rowSums(is.na(assay(lip.filt.pos)))/ncol(assay(lip.filt.pos)) < 0.7))) 
#dim(lip.mv.filt.pos) # 1524  233

# Filter peaks based on missing values in QC
lip.s.filt.pos <- filter_peaks_by_fraction(df = lip.filt.pos, min_frac = 0.3, # features should have values for >x% across samples
                                             classes = lip.filt.pos$class, 
                                             method = 'across', 
                                             remove_peaks = TRUE) 
dim(lip.s.filt.pos)[1] #2376

# Filter peaks based on the % of variation in the QC
lip.rsd.filt.pos <- filter_peaks_by_rsd(df = lip.s.filt.pos, max_rsd = 65, 
                                          classes = lip.s.filt.pos$class, 
                                          qc_label = 'QC')
dim(lip.rsd.filt.pos)[1] # 1195
saveRDS(lip.rsd.filt.pos, "Lipidomics/Data/combined/lip.rsd.filt.pos.rds")

rm(lip.filt.pos)
rm(lip.s.filt.pos)
rm(lip.se.pos)
```

```{r}
# Perform the PCA and retrieve the explained variance values
data <- lip.rsd.filt.pos

assay(data) <- replace(assay(data), is.na(assay(data)) == TRUE, 0)
#assay(data) <- replace(assay(data), is.infinite(assay(data)) == TRUE, 0)

PCA <- prcomp(t(log(assay(data)+1)), center = TRUE, scale = TRUE)
varexp <- c(summary(PCA)$importance[2,1]*100,summary(PCA)$importance[2,2]*100)

# Create a dataset for plotting
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x),
                                   PC1 = PCA$x[,1],
                                   PC2 = PCA$x[,2],
                             class = data$class,
                             run = data$run))

# Plot results
ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = class)) +
  #geom_point(aes(colour = run)) +
  #stat_ellipse(aes(group = batch), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) +
  labs(title = 'Lipidomics - combined runs',
         x = paste0('PC1 ', round(varexp[1], 2), '%'),
         y = paste0('PC2 ', round(varexp[2], 2), '%'))
```

### Normalisation, imputation and scaling

```{r}
# Normalisation 
lip.pqn.pos <- pqn_normalisation(df = lip.rsd.filt.pos, 
                                   classes = lip.rsd.filt.pos$class, 
                                   qc_label = "QC")

# Missing value imputation NRMSE 0.00944736 
lip.imp.pos <- mv_imputation(df = lip.pqn.pos, 
                               #rowmax = 0.7, colmax = 0.7, 
                               method = 'rf') # or rf, bcpa, sv, mn, md. # max % of missing data allowed in any row or cols
saveRDS(lip.imp.pos, "Lipidomics/Data/combined/lip.imp.pos.rds")

# Scaling
lip.glog.pos <- glog_transformation(df = lip.imp.pos, 
                                      classes = lip.imp.pos$class, 
                                      qc_label = "QC")

opt.lambda <- processing_history(lip.glog.pos)$glog_transformation$lambda_opt
#glog_plot_optimised_lambda(df = lip.imp.pos, optimised_lambda = opt.lambda, classes = lip.imp.pos$class, qc_label = "QC")
saveRDS(lip.glog.pos, "Lipidomics/Data/combined/lip.glog.pos.rds")

rm(lip.rsd.filt.pos)
rm(lip.imp.pos)
rm(lip.pqn.pos)
```

### Batch correction

```{r}
# Filter QCs
data <- lip.glog.pos

## Select batch effect group
    batcheffect <- as.factor(data$run)
    names(batcheffect) <- data$SampleID
    
## Select variable group 
    treatment <- factor(data$class, levels=c("Sample", "QC"))
    names(treatment) <- data$SampleID

## ComBat correction
## Specify the effect of interest within the model
    data.mod <- model.matrix(~ treatment)
    
lip.corr.pos <- ComBat(as.matrix(assay(data)), batch = batcheffect, mod = data.mod, par.prior = T, prior.plots = F)
    
PCA <- prcomp(t(lip.corr.pos), center = TRUE)
varexp <- c(summary(PCA)$importance[2,1]*100,summary(PCA)$importance[2,2]*100)

# Create a dataset for plotting
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x),
                                   PC1 = PCA$x[,1],
                                   PC2 = PCA$x[,2],
                             class = data$class,
                             run = data$run))
# Plot results
ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = class)) +
  stat_ellipse(aes(group = run), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) +
  labs(title = 'Lipidomics - combined',
         x = paste0('PC1 ', round(varexp[1], 2), '%'),
         y = paste0('PC2 ', round(varexp[2], 2), '%'))

lip.corr.pos <- SummarizedExperiment(assays = list(counts = lip.corr.pos),
                                     rowData = rowData(lip.glog.pos),
                                     colData = colData(lip.glog.pos))
# Remove QCs
lip.pos <- SummarizedExperiment::subset(lip.corr.pos, select = colData(lip.corr.pos)$class != "QC") 
saveRDS(lip.corr.pos, "Lipidomics/Data/combined/lip.corr.pos.rds")
saveRDS(lip.pos, "Lipidomics/Data/combined/lip.pos.rds")
lip.pos <- readRDS("Lipidomics/Data/combined/lip.pos.rds")
rm(lip.glog.pos)
rm(lip.corr.pos)
```

```{r}
# Perform the PCA and retrieve the explained variance values
data <- lip.pos
rm(lip.pos)

#assay(data) <- replace(assay(data), is.na(assay(data)) == TRUE, 0)

PCA <- prcomp(t(assay(data)), center = TRUE)
varexp <- c(summary(PCA)$importance[2,1]*100,summary(PCA)$importance[2,2]*100)

# Create a dataset for plotting
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x),
                                   PC1 = PCA$x[,1],
                                   PC2 = PCA$x[,2],
                             #batch_run = data$batch_run,
                             class = data$class,
                        run = data$run))

# Plot results
ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = run)) +
  stat_ellipse(aes(group = run), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) +
  labs(title = 'Lipidomics - combined',
         x = paste0('PC1 ', round(varexp[1], 2), '%'),
         y = paste0('PC2 ', round(varexp[2], 2), '%'))
```

## Negative
### Create object

```{r}
lip.neg.int <- as.matrix(lip.neg.full[, 33:310])
lip.neg.info <- lip.neg.full[,1:32]

lip.neg.int <-  lip.neg.int[, !grepl(c("MSMS"), colnames(lip.neg.int))]
lip.neg.int <- lip.neg.int[, lip_inj_order$SampleID]
identical(colnames(lip.neg.int), lip_inj_order$SampleID) #TRUE

lip.se.neg <- SummarizedExperiment(assays = list(counts = lip.neg.int),
                                     rowData = list(info = lip.neg.info),
                                     colData = lip_inj_order)

dim(lip.se.neg) #17222   274
```

```{r}
# Check TIC across samples
total <- data.frame(Total.intensity = colSums(lip.neg.int)) %>%
  mutate(Class = lip_inj_order$class, Run = lip_inj_order$run) %>%
  rownames_to_column(., var = "SampleID") 
total$SampleID <- factor(total$SampleID, levels = total$SampleID)

ggplot(total, aes(x = SampleID, y = Total.intensity, fill = Class)) +
  geom_bar(stat = "identity") +
  geom_smooth(aes(colour = Class, group = Class), method = "loess", se = FALSE) +
  labs(title = "Total negative intensity across samples - combined runs") +
  facet_wrap(~Run, scales = "free_x")
```

```{r}
# Perform the PCA and retrieve the explained variance values
data <- lip.se.neg
PCA <- prcomp(t(assay(data)), center = TRUE, scale. = TRUE)
varexp <- c(summary(PCA)$importance[2,1]*100,summary(PCA)$importance[2,2]*100)

# Create a dataset for plotting
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x),
                                   PC1 = PCA$x[,1],
                                   PC2 = PCA$x[,2],
                             class = data$class,
                             run = data$run))

# Plot results
ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = class)) +
  stat_ellipse(aes(group = run), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) +
  labs(title = 'Lipidomics - combined runs',
         x = paste0('PC1 ', round(varexp[1], 2), '%'),
         y = paste0('PC2 ', round(varexp[2], 2), '%'))
```

### Blank and QC filtering

```{r}
# Replace missing values with NA to be compatible with next steps
assay(lip.se.neg) <- replace(assay(lip.se.neg), assay(lip.se.neg) == 0, NA)

# Filter peaks and optionally samples based on blanks (here fold change 5)
lip.filt.neg <- filter_peaks_by_blank(df = lip.se.neg, fold_change = 5, # how many times more in samples over blanks
                                    fraction_in_blank = 0.25, # value between 0 and 1 to specify fraction in how many blanks peaks should be present
                                    classes = lip.se.neg$class, 
                                    remove_samples = TRUE, remove_peaks = TRUE, 
                                    blank_label = "Blank", qc_label = "QC")

dim(lip.filt.neg)[1] # 5727

# Check missing values in columns
#names(which(colSums(is.na(assay(lip.filt.neg)))/nrow(assay(lip.filt.neg)) >= 0.60))

# Check missing values in columns and rows
#table(colSums(is.na(assay(lip.filt.neg)))/nrow(assay(lip.filt.neg)) >= 0.7) 
#table(rowSums(is.na(assay(lip.filt.neg)))/ncol(assay(lip.filt.neg)) >= 0.8) 

# Eliminate rows with more than 70% values missing
#lip.mv.filt.neg <- SummarizedExperiment::subset(lip.filt.neg, subset = rownames(lip.filt.neg) %in% names(which(rowSums(is.na(assay(lip.filt.neg)))/ncol(assay(lip.filt.neg)) < 0.70))) 
#dim(lip.mv.filt.neg) #3191  233

# Filter peaks based on missing values in QC
lip.s.filt.neg <- filter_peaks_by_fraction(df = lip.filt.neg, min_frac = 0.3, 
                                             classes = lip.filt.neg$class, 
                                             method = 'across', qc_label = 'QC', 
                                             remove_peaks = TRUE) # features should have values for >x% across samples
dim(lip.s.filt.neg)[1] # 4210

# Filter peaks based on the % of variation in the QC
lip.rsd.filt.neg <- filter_peaks_by_rsd(df = lip.s.filt.neg, 
                                          max_rsd = 65, 
                                          classes = lip.s.filt.neg$class, 
                                          qc_label = 'QC')
dim(lip.rsd.filt.neg)[1] # 2764

rm(lip.filt.neg)
rm(lip.s.filt.neg)
rm(lip.mv.filt.neg)
```

```{r}
# Perform the PCA and retrieve the explained variance values
data <- lip.rsd.filt.neg

assay(data) <- replace(assay(data), is.na(assay(data)) == TRUE, 0)
#assay(data) <- replace(assay(data), is.infinite(assay(data)) == TRUE, 0)

PCA <- prcomp(t(log(assay(data)+1)), center = TRUE)
varexp <- c(summary(PCA)$importance[2,1]*100,summary(PCA)$importance[2,2]*100)

# Create a dataset for plotting
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x),
                                   PC1 = PCA$x[,1],
                                   PC2 = PCA$x[,2],
                             class = data$class,
                             run = data$run))

# Plot results
ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = class)) +
  #geom_point(aes(colour = run)) +
  #stat_ellipse(aes(group = batch), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) +
  labs(title = 'Lipidomics - combined runs',
         x = paste0('PC1 ', round(varexp[1], 2), '%'),
         y = paste0('PC2 ', round(varexp[2], 2), '%'))
```

### Normalisation, imputation and scaling

```{r}
# Normalisation 
lip.pqn.neg <- pqn_normalisation(df = lip.rsd.filt.neg, 
                                   classes = lip.rsd.filt.neg$class, 
                                   qc_label = "QC")

#table(colSums(is.na(assay(lip.pqn.neg)))/nrow(assay(lip.pqn.neg)) >= 0.7)

# Missing value imputation NRMSE 0.03159004 
lip.imp.neg <- mv_imputation(df = lip.pqn.neg, 
                               #rowmax = 0.7, colmax = 0.7, 
                               method = 'rf') # or rf, bcpa, sv, mn, md. # max % of missing data allowed in any row or cols

saveRDS(lip.imp.neg, "Data/combined/lip.imp.neg.rf.rds")

# Scaling
lip.glog.neg <- glog_transformation(df = lip.imp.neg, 
                                      classes = lip.imp.neg$class, 
                                      qc_label = "QC")

opt.lambda <- processing_history(lip.glog.neg)$glog_transformation$lambda_opt
#glog_plot_optimised_lambda(df = lip.imp.neg, optimised_lambda = opt.lambda, classes = lip.imp.neg$class, qc_label = "QC")
saveRDS(lip.glog.pos, "Data/combined/lip.glog.neg.rds")

rm(lip.rsd.filt.neg)
rm(lip.imp.neg)
rm(lip.pqn.neg)
```

### Batch correction

```{r}
# Filter QCs
data <- lip.glog.neg

## Select batch effect group
    batcheffect <- as.factor(data$run)
    names(batcheffect) <- data$SampleID
    
## Select variable group 
    treatment <- factor(data$class, levels=c("Sample", "QC"))
    names(treatment) <- data$SampleID

## ComBat correction
## Specify the effect of interest within the model
    data.mod <- model.matrix(~ treatment)
    
lip.corr.neg <- ComBat(as.matrix(assay(data)), batch = batcheffect, mod = data.mod, par.prior = T, prior.plots = F)
    
PCA <- prcomp(t(lip.corr.neg), center = TRUE, scale = TRUE)
varexp <- c(summary(PCA)$importance[2,1]*100,summary(PCA)$importance[2,2]*100)

# Create a dataset for plotting
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x),
                                   PC1 = PCA$x[,1],
                                   PC2 = PCA$x[,2],
                             class = data$class,
                             run = data$run))
# Plot results
ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = class)) +
  stat_ellipse(aes(group = run), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) +
  labs(title = 'Lipidomics - combined',
         x = paste0('PC1 ', round(varexp[1], 2), '%'),
         y = paste0('PC2 ', round(varexp[2], 2), '%'))

lip.corr.neg <- SummarizedExperiment(assays = list(counts = lip.corr.neg),
                                     rowData = rowData(lip.glog.neg),
                                     colData = colData(lip.glog.neg))
# Remove QCs
lip.neg <- SummarizedExperiment::subset(lip.corr.neg, select = colData(lip.corr.neg)$class != "QC") 
saveRDS(lip.corr.neg, "Lipidomics/Data/combined/lip.corr.neg.rds")
saveRDS(lip.neg, "Lipidomics/Data/combined/lip.neg.rds")
lip.neg <- readRDS("Lipidomics/Data/combined/lip.neg.rds")
rm(lip.glog.neg)
rm(lip.corr.neg)
```

```{r}
# Perform the PCA and retrieve the explained variance values
data <- lip.neg
rm(lip.neg)

#assay(data) <- replace(assay(data), is.na(assay(data)) == TRUE, 0)

PCA <- prcomp(t(assay(data)), center = TRUE, scale. = TRUE)
varexp <- c(summary(PCA)$importance[2,1]*100,summary(PCA)$importance[2,2]*100)

# Create a dataset for plotting
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x),
                                   PC1 = PCA$x[,1],
                                   PC2 = PCA$x[,2],
                             class = data$class,
                             run = data$run))

# Plot results
ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = run)) +
  stat_ellipse(aes(group = run), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) +
  labs(title = 'Lipidomics - combined',
         x = paste0('PC1 ', round(varexp[1], 2), '%'),
         y = paste0('PC2 ', round(varexp[2], 2), '%'))
```

# Merge back into one object

```{r}
identical(colnames(assay(lip.pos)), colnames(assay(lip.neg))) # TRUE
identical(colnames(rowData(lip.pos)), colnames(rowData(lip.neg))) # TRUE
identical(colnames(colData(lip.pos)), colnames(colData(lip.neg))) # TRUE

assay.lip <- rbind(assay(lip.pos), assay(lip.neg))
rowdata.lip <- rbind(rowData(lip.pos), rowData(lip.neg))
  
lip <- SummarizedExperiment(assays = list(counts = assay.lip),
                                     rowData = rowdata.lip,
                                     colData = colData(lip.pos))

dim(lip)[1] #3959

rm(rowdata.lip, assay.lip, lip.neg, lip.pos)
```

```{r}
# Perform the PCA and retrieve the explained variance values
data <- lip

#assay(data) <- replace(assay(data), is.na(assay(data)) == TRUE, 0)

PCA <- prcomp(t(assay(data)), center = TRUE, scale. = TRUE)
varexp <- c(summary(PCA)$importance[2,1]*100,summary(PCA)$importance[2,2]*100)

# Create a dataset for plotting
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x),
                                   PC1 = PCA$x[,1],
                                   PC2 = PCA$x[,2],
                             class = data$class,
                             SampleID = data$SampleID,
                             run = data$run))

# Plot results
ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = run)) +
  stat_ellipse(aes(group = run), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) +
  labs(title = 'Lipidomics - combined',
         x = paste0('PC1 ', round(varexp[1], 2), '%'),
         y = paste0('PC2 ', round(varexp[2], 2), '%')) +
  geom_text_repel(aes(x = PC1, y = PC2), max.overlaps = 50, label = data.PCA$SampleID, cex=1.5) 
```

# Annotation
## GNPS Annotation

```{r}
# Import gpns result
lip.pos.gnps <- read.csv("Lipidomics/Data/combined/gnps/gnps-pos.csv")
lip.neg.gnps <- read.csv("Lipidomics/Data/combined/gnps/gnps-neg.csv")

# Format GNPS compound names and return a joined pos and neg data.frame
lip.gnps <- gnps_format_names_lip(gnps_pos_df = lip.pos.gnps, gnps_neg_df = lip.neg.gnps)

rm(lip.pos.gnps)
rm(lip.neg.gnps)
```

```{r}
# Add the GNPS compound names to both the glog-transformed and imputed SE objects
rowData(lip)$compound_name_gnps <- gnps_SE_names(gnps_df = lip.gnps, metab_SE = lip)
rm(lip.gnps)

saveRDS(lip, "Lipidomics/Data/combined/lip.rds")
lip <- readRDS("Lipidomics/Data/combined/lip.rds")
```

## Lipid MAPS annotation

```{r}
lmsd_df <- readRDS('Lipidomics/Data/LMDB_231107.rds')

# Search annotations in LMSD and add to the SE objects
# Create list for all distinct Lipid Maps matching mz in tolerance range 0.002, an aggregated df of distinct lipids and a df to replace SummarizedExperiment metadata 
lmsd_ann_list <- add_lmsd(metab_SE = lip, lmsd = lmsd_df, mass_tol = 0.002, cores = 7) 
saveRDS(lmsd_ann_list, "Lipidomics/Data/combined/lmsd_ann_list.rds")
lmsd_ann_list <- readRDS("Lipidomics/Data/combined/lmsd_ann_list.rds")

# use metadata_lmsd_table to replace SE object metadata
lip.lmsd <- lip
rowData(lip.lmsd) <- lmsd_ann_list$metadata_lmsd_table
rm(lip)
```

```{r}
# Prepare data.frame with alignment IDs and all annotations and filter for at least one annotation
msdial_lmsd_gnps_hmdb <- compare_annotations_lip(metab_SE = lip.lmsd, agg_lmsd_ann = lmsd_ann_list$agg_lmsd_df)
dim(msdial_lmsd_gnps_hmdb)[1] #1041
dim(lip.lmsd)[1] #3959
rm(lmsd_ann_list)

saveRDS(msdial_lmsd_gnps_hmdb, "Lipidomics/Data/combined/msdial_lmsd_gnps_hmdb.rds")
write.csv(msdial_lmsd_gnps_hmdb, "Lipidomics/Data/combined/msdial_lmsd_gnps_hmdb.csv")
rm(msdial_lmsd_gnps_hmdb)
```

```{r}
# Keep only annotated rows and generate shortname column
lip_annotated <- keep_annotated_lip(lip.lmsd)  
dim(lip_annotated)[1] #967
rm(lip.lmsd, lmsd_df)
saveRDS(lip_annotated, "Lipidomics/Data/combined/lip_annotated.rds")
```

# Save datasets

```{r}
dim(assay(lip_annotated)) #967 236
dim(rowData(lip_annotated)) # 967  61
dim(colData(lip_annotated)) # 236   6

# Save the curation table
save_curation_table_lip(lip_annotated, "Lipidomics/Data/combined/curation/20240731-lip-for-curation-005-002.csv")
```

# Quality filtering

```{r}
# Merge tables based on previous filtering
table1 <- read.csv("Lipidomics/Data/combined/curation/20220321-lipid-curated.csv") %>% mutate(merge = paste0(Alignment_ID, Ionisation)) %>% rename(shortname_old = shortname)
table2 <- read.csv("Lipidomics/Data/combined/curation/20240731-lip-for-curation-005-002.csv") %>% mutate(merge = paste0(Alignment_ID, Ionisation)) # new table that was just made above

table <- table2 %>%
  left_join(table1)

identical(table$Alignment_ID, table2$Alignment_ID)
write.csv(table, "Lipidomics/Data/combined/curation/20240731-merged-lip-for-curation-005-002.csv")
sum(is.na(table$quality_peak)) # 6 new annotated ones
rm(table1, table2)
```

```{r}
# Load quality data
lip.quality <- read_csv("Lipidomics/Data/combined/curation/20240731-lip-curated.csv") 
table(lip.quality$quality_peak) #537

identical(rowData(lip_annotated)$shortname, lip.quality$shortname)
identical(as.numeric(rowData(lip_annotated)$`info.Alignment ID`), as.numeric(lip.quality$Alignment_ID) )

view(cbind(rowData(lip_annotated)$`info.Alignment ID`, lip.quality$Alignment_ID))
data.frame(cbind(rowData(lip_annotated)$shortname, lip.quality$shortname)) %>% filter(X1 != X2)
data.frame(cbind(rowData(lip_annotated)$`info.Alignment ID`, lip.quality$Alignment_ID)) %>% filter(X1 == X2)

# Filter the features using the TRUE/FALSE quality_peak column
lip_annotated_filtered <- lip_annotated[lip.quality$quality_peak,]

# labels
rowData(lip_annotated_filtered)$shortname <- gsub("_pos\\.\\d+|_neg\\.\\d+|_pos|_neg", "", rowData(lip_annotated_filtered)$shortname)
rowData(lip_annotated_filtered)$shortname <- sub("^([a-z])", "\\U\\1", rowData(lip_annotated_filtered)$shortname, perl = TRUE) # capitalise first letter
rowData(lip_annotated_filtered)$shortname <- gsub("_", "/", rowData(lip_annotated_filtered)$shortname)
rowData(lip_annotated_filtered)$ABBREVIATION <- ifelse(grepl("\\|", rowData(lip_annotated_filtered)$shortname), gsub("\\|.*", "", rowData(lip_annotated_filtered)$shortname), rowData(lip_annotated_filtered)$ABBREVIATION ) # split abbreviation and edit shortname for MSdial 
rowData(lip_annotated_filtered)$shortname <- ifelse(grepl("\\|", rowData(lip_annotated_filtered)$shortname), gsub(".*\\|", "", rowData(lip_annotated_filtered)$shortname), rowData(lip_annotated_filtered)$shortname)
         
table(duplicated(rowData(lip_annotated_filtered)$shortname))
# view(rowData(lip_annotated_filtered[which(duplicated(rowData(lip_annotated_filtered)$shortname)),]))
rownames(lip_annotated_filtered) <- rowData(lip_annotated_filtered)$shortname
saveRDS(lip_annotated_filtered, "Lipidomics/Data/combined/lip_annotated_filtered.rds")

# Split summarised experiment into dataframes
lip_annotated_filtered_df <- data.frame(assay(lip_annotated_filtered), check.names = FALSE)
lip_annotated_filtered_info_df <- data.frame(rowData(lip_annotated_filtered), check.names = FALSE) 

saveRDS(lip_annotated_filtered_df, "Lipidomics/Data/combined/lip_annotated_filtered_df.rds")
# lip_annotated_filtered_df <- readRDS("Lipidomics/Data/combined/lip_annotated_filtered_df.rds")
saveRDS(lip_annotated_filtered_info_df, "Lipidomics/Data/combined/lip_annotated_filtered_info_df.rds")
# lip_annotated_filtered_info_df <- readRDS("Lipidomics/Data/combined/lip_annotated_filtered_info_df.rds")

lipids_info <- lip_annotated_filtered_info_df %>%
  dplyr::select(info.Ontology, CATEGORY, MAIN_CLASS, SUB_CLASS, CLASS_LEVEL4, ABBREVIATION, LMSD, `info.Metabolite name`, SYNONYMS, info.Formula, KEGG, HMDB_Accession, CHEBI_ID, LIPIDMAPS_ID, PubChem_ID, info.INCHIKEY, info.SMILES, shortname, EXACT_MASS, SYSTEMATIC_NAME) %>%
  rename(NAME = LMSD) %>%
  mutate(CHEBI_ID = as.character(CHEBI_ID), PubChem_ID = as.character(PubChem_ID), Dataset = "Lipidomics") %>%
  mutate(SUB_CLASS = ifelse(grepl("erine|itol|glycerol|amine|choline", SUB_CLASS) & 
                              !grepl(paste0(paste0(c("erine", "itol", "glycerol", "amine", "choline"), "s"), collapse = "|"), SUB_CLASS), paste0(SUB_CLASS, "s"), SUB_CLASS),
         SUB_CLASS = gsub("ss", "s", SUB_CLASS),
         SUB_CLASS = gsub("Cholesterol and derivatives", "Cholesterols and derivatives", SUB_CLASS))

lipids_info <- lipids_info %>% 
  mutate(info.Ontology = as.character(info.Ontology),
    info.Ontology = ifelse(info.Ontology == "null", NA, info.Ontology)) %>%
  left_join(msdial_annotations, by = c("info.Ontology")) %>% 
  mutate(CATEGORY = coalesce(CATEGORY.x, CATEGORY.y), 
         MAIN_CLASS = coalesce(MAIN_CLASS.x, MAIN_CLASS.y), 
         SUB_CLASS = coalesce(SUB_CLASS.x, SUB_CLASS.y)) %>% 
  relocate(CATEGORY, MAIN_CLASS, SUB_CLASS, CATEGORY.x, CATEGORY.y, MAIN_CLASS.x, MAIN_CLASS.y, SUB_CLASS.x, SUB_CLASS.y) %>% 
  dplyr::select(-CATEGORY.x, -CATEGORY.y, -MAIN_CLASS.x, -MAIN_CLASS.y, -SUB_CLASS.x, -SUB_CLASS.y) %>%
  mutate(CATEGORY = str_squish(gsub("\\[.*?\\]", "", CATEGORY)),
         CATEGORY = gsub("Fatty Acyls", "Fatty acyls", CATEGORY),
         CATEGORY = gsub("Prenol Lipids", "Prenol lipids", CATEGORY),
         MAIN_CLASS = str_squish(gsub("\\[.*?\\]", "", MAIN_CLASS)),
         SUB_CLASS = str_squish(gsub("\\[.*?\\]", "", SUB_CLASS)) )

saveRDS(lipids_info, "Lipidomics/Data/combined/lipids_info.rds")
#lipids_info <- readRDS("Lipidomics/Data/combined/lipids_info.rds")
dim(lipids_info) #537 21

rm(table, lip.quality)
```

# Metadata 

```{r}
lip_sample_metadata <- read_csv("Lipidomics/Data/combined/combined-metadata-lip.csv", col_types = 'ncccc') %>%
  filter(SampleID != "3673") %>% # remove R healthy lung of patient 19 BGP, (left tx one is 3705)
  left_join(master_metadata$general_metadata[, c("Record.ID", "transplant_date")], by = "Record.ID") %>%
  mutate(Date = as.Date(Date, format = "%Y%m%d"),
         Days = Date - transplant_date,
         Days = as.numeric(Days)) %>%
  mutate(Patient_days = paste0(Record.ID, "_", Days)) %>%
  as.data.frame()
rownames(lip_sample_metadata) <- lip_sample_metadata$SampleID

# Remove duplicates
duplicates <- lip_sample_metadata %>% group_by(Patient_days) %>% filter(n() > 1) %>% dplyr::select(Patient_days, Run, SampleID) %>% filter(Run == 1) %>% pull(SampleID)

# Remove duplicates belonging to run 1
lip_sample_metadata <- lip_sample_metadata[!(lip_sample_metadata$SampleID %in% duplicates),] %>% dplyr::select(Record.ID, Days, Patient_days, SampleID)
```

```{r}
# Check duplicates on pca
data <- lip

PCA <- prcomp(t(assay(data)), center = TRUE, scale. = TRUE)
varexp <- c(summary(PCA)$importance[2,1]*100,summary(PCA)$importance[2,2]*100)

lip.metadata <- lip.metadata[rownames(PCA$x),]

identical(rownames(PCA$x), lip.metadata$SampleID)

# Create a dataset for plotting
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x),
                                   PC1 = PCA$x[,1],
                                   PC2 = PCA$x[,2],
                             lip.metadata))

# Plot results
ggsave("pca.png",

ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = Run)) +
  #stat_ellipse(aes(group = Run), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) +
  labs(title = 'Lipidomics - combined',
         x = paste0('PC1 ', round(varexp[1], 2), '%'),
         y = paste0('PC2 ', round(varexp[2], 2), '%')) +
 geom_text_repel(aes(x = PC1, y = PC2), max.overlaps = 50, label = ifelse(lip.metadata$Duplicate, lip.metadata$Patient_days, ""), cex=1.5) 

, width = 15, height = 12, units = 'cm')
```

```{r}
l <- fev_at_bronch(lip_sample_metadata, 
                      spirometry_metadata,
                      unique(lip_sample_metadata$Record.ID)) # need record.id, days and patient days

lip_metadata <- lip_sample_metadata %>%
  left_join(master_metadata$meds_metadata, by = c("Patient_days")) %>%
  left_join(master_metadata$general_metadata, by = "Record.ID") %>% 
  left_join(l, by = c("Patient_days")) %>%
  left_join(master_metadata$donor, by = "Record.ID") %>% 
  left_join(master_metadata$bal_class_hosp)
lip_metadata <- annotate_clad(lip_metadata)
lip_metadata <- classify_dosage(lip_metadata)

lip_metadata <- lip_metadata %>%
      mutate(Time_interval_detailed = case_when(Days <= 42 ~ "<1.5 months",
                                             Days > 42 & Days <= 92 ~ "1.5-3 months",
                                             Days > 92 & Days <= 183 ~ "3-6 months",
                                             Days > 183 & Days <= 365 ~ "6-12 months",
                                             Days > 365 ~ ">12 months"), 
             Time_interval_detailed = factor(Time_interval_detailed, c("<1.5 months", "1.5-3 months", "3-6 months", "6-12 months", ">12 months")),
             
             Time_interval_combined = case_when(Days <= 92 ~ "<3 months",
                                             Days > 92 & Days <= 183 ~ "3-6 months",
                                             Days > 183 & Days <= 365 ~ "6-12 months",
                                             Days > 365 ~ ">12 months"), 
             Time_interval_combined = factor(Time_interval_combined, c("<3 months", "3-6 months", "6-12 months", ">12 months")),
             
             Days_interval = case_when(Days <= 183 ~ "<6 months",
                                       Days > 183 ~ ">6 months"), 
             Days_interval = factor(Days_interval, c("<6 months", ">6 months")),
             
             Immunosuppression = case_when(Days <= 183 ~ "High",
                                             Days > 183 & Days <= 365 ~ "Mid",
                                             Days > 365 ~ "Low"), 
             Immunosuppression = factor(Immunosuppression, c("High", "Mid", "Low")),
             Months = round(Days/30.417, 1)) %>%
  filter(Record.ID %in% unique(c(stable_patients, biomarker_patients)) ) %>% # patients
  filter(Patient_days != "44_182", SampleID != "3673") %>% # remove sex mismatched sample and right native lung
  filter(Months < 26) %>%
  filter(is.na(days_to_clad) | days_to_clad >= -30) # only tx lobes, and samples less than 30M

# Change colnames
lipids <- lip_annotated_filtered_df %>% dplyr::select(lip_metadata$SampleID)
identical(colnames(lipids), lip_metadata$SampleID) # TRUE

colnames(lipids) <- lip_metadata$Patient_days
rownames(lip_metadata) <- lip_metadata$Patient_days

dim(lipids) #537 186
dim(lip_metadata) #186 161

saveRDS(lip_metadata, "Lipidomics/Data/combined/lip_metadata.rds")
saveRDS(lipids, "Lipidomics/Data/combined/lipids.rds")
```

# -------
# Merge datasets into small molecules

```{r}
s <- lipids %>% dplyr::select(met_metadata$Patient_days) 
identical(colnames(metabolites), colnames(s))
small_molecules <- rbind(metabolites, s) 
small_molecules_metadata <- met_metadata
dim(small_molecules) #985 185

small_molecules_info <- metabolites_info %>%
  full_join(lipids_info) %>%
  relocate(NAME, `info.Metabolite name`, ABBREVIATION)
dim(small_molecules_info) #985 22
rownames(small_molecules_info) <- small_molecules_info$shortname

identical(rownames(small_molecules_info), rownames(small_molecules)) # TRUE

# small_molecules_info %>% group_by(shortname) %>% filter(n() > 1) %>% dplyr::select(shortname, Dataset, `info.Alignment ID`, LipidID)
# small_molecules_info %>% filter(grepl("\\|", `info.Metabolite name`)) %>% relocate(`info.Metabolite name`, SYNONYMS) %>% view()

saveRDS(small_molecules, "Lipidomics/Data/combined/small_molecules.rds")
saveRDS(small_molecules_info, "Lipidomics/Data/combined/small_molecules_info.rds")

rm(lip_annotated, lip_annotated_filtered, lip_annotated_filtered_df, lip_annotated_filtered_info_df, lip_inj_order, l, s)

small_molecules_metadata <- small_molecules_metadata %>% 
  mutate(Months_grouped = case_when(Days <= 42 ~ "<1.5",
                                    Days > 42 & Days <= 92 ~ "1.5-3",
                                    Days > 92 & Days <= 183 ~ "4-6",
                                    Days > 183 & Days <= 273 ~ "7-9",
                                    Days > 273 & Days <= 365 ~ "10-12",
                                    Days > 365 & Days <= 547 ~ "13-18",
                                    Days > 547 ~ ">18"), 
         Months_grouped = factor(Months_grouped, c("<1.5", "1.5-3", "4-6", "7-9", "10-12", "13-18", ">18")),
         Days_interval2 = case_when(Days <= 92 ~ "<3 months",
                                   Days > 92 ~ ">3 months"), 
         Days_interval2 = factor(Days_interval2, c("<3 months", ">3 months")),
         Total_ant_cat_split = ifelse(Total_ant_num == 0, "0",
                                          ifelse(Total_ant_num > 0 & Total_ant_num <= 2, "1-2", "3-5")),
         Total_ant_cat_split = factor(Total_ant_cat_split, levels = c("0", "1-2", "3-5")) 
         )

# small_molecules_metadata %>% group_by(Months_grouped) %>% dplyr::count()

saveRDS(small_molecules_metadata, "Lipidomics/Data/combined/small_molecules_metadata.rds")
```

