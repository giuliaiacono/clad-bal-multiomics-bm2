---
title: "Biomarker cohort - MOFA"
author: "Giulia Iacono"
output: html_document
date: Sys.Date()
---

# MOFA 

```{r}
# RNA
mofa_rna <- assay(deseq_list$`group+months`$vsd)[biomarker_rna_combined , ]
dim(mofa_rna) #222 127
# intersect(select_var, biomarker_rna_combined_df$Gene)

# MOLECULES
select_var <- biomarker_molecules_combined
mofa_molecules <- biomarker_small_molecules[select_var, ]
dim(mofa_molecules) #64 153


hist(as.vector(mofa_rna), breaks=500)
hist(as.vector(as.matrix(mofa_molecules)), breaks=100)
hist(as.vector(as.matrix(mofa_bacteria)), breaks=100) 
```

```{r}
features <- c("Record.ID", "Patient_days", "Group", "Days", "Months", "Months_grouped", "Gender", "Age", "Transplant_indication", "Total_ant_num", "GIT_ischemic_time", "days_to_clad")

mofa_metadata <- biomarker_rna_metadata[, c(features)] %>% 
  full_join(biomarker_small_molecules_metadata[, features]) %>%
  filter(Patient_days %in% unique(c(colnames(mofa_rna), colnames(mofa_molecules)))) %>% 
  arrange(Months_grouped, Group) %>%
  mutate(Group_months_grouped = paste(Group, Months_grouped, sep = "_"),
        Group_months_grouped = factor(Group_months_grouped, levels = unique(Group_months_grouped)),
        CLAD_progression = ifelse(Group == "CLAD-free", "CLAD-free", 
                                     ifelse(days_to_clad < 365 | is.na(days_to_clad), "CLAD<365", "CLAD>365")),
        CLAD_progression = factor(CLAD_progression, levels = c("CLAD-free", "CLAD>365", "CLAD<365")),
        Group = factor(Group, levels = c("CLAD-free", "CLAD")))

rownames(mofa_metadata) <- mofa_metadata$Patient_days # important or cannot map
dim(mofa_metadata) #168  14
```

```{r}
mofa_object <- MultiAssayExperiment(list(Genes = as.matrix(mofa_rna),
                                      Molecules = as.matrix(mofa_molecules)), 
                  colData = mofa_metadata)
mofa_object <- create_mofa(mofa_object) 
mofa_object <- set_covariates(mofa_object, covariates = c("Months"))

p <- plot_data_overview(mofa_object, show_dimensions = TRUE, show_covariate = FALSE,
                   colors = c("#5C6378", "#6099C4")) + 
  theme +
  theme(plot.title = element_text(face = "bold"),
              axis.text.x = element_blank(),
        legend.position = "bottom") +
    labs(title = "Omics datasets", x = "Sample", y = "Omics")
ggsave(paste0(analysis_path, "biomarker-mofa/datasets.png"), p, width = 10, height = 6, units = 'cm', dpi = 600)
```

## Train

```{r}
# mofa_list <- list()

# Set Data options
data.opts <- get_default_data_options(mofa_object)

# Model options
model.opts <- get_default_model_options(mofa_object)
model.opts$num_factors <- 1

# Training options 
train.opts <- get_default_training_options(mofa_object)

drop_factor_threshold <- NA
maxiter <- NA
convergence_mode <- "slow"
#train.opts$drop_factor_threshold <- drop_factor_threshold
#train.opts$maxiter <- maxiter
train.opts$convergence_mode <- convergence_mode

# Mefisto options
mefisto.opts <- get_default_mefisto_options(mofa_object)

# Set object
m <- prepare_mofa(object = mofa_object,
  data_options = data.opts,
  model_options = model.opts,
  training_options = train.opts, 
  mefisto_options = mefisto.opts
  ) 

name <- paste("rna-mol-1factor-", drop_factor_threshold, maxiter, convergence_mode, sep = "-")
p <- run_mofa(m, outfile = paste0("biomarker-mofa/models/", name, "-preimputed.hdf5"), use_basilisk = TRUE) # cannot save remotely or fatal error
#p <- load_model(paste0("biomarker-mofa/models/", name, "-preimputed.hdf5"))
mofa_imputed <- impute(p)
rownames(mofa_imputed@samples_metadata) <- mofa_imputed@samples_metadata$Patient_days
saveRDS(mofa_imputed, paste0(analysis_path, "biomarker-mofa/models/", name, "-imputed.rds"))

mofa_list[[name]] <- mofa_imputed
saveRDS(mofa_list, paste0(analysis_path, "biomarker-mofa/models/mofa_list.rds"))
# mofa_list <- readRDS("biomarker-mofa/models/mofa_list.rds")
```

## Total variance

```{r}
# Total variance explained by omics
r2t <- reshape2::melt(mofa_imputed@cache$variance_explained$r2_total)

p <- ggplot(r2t, aes(fill=Var1, y=value, x=Var1)) +
  scale_fill_manual(values=c("#5C6378", "#6099C4")) + 
  geom_bar(position='stack', stat='identity', col='black', cex=0.25, alpha = 0.9) +
  theme +
  theme(legend.position='none') +
  labs(x='Omics dataset', y='Variance explained (%)', title = "Omics views")

ggsave(paste0(analysis_path, "biomarker-mofa/total-var.png"), p, width = 6, height = 6, units = 'cm', dpi = 600)

# Variance per factor
r2f <- reshape2::melt(mofa_imputed@cache$variance_explained$r2_per_factor[[1]]) %>% 
  mutate(Var1 = as.factor(as.numeric(gsub("Factor", "", Var1))),
         Factor = "Disease-associated Latent Factor")

p <-
  
  ggplot(r2f, aes(fill=Var2, y=value, x=Factor)) +
  scale_fill_manual(values=c("#5C6378", "#6099C4")) + 
  geom_bar(position='stack', stat='identity', col='black', cex=0.25, alpha = 0.9) +
  theme +
  labs(x = '', 
       y = 'Variance explained (%)', 
       title = "MOFA omics factors",
       fill = "Omics")

ggsave(paste0(analysis_path, "biomarker-mofa/var-per-factor.png"), p, width = 8, height = 6, units = 'cm', dpi = 600)
```

## Factors and covariates

```{r}
latent_factors <- data.frame(get_factors(mofa_imputed)$group1) %>% 
  rownames_to_column("Patient_days") %>%
  left_join(mofa_metadata) %>%
  arrange(Record.ID, Months)
```

```{r}
  p <-
    
  ggplot(latent_factors, aes(x = Months, y = Factor1)) +
    geom_point(aes(fill = Group), shape = 21) +
    geom_smooth(aes(group = Group, colour = Group), method = "lm", formula = y ~ ns(x, 2), linewidth = 0.8) +
    labs(title = "Disease-associated Latent Factor", y = "Value", x = "Months post-transplant", colour = "Group", fill = "Group") +
    theme +
    theme(legend.position = "right") +
    plot_fill(Group = TRUE) +
    plot_colours(Group = TRUE)
  
  ggsave(paste0(analysis_path, "biomarker-mofa/factor1-months-lm.png"), p, width = 9, height = 7, units = 'cm', dpi = 600)
  
# check time interaction
model_full <- lmer(Factor1 ~ Group*ns(Months, 2) + Transplant_indication + Total_ant_num + GIT_ischemic_time + (1 | Record.ID),
  data = latent_factors,
  REML = FALSE
)

model_reduced <- lmer(Factor1 ~ Group+ns(Months, 2) + Transplant_indication + Total_ant_num + GIT_ischemic_time + (1 | Record.ID),
  data = latent_factors,
  REML = FALSE
)

anova(model_reduced, model_full) # pval for time interaction 0.2557 so use reduced

summary(model_full) #pval for Group 0.000204
```

## Weights

```{r}
fact_weights_list <- list()

for (i in c(1)){
  fact_weights_list[[i]] <- get_weights(mofa_imputed, as.data.frame = T, factors = i) %>%
    group_by(view) %>%
    mutate(sign = case_when(value > 0 ~ "+",
                          value <= 0 ~ "-"),
           Feature = feature,
           feature = gsub("_Molecules|_Genes", "", feature)) 
}

saveRDS(fact_weights_list, paste0(analysis_path, "biomarker-mofa/weights/factor_weights_list.rds"))
```

```{r}
i <- 1

g <- read.csv(paste0(analysis_path, "transcriptomics-small-molecules/tmixclust/rna/biomarker/biomarker-rna-heatmap.csv")) %>%
  dplyr::select(Gene, Direction_cluster2) %>%
  rename(Feature = Gene, Cluster = Direction_cluster2)

m <- biomarker_classes[, c("Molecule", "Rename", "direction", "Class")] %>%
  rename(Feature = Molecule, Cluster = direction)

g_m <- full_join(g, m) %>%
  mutate(Cluster = gsub("eased", ".", Cluster),
         Cluster = factor(Cluster, levels = c("Resurfacing", "Incr.", "Decr.")),
         Class = factor(Class)) 

d <- 
  fact_weights_list[[i]] %>%
  left_join(g_m) %>%
  mutate(feature = ifelse(view == "Genes", Feature, Rename)) 
```

```{r}
p1 <-   
  d %>%
  group_by(view) %>%
  slice_max(abs(value), n = 25) %>% 
  filter(view == "Genes") %>%

ggplot(aes(x = value, y = reorder(feature, abs(value)))) +
  geom_col(width = 0.5, fill = "lightgrey") +
  geom_point(aes(fill = Class), size = 3, shape = 21) +
  theme +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 12),
        axis.text.y = element_text(size = 12)) +
  labs(y = "Feature",
       x = "Weight") +
  facet_grid(Cluster~view, scales = "free", space = "free") +
  scale_fill_manual(values = c("Carboxylic acids and derivatives" = "#1c5ed9", "Glycerophospholipids, glycerolipids and fatty acyls" = "#23a16d", "Sphingolipids" = "#bd81f5", "NA" = "#EAEAEA")) +
  scale_x_continuous(limits = c(-3.5, 3.5))
ggsave(paste0(analysis_path, "biomarker-mofa/weights/factor", i, "genes.png"), p1, width = 8, height = 16, units = 'cm', dpi = 600)

p2 <- 
  d %>%
  group_by(view) %>%
  slice_max(abs(value), n = 25) %>% 
  filter(view == "Molecules") %>%

ggplot(aes(x = value, y = reorder(feature, abs(value)))) +
  geom_col(width = 0.5, fill = "lightgrey") +
  geom_point(aes(fill = Class), size = 3, shape = 21) +
  theme +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 12),
        axis.text.y = element_text(size = 12)) +
  labs(y = "Feature",
       x = "Weight") +
  facet_grid(Cluster~view, scales = "free", space = "free") +
  scale_fill_manual(values = c("Carboxylic acids and derivatives" = "#1c5ed9", "Glycerophospholipids, glycerolipids and fatty acyls" = "#23a16d", "Sphingolipids" = "#bd81f5", "NA" = "#EAEAEA")) +
  scale_x_continuous(limits = c(-3.5, 3.5))
ggsave(paste0(analysis_path, "biomarker-mofa/weights/factor", i, "mol.png"), p2, width = 10, height = 16, units = 'cm', dpi = 600)

# legend
p <- ggarrange(p2, p1, common.legend = TRUE, legend = "bottom", align = "v")
p <- annotate_figure(p, top = text_grob("Disease-associated Latent Factor features", face = "bold", size = 12))
ggsave(paste0(analysis_path, "biomarker-mofa/weights/factor", i, "lgd.png"), p, width = 18, height = 17, units = 'cm', dpi = 600)
```

```{r}
p <-   
  
  ggplot(df, aes(x = value, y = reorder(feature, value))) +
    geom_point(aes(size = colour, colour = colour) ) +
    geom_text_repel(aes(label = labels), min.segment.length = 0.2, segment.linetype	= "dashed", segment.size = 0.2, segment.color	= "grey",
                    size = 2, max.overlaps = 45) +
    theme +
    theme(legend.position = "none",
          plot.title = element_text(size = 10),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank()) +
    labs(title = paste("Disease factor features"),
         y = "Rank",
         x = "Weight")  +
  facet_grid(view~.) +
  scale_colour_manual(values = c("grey", "#023e8a")) +
  scale_size_manual(values = c(0.1, 0.8)) +
  scale_x_continuous(limits = c(-1, 1.2)) 
ggsave(paste0(analysis_path, "biomarker-mofa/weights/factor-", i, "-weights.png"), p, width = 10, height = 16, units = 'cm', dpi = 600)
```


