---
title: "factors-variation"
author: "Giulia"
date: '2024-08-08'
output: html_document
---

# Adonis bacteria

```{r}
bact_adonis <- list()
c_list <- list()
d_list <- list()

c <- c("Recipient", "Antibiotics", "Imm.suppr", "Donor")
c_list[[1]] <- 'Transplant_indication + Months + Age + Gender'  
c_list[[2]] <- 'Total_ant_num + blactamother + macrolide + sulfonamide.benzylpyrimidine'
c_list[[3]] <- 'Tacrolimus_dosage + Cyclosporin_dosage + Mycophenolate_dosage + Prednisolone_dosage + Azathioprine_dosage'
c_list[[4]] <- 'GIT_ischemic_time + Donor_age + Donor_smoking + Donor_gender'

d <- c("All samples", "<6 months", ">6 months")
d_list[[1]] <- bact.logcss
d_list[[2]] <- phyloseq::subset_samples(bact.logcss, Days_interval == "<6 months")
d_list[[3]] <- phyloseq::subset_samples(bact.logcss, Days_interval == ">6 months")

for (e in 1:length(d)){
  
    for (i in 1:length(c)){
      
    dist <- 'wunifrac'
    
    # Subset datasets 
    param <- c(unlist(strsplit(c_list[[i]], split = " "))[c(TRUE, FALSE)])
    meta <- data.frame(sample_data(d_list[[e]]), check.names = FALSE)[,param] 
    data <- phyloseq::subset_samples(d_list[[e]], Patient_days %in% rownames(meta))
    
    temp_list <- list()
    temp_list[[i]] <- c_list[[i]]
    
      #if (e == 2 & i == 3 | e == 3 & i == 2 | e == 1 & i == 5 | e == 2 & i == 5){
        # Remove columns if all the same and update model
        remove <- list()
        for (a in 1:length(colnames(meta))){
          if (meta[, a] %>% na.omit() %>% unique() %>% length() == 1){
              remove[[a]] <- colnames(meta)[a]}
        }
          
        if (length(unlist(remove)) >= 1){
          for (b in 1:length(unlist(remove))){
            meta <- meta %>% dplyr::select(!c(unlist(remove)[b]))
            temp_list[[i]] <- gsub(as.character(paste0(unlist(remove)[b]), " + "), "", temp_list[[i]], fixed = TRUE) 
          }
        }
      #}
    
      bact_adonis[[as.character(d[e])]][[as.character(c[i])]][["samples"]] <- data.frame("Samples" = dim(otu_table(data))[2],
                                                                                         "Model" = as.character(c[i]))
    
    set.seed(2)
    bact_adonis[[as.character(d[e])]][[as.character(c[i])]][["adonis_all"]] <- adonis2(formula = as.formula(paste('phyloseq::distance(data, method = dist) ~', temp_list[[i]])), 
                      data = meta, 
                      distance = dist, 
                      dfun = vegdist, 
                      permutations = 999,
                      na.action = na.omit,
                      parallel = 6)
    bact_adonis[[as.character(d[e])]][[as.character(c[i])]][["adonis_all_df"]] <- data.frame(bact_adonis[[as.character(d[e])]][[as.character(c[i])]][["adonis_all"]]) %>%
      rownames_to_column(., "Factor") %>%
      mutate(Factor = gsub("_", " ", Factor)) %>%
      mutate(Factor = gsub(" cat| combined| dosage| num|GIT | split", "", Factor)) %>%
      mutate(Factor = gsub("Age", "Recipient age", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("Gender", "Recipient sex", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("gender", "sex", Factor)) %>%
      mutate(Factor = gsub("FEV1 pre percentage comb", "FEV1% predicted", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("\\+ ", "", Factor)) %>%
      mutate(Factor = gsub("e\\.", "e-", Factor)) %>%
      mutate(Factor = gsub(" ant", " antibiotics", Factor)) %>%
      mutate(Factor = gsub(" imm", " immunosuppressants", Factor)) %>%
      mutate(Factor = str_to_sentence(Factor))  %>%
      mutate(Factor = gsub("Months", "Months post-transplant", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("Bal", "BAL", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("Blactamother", "B-lactams & miscellaneous", Factor, fixed = TRUE)) %>%
      rename(pval = Pr..F.) %>%
      na.omit() %>%
      mutate(Model = c[i])
    
    }
    
    df <- bact_adonis[[as.character(d[e])]]$Recipient$adonis_all_df %>%
      full_join(bact_adonis[[as.character(d[e])]]$Donor$adonis_all_df) %>%
      full_join(bact_adonis[[as.character(d[e])]]$Antibiotics$adonis_all_df) %>%
      full_join(bact_adonis[[as.character(d[e])]]$Imm.suppr$adonis_all_df) %>%
      mutate(Model = factor(Model, levels = c("Recipient", "Donor", "Antibiotics", "Imm.suppr")),
             Significance = case_when(pval >= 0.05 ~ "",
                                      pval < 0.05 & pval >= 0.01 ~ "*",
                                      pval < 0.01 & pval >= 0.001 ~ "**",
                                      pval < 0.001 & pval >= 0.0001 ~ "***",
                                      pval < 0.0001 ~ "****")) %>%
      mutate(Dataset = d[e])
    bact_adonis[[as.character(d[e])]][["adonis_plot"]] <- df
    
    ## Samples summary
    samples_df <- rbind(bact_adonis[[as.character(d[e])]]$Recipient$samples, 
                        bact_adonis[[as.character(d[e])]]$Donor$samples,
                        bact_adonis[[as.character(d[e])]]$Antibiotics$samples, 
                        bact_adonis[[as.character(d[e])]]$Imm.suppr$samples) %>%
      mutate(Model = factor(Model, levels = c("Recipient", "Donor", "Antibiotics", "Imm.suppr")),
             Dataset = d[e])
    bact_adonis[[as.character(d[e])]][["samples_df"]] <- samples_df

}

df <- bact_adonis$`All samples`$adonis_plot %>%
      full_join(bact_adonis$`<6 months`$adonis_plot) %>%
      full_join(bact_adonis$`>6 months`$adonis_plot) %>%
  
      full_join(rbind(bact_adonis$`All samples`$samples_df, 
                      bact_adonis$`<6 months`$samples_df,
                      bact_adonis$`>6 months`$samples_df
                )) %>%
      mutate(Dataset_samples = paste0(Dataset, " n = ", Samples),
             Dataset = factor(Dataset, levels = c("All samples", "<6 months", ">6 months"))) %>% 
  arrange(Dataset) %>%
  mutate(Dataset_samples = factor(Dataset_samples, levels = unique(Dataset_samples)))

    p <- 
      
    ggplot(df, aes(x = 100*R2, y = reorder(Factor, 100*R2))) +
      geom_col(fill = "#197278", alpha = 0.5) +
      geom_text(aes(label = paste0(pval, Significance)), hjust = 0, size = 3) +
      theme +
      theme(strip.text.x = element_text(size = 8)) +
      labs(title = "Factors explaining bacterial variation",
           x = "R2% explained",
           y = "") +
      scale_x_continuous(limits = c(0, max(df$R2)*100+4)) +
      facet_grid(Model~Dataset_samples, scales = "free_y", space = "free_y")
    ggsave("factors-variation/adonis/bacteria/bact-adonis-all-datasets-6m.pdf", p, width = 18, height = 12, units = 'cm')
```

```{r}
## Get model factors for each dataset for dbrda
model_for_dbrda <- df %>% filter(pval < 0.05) %>% group_by(Dataset) %>% arrange(desc(R2)) %>% dplyr::select(Dataset, Factor) %>% ungroup() %>% pivot_wider(names_from = Dataset, values_from = Factor) %>% as.list()

unlist(model_for_dbrda$`All samples`) 
unlist(model_for_dbrda$`<6`)
unlist(model_for_dbrda$`>6`) 

model_for_dbrda <- list()
model_for_dbrda[[1]] <- c("Transplant_indication + Months + Total_ant_num + blactamother + Prednisolone_dosage + GIT_ischemic_time + Tacrolimus_dosage") 
model_for_dbrda[[2]] <- c("Transplant_indication + Months + Total_ant_num + blactamother + Prednisolone_dosage + GIT_ischemic_time") 
model_for_dbrda[[3]] <- c("Transplant_indication") 
```

```{r}
for (e in 1:length(d)){

# Subset datasets and remove na values or error
param <- c(unlist(strsplit(model_for_dbrda[[e]], split = " "))[c(TRUE, FALSE)])

meta <- as.data.frame(sample_data(d_list[[e]]), check.names = FALSE)[ , param ] %>% data.frame() %>% na.omit()
data <- phyloseq::subset_samples(d_list[[e]], Patient_days %in% rownames(meta))

bact_adonis[[as.character(d[e])]][["dbrda_samples"]] <- dim(otu_table(data))[2]
saveRDS(data, paste0("factors-variation/adonis/bacteria/cluster/bact-data-", e,  ".rds"))
    
# Based on significant features above
# Metadata selection on constrained ordination (db-rda) and ordi2step
## Lower scope with just intercept = null model
dist <- 'wunifrac'
bact.md <- dbrda(formula = phyloseq::distance(data, method = dist) ~ 1,
                 data = meta, 
                 parallel = 6)

## Upper scope with full model
bact.md.all <- dbrda(formula = as.formula(paste('phyloseq::distance(data, method = dist) ~', model_for_dbrda[[e]])), 
                  data = meta, 
                  parallel = 6)

# Test global model for significance before dbrda ordistep
bact_adonis[[as.character(d[e])]][["dbrda_global_anova_check"]] <- anova(bact.md.all)
}

bact_adonis$`All samples`$dbrda_global_anova_check
bact_adonis$`<6`$dbrda_global_anova_check
bact_adonis$`>6`$dbrda_global_anova_check
```

```{r}
## Cluster
# smux new-session --time=04:00:00 -J dbrda --mem 16GB --ntasks 8

# module load R/4.1.0-mkl
# see R script
```

```{r}
for (e in 1:length(d)){
  
bact.md.sel <- readRDS(paste0("factors-variation/cluster/bacteria/bact-rda-sel-", e, ".rds"))

# Cluster output
bact_adonis[[as.character(d[e])]][["dbrda_output"]] <- bact.md.sel 

# Summary of each factor incrementing to the total
bact_adonis[[as.character(d[e])]][["dbrda_anova"]] <- bact.md.sel$anova 
bact_adonis[[as.character(d[e])]][["dbrda_anova_df"]] <- data.frame(bact_adonis[[as.character(d[e])]][["dbrda_anova"]]) %>%
  rownames_to_column(., "Factor") %>%
  mutate(Factor = gsub("\\+ ", "", Factor)) %>%
  mutate(Factor = gsub("e\\.", "e-", Factor)) %>%
  mutate(Factor = gsub("_ant", " antibiotics", Factor)) %>%
  mutate(Factor = gsub("_imm", " immunosuppressants", Factor)) %>%
  mutate(Factor = gsub("_", " ", Factor)) %>%
  mutate(Factor = str_to_sentence(Factor))  %>%
  mutate(Factor = gsub("s.c", "s/C", Factor, fixed = TRUE)) %>%
  mutate(Factor = gsub("Blactamother", "B-lactams & miscellaneous", Factor, fixed = TRUE)) %>%
  rename(pval = Pr..F.) %>%
  mutate(Dataset = d[e])

# Total model significance
bact_adonis[[as.character(d[e])]][["dbrda_global_anova"]] <- anova(bact.md.sel) # total model significance
bact_adonis[[as.character(d[e])]][["dbrda_global_anova_df"]] <- data.frame(bact_adonis[[as.character(d[e])]][["dbrda_global_anova"]]) %>% 
  rownames_to_column(., "Factor") %>%
  rename(pval = Pr..F.) %>%
  na.omit() %>%
  mutate(Dataset = d[e])
bact_adonis[[as.character(d[e])]][["ordistep_adjR2"]] <- data.frame("Dataset" = d[e], 
                                                                    "Factor" = "Model",
                                                                    "R2.adj" = RsquareAdj(bact.md.sel)$adj.r.squared) # R squared
}

df <- bact_adonis$`All samples`$dbrda_anova_df[, c("Factor", "R2.adj", "pval", "Dataset")] %>%
      full_join(bact_adonis$`<6`$dbrda_anova_df[, c("Factor", "R2.adj", "pval", "Dataset")]) %>%
      full_join(bact_adonis$`>6`$dbrda_anova_df[, c("Factor", "R2.adj", "pval", "Dataset")])
```

```{r}
## Get significant factors chosen by dbrda
model_sel <- df %>% filter(pval < 0.05) %>% group_by(Dataset) %>% dplyr::select(Dataset, Factor) %>% ungroup() %>% pivot_wider(names_from = Dataset, values_from = Factor) %>% as.list()
model_sel <- list()
model_sel[[1]] <- c("Transplant_indication + Tacrolimus_dosage + Total_ant_cat + blactamother + macrolide")
model_sel[[2]] <- c("Total_ant_cat + Days + Transplant_indication") 
model_sel[[3]] <- c("Transplant_indication + macrolide") 

for (e in 1:3){

# Subset datasets and remove na values or error
param <- c(unlist(strsplit(model_sel[[e]], split = " "))[c(TRUE, FALSE)])
meta <- data.frame(sample_data(d_list[[e]]), check.names = FALSE)[ , param ] #%>% na.omit()
data <- phyloseq::subset_samples(d_list[[e]], Patient_days %in% rownames(meta))

bact_adonis[[as.character(d[e])]][["adonis_after_dbrda_samples"]] <- data.frame("Samples" = dim(otu_table(data))[2],
                                                                                         "Dataset" = as.character(d[e]))

set.seed(2)
bact_adonis[[as.character(d[e])]][["adonis_sel"]] <- adonis2(formula = as.formula(paste('phyloseq::distance(data, method = dist) ~', model_sel[[e]])), 
                  data = data.frame(sample_data(data)), 
                  distance = dist, 
                  dfun = vegdist, 
                  na.action = na.omit,
                  permutations = 999,
                  parallel = 6)
bact_adonis[[as.character(d[e])]][["adonis_sel_df"]] <- data.frame(bact_adonis[[as.character(d[e])]][["adonis_sel"]]) %>%
  rownames_to_column(., "Factor") %>%
      mutate(Factor = gsub("_", " ", Factor)) %>%
      mutate(Factor = gsub("GIT ", "", Factor)) %>%
      mutate(Factor = gsub(" cat| combined| dosage", "", Factor)) %>%
      mutate(Factor = gsub("\\+ ", "", Factor)) %>%
      mutate(Factor = gsub("e\\.", "e-", Factor)) %>%
      mutate(Factor = gsub(" ant", " antibiotics", Factor)) %>%
      mutate(Factor = str_to_sentence(Factor))  %>%
      mutate(Factor = gsub("Days", "Days post-transplant", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("Bal", "BAL", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("Blactamother", "B-lactams & miscellaneous", Factor, fixed = TRUE)) %>%

  rename(pval = Pr..F.) %>%
  na.omit() %>%
  mutate(Dataset = d[e])
}

sel_df <- bact_adonis$`All samples`$adonis_sel_df[, c("Factor", "R2", "pval", "Dataset")] %>%
      full_join(bact_adonis$`<6`$adonis_sel_df[, c("Factor", "R2", "pval", "Dataset")]) %>%
      full_join(bact_adonis$`>6`$adonis_sel_df[, c("Factor", "R2", "pval", "Dataset")]) 

tot_sig <- bact_adonis$`All samples`$dbrda_global_anova_df[, c("Factor", "pval", "Dataset")] %>%
      full_join(bact_adonis$`<6`$dbrda_global_anova_df[, c("Factor", "pval", "Dataset")]) %>%
      full_join(bact_adonis$`>6`$dbrda_global_anova_df[, c("Factor", "pval", "Dataset")])
  
r2_adj <- bact_adonis$`All samples`$ordistep_adjR2 %>%
      full_join(bact_adonis$`<6`$ordistep_adjR2) %>%
      full_join(bact_adonis$`>6`$ordistep_adjR2) %>%
  rename(R2 = R2.adj)

samples_df <- rbind(bact_adonis$`All samples`$adonis_after_dbrda_samples, 
                        bact_adonis$`<6`$adonis_after_dbrda_samples,
                        bact_adonis$`>6`$adonis_after_dbrda_samples
                        ) 

tot_sig_df <- tot_sig %>% full_join(r2_adj) %>% full_join(sel_df) %>% full_join(samples_df) %>%
        mutate(Dataset_samples = paste0(Dataset, " n = ", Samples),
             Dataset = factor(Dataset, levels = c("All samples", "<6", ">6"))) %>% 
        arrange(Dataset) %>%
        mutate(Dataset_samples = factor(Dataset_samples, levels = unique(Dataset_samples)),
               Significance = case_when(pval >= 0.05 ~ "",
                                      pval < 0.05 & pval >= 0.01 ~ "*",
                                      pval < 0.01 & pval >= 0.001 ~ "**",
                                      pval < 0.001 & pval >= 0.0001 ~ "***",
                                      pval < 0.0001 ~ "****")) 

p <- 
      
ggplot(tot_sig_df, aes(x = 100*R2, y = reorder(Factor, 100*R2))) +
      geom_col(fill = "#197278", alpha = 0.5) +
      geom_text(aes(label = paste0(pval, Significance)), hjust = 0, size = 3) +
      theme +
      theme(strip.text = element_text(size = 8)) +
      labs(title = "Factors explaining bacterial variation (dbRDA)",
           x = "R2% explained",
           y = "") +
      scale_x_continuous(limits = c(0, max(tot_sig_df$R2)*100+7)) +
      facet_grid(~Dataset_samples, scales = "free_y", space = "free_y")
    
ggsave(paste0("factors-variation/adonis/bacteria/bact-dbrda-all.pdf"), p, width = 16, height = 7, units = 'cm')
```

The criteria for including the variable is based on both significance of the newly selected variables, and the comparison of adjusted variation (R2adj) explained by the selected variables to R2adj explained by the global model (with all variables); if the new variable is not significant or the R2adj of the model including this new variable would exceed the R2adj of the global model, the selection will be stopped.


# Total antibiotics and ischemic time
## PCoA

```{r}
#Total ant
data <- phyloseq::subset_samples(bact.logcss, Days_interval == "<6 months") 
d <- "wunifrac"

a <- data.frame(adonis2(formula = as.formula("phyloseq::distance(data, method = dist) ~ Months+Transplant_indication+Total_ant_num+GIT_ischemic_time+Record.ID"), 
                    data = data.frame(sample_data(data)), 
                    distance = d, 
                    dfun = vegdist, 
                    na.action = na.omit,
                    permutations = 999,
                    parallel = 6))

annotation <- paste(paste("SumOfSqs =", round(a["Total_ant_num",]$SumOfSqs, 3)),
              paste("R2 =", round(a["Total_ant_num",]$R2, 3)),
              paste("p =", round(a["Total_ant_num",]$Pr..F., 3)), sep = " ; " )

ord <- ordinate(data, method="PCoA", distance="unifrac", weighted=TRUE)
d <- plot_ordination(data, ord)

sample_data(data)$Total_ant_num <- as.factor(sample_data(data)$Total_ant_num)

p <-

plot_ordination(data, ord) + 
  stat_ellipse(aes(fill = Total_ant_num, colour = Total_ant_num), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) + 
  geom_point(aes(fill = Total_ant_num), shape = 21, size = 2) +
  theme +
  labs(title = "Bacterial ordination (<6 months)",
       caption = annotation,
       colour = "Antibiotics",
       fill = "Antibiotics",
       x = gsub("Axis.1", "PCoA1", d$labels$x),
       y = gsub("Axis.2", "PCoA2", d$labels$y)) +
  scale_colour_manual(values = c("0" = "lightgrey", "1" = "grey", "2" = "#5C6378", "3" = "#BEE5BF", "4" = "#a9e8ab", "5" = "#76de78")) +
  scale_fill_manual(values = c("0" = "lightgrey", "1" = "grey", "2" = "#5C6378", "3" = "#BEE5BF", "4" = "#a9e8ab", "5" = "#76de78"))

ggsave("factors-variation/total-antibiotics/bact-pcoa-tot-ant-<6months.pdf", p, width = 10, height = 7, units = 'cm')
```

```{r}
# blactams
data <- phyloseq::subset_samples(bact.logcss, Days_interval == "<6 months") 
d <- "wunifrac"

a <- data.frame(adonis2(formula = as.formula("phyloseq::distance(data, method = dist) ~ Months+Transplant_indication+blactamother+GIT_ischemic_time+Record.ID"), 
                    data = data.frame(sample_data(data)), 
                    distance = d, 
                    dfun = vegdist, 
                    na.action = na.omit,
                    permutations = 999,
                    parallel = 6))

annotation <- paste(paste("SumOfSqs =", round(a["blactamother",]$SumOfSqs, 3)),
              paste("R2 =", round(a["blactamother",]$R2, 3)),
              paste("p =", round(a["blactamother",]$Pr..F., 3)), sep = " ; " )

ord <- ordinate(data, method="PCoA", distance="unifrac", weighted=TRUE)
d <- plot_ordination(data, ord)

sample_data(data)$blactamother <- as.factor(sample_data(data)$blactamother)

p <-

plot_ordination(data, ord) + 
  stat_ellipse(aes(fill = blactamother, colour = blactamother), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) + 
  geom_point(aes(fill = blactamother), shape = 21, size = 2) +
  theme +
  labs(title = "Bacterial ordination (<6 months)",
       caption = annotation,
       colour = "Beta lactams antibiotics",
       fill = "Beta lactams antibiotics",
       x = gsub("Axis.1", "PCoA1", d$labels$x),
       y = gsub("Axis.2", "PCoA2", d$labels$y)) +
  scale_colour_manual(values = c("0" = "lightgrey", "1" = "grey", "2" = "#5C6378", "3" = "#BEE5BF", "4" = "#a9e8ab", "5" = "#76de78")) +
  scale_fill_manual(values = c("0" = "lightgrey", "1" = "grey", "2" = "#5C6378", "3" = "#BEE5BF", "4" = "#a9e8ab", "5" = "#76de78"))

ggsave("factors-variation/total-antibiotics/bact-pcoa-blactams-<6months.pdf", p, width = 10, height = 7, units = 'cm')
```


```{r}
# Ischemic time
data <- phyloseq::subset_samples(bact.logcss, Days_interval == "<6 months" & !is.na(GIT_ischemic_time)) 
d <- "wunifrac"

a <- data.frame(adonis2(formula = as.formula("phyloseq::distance(data, method = dist) ~ Months+Transplant_indication+Total_ant_num+GIT_ischemic_time+Record.ID"), 
                    data = data.frame(sample_data(data)), 
                    distance = d, 
                    dfun = vegdist, 
                    na.action = na.omit,
                    permutations = 999,
                    parallel = 6))

annotation <- paste(paste("SumOfSqs =", round(a["GIT_ischemic_time",]$SumOfSqs, 3)),
              paste("R2 =", round(a["GIT_ischemic_time",]$R2, 3)),
              paste("p =", round(a["GIT_ischemic_time",]$Pr..F., 3)), sep = " ; " )

ord <- ordinate(data, method="PCoA", distance="unifrac", weighted=TRUE)
d <- plot_ordination(data, ord)

p <-

plot_ordination(data, ord) + 
  geom_point(aes(fill = GIT_ischemic_time), shape = 21, size = 2) +
  #annotate(geom = "text", x = -0.45, y = 0.2, label = annotation, size = 2, hjust = 0, vjust = 1) +
  theme +
  theme(legend.position = "right") +
  labs(title = "Bacterial ordination (<6 months)",
       caption = annotation,
       colour = "Ischemic time",
       fill = "Ischemic time",
       x = gsub("Axis.1", "PCoA1", d$labels$x),
       y = gsub("Axis.2", "PCoA2", d$labels$y)) +
  scale_fill_gradientn(colours = c("white", "grey", "#659ffc", "#3a86ff"))

ggsave("factors-variation/ischemic-time/bact-pcoa-ischemic-time<6.pdf", p, width = 11, height = 7, units = 'cm')
```

## Limma

```{r}
metadata <- data.frame(sample_data(bact.logcss)) %>% filter(!is.na(GIT_ischemic_time) & Days_interval == "<6 months", Record.ID != 40) # outlier
input_data <- data.frame(otu_table(bact.logcss), check.names = FALSE)[, metadata$Patient_days]

de_matrix <- model.matrix(~Months + Transplant_indication + Total_ant_cat + GIT_ischemic_time, metadata) 
corfit <- duplicateCorrelation(input_data, design = de_matrix, block = metadata$Record.ID)
fit <- lmFit(input_data, design = de_matrix, block = metadata$Record.ID, correlation = corfit$consensus)
efit <- eBayes(fit)
summary(decideTests(efit, lfc = 0)) 

# Total antibiotics
topTable(efit, coef = "Total_ant_cat3-5", number = Inf, adjust = 'BH') %>%
  as.data.frame() %>% 
  mutate(Direction = case_when(logFC > 0 ~ "Increased", logFC < 0 ~ "Decreased")) %>% 
  rownames_to_column("ASV") 
```

```{r}
# Ischemic time
m <- input_data %>% 
  filter(rownames(.) %in% isch_res$ASV[1]) %>% 
  t() %>% as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  pivot_longer(!Patient_days, names_to = "ASV", values_to = "Abundance") %>%
  left_join(metadata[, c("Patient_days", "Record.ID", "Months", "Total_ant_num", "GIT_ischemic_time")]) %>%
  relocate(Record.ID, Months, Patient_days, Total_ant_num, GIT_ischemic_time)

annotation <- paste(paste("LogFC", round(isch_res$logFC, 4)), paste("padj", round(isch_res$adj.P.Val, 4)), sep = " ; ")
  
p <-
  
ggplot(m, aes(x = GIT_ischemic_time, y = Abundance)) +
  geom_point(aes(fill = GIT_ischemic_time), shape = 21) +
  geom_smooth(method = "lm", formula = y ~ ns(x, 2), se = FALSE, linewidth = 0.3) +
  theme +
  theme(legend.position = "none") +
  labs(x = "Ischemic time", 
       y = "LogCSS Abundance", 
       caption = annotation,
       title = unique(isch_res$ASV[1])) +
    scale_fill_gradientn(colours = c("white", "grey", "#659ffc", "#3a86ff"))

ggsave("factors-variation/ischemic-time/ischemic-time-pseudomonas.pdf", p, width = 8, height = 7, units = 'cm')
```

```{r}
# Total antibiotics
m <- input_data %>% 
  filter(rownames(.) %in% ant_res$ASV) %>% 
  t() %>% as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  pivot_longer(!Patient_days, names_to = "ASV", values_to = "Abundance") %>%
  left_join(metadata[, c("Patient_days", "Record.ID", "Months", "Total_ant_num", "GIT_ischemic_time")]) %>%
  relocate(Record.ID, Months, Patient_days, Total_ant_num, GIT_ischemic_time)

annotation <- paste(paste("LogFC", round(ant_res$logFC, 4)), paste("padj", round(ant_res$adj.P.Val, 4)), sep = " ; ")
  
p <-
  
ggplot(m, aes(x = Total_ant_num, y = Abundance)) +
  geom_boxplot(aes(fill = Total_ant_num), outlier.shape = NA, alpha = 0.3) +
  geom_jitter(aes(fill = Total_ant_num), shape = 21, width = 0.1) +
  theme +
  theme(legend.position = "none") +
  labs(x = "Total antibiotics", 
       y = "LogCSS Abundance", 
       caption = annotation,
       title = unique(ant_res$ASV)) +
  scale_fill_manual(values = c("0" = "lightgrey", "1-2" = "#5C6378", "3-5" = "#BEE5BF"))

ggsave("factors-variation/total-antibiotics/tot-ant.pdf", p, width = 8, height = 7, units = 'cm')
```

# Tx indication
## PCoA

```{r}
d <- "wunifrac"

a <- data.frame(adonis2(formula = as.formula("phyloseq::distance(bact.logcss, method = dist) ~ Months+Transplant_indication+Total_ant_num+GIT_ischemic_time+Record.ID"), 
                    data = data.frame(sample_data(bact.logcss)), 
                    distance = d, 
                    dfun = vegdist, 
                    na.action = na.omit,
                    permutations = 999,
                    parallel = 6))

annotation <- paste(paste("SumOfSqs =", round(a["Transplant_indication",]$SumOfSqs, 3)),
              paste("R2 =", round(a["Transplant_indication",]$R2, 3)),
              paste("p =", round(a["Transplant_indication",]$Pr..F., 3)), sep = " ; " )

ord <- ordinate(bact.logcss, method="PCoA", distance="unifrac", weighted=TRUE)
d <- plot_ordination(bact.logcss, ord)

p <-

plot_ordination(bact.logcss, ord) + 
  stat_ellipse(aes(fill = Transplant_indication, colour = Transplant_indication), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) + 
  geom_point(aes(fill = Transplant_indication), shape = 21, size = 2) +
  theme +
  theme(legend.position = "right") +
  labs(title = "Bacterial ordination",
       caption = annotation,
       colour = "Transplant indication",
       fill = "Transplant indication",
       x = gsub("Axis.1", "PCoA1", d$labels$x),
       y = gsub("Axis.2", "PCoA2", d$labels$y)) +
  plot_fill(Transplant_indication = TRUE) +
  plot_colours(Transplant_indication = TRUE)

ggsave("factors-variation/tx-indication/bact-pcoa-tx-indication.pdf", p, width = 11, height = 7, units = 'cm')
```

## Shannon

```{r}
comparisons <- list( c("CF/NCFB", "CLAD"), c("CF/NCFB", "ILD"), c("CF/NCFB", "COPD"), c("CF/NCFB", "Other") )

p <-
  
ggplot(data.frame(sample_data(bact.logcss)), aes(x = Transplant_indication, y = Diversity)) +
  geom_boxplot(aes(fill = Transplant_indication), outlier.shape = NA, alpha = 0.3) +
  geom_jitter(aes(fill = Transplant_indication), width = 0.1, shape = 21, size = 2) +
  theme +
  labs(x = "Transplant indication", 
       y = "Shannon Index", 
       fill = "Transplant indication",
       shape = "BAL class",
       title = "Bacterial Diversity") +
    stat_compare_means(label = "p.signif", method = "wilcox.test", comparisons = comparisons) + # Add pairwise comparisons p-value
  scale_y_continuous(limits = c(0, 6.5)) +
  plot_fill(Transplant_indication = TRUE) +
  theme(legend.position = "none")

ggsave("factors-variation/tx-indication/bact-tx-shannon-.pdf", p, width = 10, height = 7, units = 'cm')

wilcox_test(data.frame(sample_data(data)), Diversity ~ Transplant_indication, ref.group = ".all.") 
pairwise_wilcox_test(data.frame(sample_data(data)), Diversity ~ Transplant_indication) 
```

## Limma

```{r}
metadata <- data.frame(sample_data(bact.logcss)) %>% filter(!is.na(GIT_ischemic_time)) 
input_data <- data.frame(otu_table(bact.logcss), check.names = FALSE)[, metadata$Patient_days]
metadata$Transplant_indication <- fct_relevel(metadata$Transplant_indication, "COPD")

de_matrix <- model.matrix(~Months + Transplant_indication + Total_ant_num + GIT_ischemic_time, metadata) 
corfit <- duplicateCorrelation(input_data, design = de_matrix, block = metadata$Record.ID)
fit <- lmFit(input_data, design = de_matrix, block = metadata$Record.ID, correlation = corfit$consensus)
efit <- eBayes(fit)
summary(decideTests(efit, lfc = 0)) 

tx_res <- topTable(efit, coef = "Transplant_indicationCF/NCFB", number = Inf, adjust = 'BH') %>% 
    as.data.frame() %>%
    mutate(Direction = case_when(logFC > 0 ~ "Increased", logFC < 0 ~ "Decreased")) %>% 
    rownames_to_column("ASV") %>% 
  filter(adj.P.Val < 0.05)
```


```{r}
m <- input_data %>% 
  filter(rownames(.) %in% tx_res$ASV) %>% 
  t() %>% as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  pivot_longer(!Patient_days, names_to = "ASV", values_to = "Abundance") %>%
  left_join(metadata[, c("Patient_days", "Record.ID", "Months", "Transplant_indication")]) %>%
  relocate(Record.ID, Months, Patient_days, Transplant_indication)
m$Transplant_indication <- factor(m$Transplant_indication, levels = c("CF/NCFB", "CLAD", "ILD", "COPD", "Other"))

p <-
  
ggplot(m, aes(x = Transplant_indication, y = Abundance)) +
  geom_boxplot(aes(fill = Transplant_indication), outlier.shape = NA, alpha = 0.3) +
  geom_jitter(aes(fill = Transplant_indication), size = 2, shape = 21, width = 0.1) +
  theme +
  theme(legend.position = "none") +
  labs(x = "Transplant indication", 
       y = "LogCSS Abundance", 
       title = unique(tx_res$ASV)) +
  stat_compare_means(label = "p.signif", method = "wilcox.test", comparisons = comparisons) +
  scale_y_continuous(limits = c(-1, 27)) +
  plot_fill(Transplant_indication = TRUE)

ggsave("factors-variation/tx-indication/tx-pseudomonas.pdf", p, width = 10, height = 7, units = 'cm')
```

### Donor sputum

```{r}
donor.pre.sputum <- master.metadata$general_metadata %>%
  filter(Record.ID %in% sample_data(bact.logcss)$Record.ID) %>%
  dplyr::select(Record.ID, Transplant_indication, Donorpositivesputumattx, IfYesListDonorSputumBALGrowth) %>%
  set_colnames(c("Record.ID","Transplant_indication", "Sputum", "Species")) %>%
  mutate(Sputum = case_when(Sputum == "NoDonorpositivesputumattx" ~ "Negative",
                            Sputum != "NoDonorpositivesputumattx" ~ "Positive")) 
donor.pre.sputum$StaphylococcusSpecies <- ifelse(str_detect(donor.pre.sputum$Species, c("Staph|Stapph")), "StaphylococcusSpecies", NA)
donor.pre.sputum$CandidaSpecies <- ifelse(str_detect(donor.pre.sputum$Species, c("Candi")), "CandidaSpecies", NA)
donor.pre.sputum$HaemophilusInfluenza <- ifelse(str_detect(donor.pre.sputum$Species, c("Haemo")), "HaemophilusInfluenza", NA)
donor.pre.sputum$KlebsiellaSpecies <- ifelse(str_detect(donor.pre.sputum$Species, c("Klebsiella")), "KlebsiellaSpecies", NA)
donor.pre.sputum$SerratiaSpecies <- ifelse(str_detect(donor.pre.sputum$Species, c("Serratia")), "SerratiaSpecies", NA)
donor.pre.sputum$EscherichiaColi <- ifelse(str_detect(donor.pre.sputum$Species, c("Escherichia")), "EscherichiaColi", NA)
donor.pre.sputum$Other <- ifelse(str_detect(donor.pre.sputum$Species, c("Citrobacter|enter|Enter|Acineto")), "Other", NA)
donor.pre.sputum <- donor.pre.sputum %>%
  dplyr::select(!Species) %>%
  unite(col = "Species", colnames(.)[4:10], sep = ",", na.rm = TRUE) %>%
  separate_rows(Species, sep = ",") %>%
  mutate(Type = "Donor", Count = 100)

recipient.pre.sputum <- master.metadata$general_metadata %>%
  filter(Record.ID %in% sample_data(bact.logcss)$Record.ID) %>%
  dplyr::select(Record.ID, Transplant_indication, PreTransplantSputumSpecimens, IfYesListGrowth) %>%
  set_colnames(c("Record.ID","Transplant_indication", "Sputum", "Species")) %>%
  mutate(Sputum = case_when(Sputum == "NoPreTransplantSputumSpecimens" ~ "Negative",
                                      Sputum != "NoPreTransplantSputumSpecimens" ~ "Positive")) 
recipient.pre.sputum$PseudomonasSpecies <- ifelse(str_detect(recipient.pre.sputum$Species, c("Pseud|Psued")), "PseudomonasSpecies", NA)
recipient.pre.sputum$AspergillusSpecies <- ifelse(str_detect(recipient.pre.sputum$Species, c("Asper")), "AspergillusSpecies", NA)
recipient.pre.sputum$CandidaSpecies <- ifelse(str_detect(recipient.pre.sputum$Species, c("Candi")), "CandidaSpecies", NA)
recipient.pre.sputum$StaphylococcusSpecies <- ifelse(str_detect(recipient.pre.sputum$Species, c("Staph|Stapph")), "StaphylococcusSpecies", NA)
recipient.pre.sputum$Other <- ifelse(str_detect(recipient.pre.sputum$Species, c("Nocard|Achro")), "Other", NA)
recipient.pre.sputum <- recipient.pre.sputum %>%
  dplyr::select(!Species) %>%
  unite(col = "Species", colnames(.)[4:8], sep = ",", na.rm = TRUE) %>%
  separate_rows(Species, sep = ",") %>%
  mutate(Type = "Recipient", Count = 100)

pre.sputum <- rbind(donor.pre.sputum, recipient.pre.sputum)
pre.sputum$Species <- ifelse(pre.sputum$Species == "" & pre.sputum$Sputum == "Positive", "Undetermined", ifelse(pre.sputum$Species == "" & pre.sputum$Sputum == "Negative", "Negative", pre.sputum$Species))
pre.sputum$Species <- factor(pre.sputum$Species, levels = c("StaphylococcusSpecies", "HaemophilusInfluenza", "PseudomonasSpecies", "EscherichiaColi", "CandidaSpecies", "AspergillusSpecies", "SerratiaSpecies", "KlebsiellaSpecies", "Other", "Undetermined", "Negative"))
```

```{r}
p <- 
  
  pre.sputum %>%
  filter(Transplant_indication %in% c("CF/NCFB", "CLAD")) %>%
  ggplot(aes(x = as.character(Record.ID), y = Count)) +
  geom_bar(aes(fill = Species), stat = 'identity', position = 'fill', alpha = 0.8) +
  labs(title = "Sputum composition at transplant",
       x = "Patient",
       y = "Percentage") +
  theme +
  theme(legend.position = "right",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 8), 
        axis.text.x = element_blank()) +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Type~Transplant_indication, scales = "free_x", space = "free_x") +
  scale_fill_manual(values = c( "#4c0578", "#150578", "#EA9010", "#BEE5BF", "#197278", "#5C6378", "lightgrey", "darkgrey"))

ggsave(paste0("factors-variation/tx-indication/bact-tx-sputum-.pdf"), p, width = 16, height = 7, units = 'cm')
```



# -------------------------------

### Microbiology bacterial culture

```{r}

#Need tor ewrite
micro.bact <- micro.bact %>%
  unite(col = "Species", colnames(.)[4:12], sep = ",", na.rm = TRUE) %>%
  separate_rows(Species, sep = ",") %>%
  mutate(Species = factor(Species, levels = c("StaphylococcusAureusMRSA", "StenotrophomonasMaltophilia", "PseudomonasSpecies", "EscherichiaColi",  "KlebsiellaPneumoniae", "SerratiaMarcescens",  "EnterobacterAerogenes", "Negative")))
  filter(!grepl("No|Unavailable", Species)) %>%
  left_join(master.metadata$general_metadata[, c("Record.ID", "Transplant_indication")]) %>%
  mutate(Count = 100,
         Patient_days = paste0(Record.ID, "_", Days),
         Days2 = cut(Days, breaks = c(-1, 42, 2000),
                          labels = c("<42", ">42")))
  
  micro_bact_metadata$Species <- ifelse(micro_bact_metadata$BronchoalveolarLavageCulture == "Negative" & micro_bact_metadata$Species == "NoNotGrowth", "Negative", micro_bact_metadata$Species)
micro_bact_metadata$Species <- ifelse(micro_bact_metadata$BronchoalveolarLavageCulture == "Unavailable" & micro_bact_metadata$Species == "NoNotGrowth", "Unavailable", micro_bact_metadata$Species)

name <- "micro-bact-cul"
p <- 
  
  micro.bact %>%
  ggplot(aes(x = as.character(Record.ID), y = Count, fill = Species)) +
  geom_bar(stat = 'identity', position = 'fill', alpha = 0.8) +
  labs(title = "BAL cultures bacterial composition",
       x = "Patient",
       y = "Percentage") +
  theme +
  theme(axis.text.x = element_blank()) +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Days2~Transplant_indication, scales = "free_x", space = "free_x") +
  scale_fill_manual(values = c(tax.colours[1:5], "darkgrey"))

ggsave(paste0(paste0("factors-variation/", Sys.Date(), "_b_", paste(fixed_effects, paste0(random_effects, collapse = "+"), sep = "_")), "/", name, ".pdf"), p, width = 26, height = 10, units = 'cm')


micro.bact %>%
  group_by(Transplant_indication, Days_post_transplant, Species) %>%
  count() %>%
  
  ggplot(aes(x="", y=n, fill=Species)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +
  facet_wrap(Transplant_indication~Days_post_transplant)
```

### Comparison of bal culture results with BAL composition

```{r}
suppressMessages(bact.logcss.df <- bact.logcss %>%
  phyloseq::tax_glom(taxrank = 'Genus', NArm = T) %>%
  microbiome::transform(transform = 'compositional', target = 'OTU') %>% 
  phyloseq::psmelt())

name <- "micro-bact-bal"
p <- 
  
  data.frame(psmelt(data)) %>%
  filter(Patient_days %in% micro.bact$Patient_days) %>% # matching samples
  
  ggplot(aes(x = as.character(Record.ID), y = Abundance, fill = Genus)) +
  geom_bar(stat = 'identity', position = 'fill') +
  labs(title = "BAL bacterial composition",
       x = "Patient",
       y = "Percentage") +
  theme +
  theme(axis.text.x = element_blank()) +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Days_post_transplant~Transplant_indication, scales = "free_x", space = "free_x") +
  scale_fill_manual(values = c("#388659", "#FF6D00", "#C6EBBE", "#0072BB", "#ECB0E1", "darkgrey", "lightgrey"))

ggsave(paste0(paste0("factors-variation/", Sys.Date(), "_b_", paste(fixed_effects, paste0(random_effects, collapse = "+"), sep = "_")), "/", name, ".pdf"), p, width = 26, height = 10, units = 'cm')
```


#### Transplant indication

```{r}
## Common hits
for (i in 1:dim(bact_maaslin[[id]]$maaslin_out)[1]){
    
  var_select <- bact_maaslin[[id]]$maaslin_out$Feature[i]
    
p <- ggplot(bact_maaslin[[id]]$var_counts %>% filter(ASV == var_select), aes(x = Transplant_indication, y = Abundance)) + 
        geom_boxplot(aes(fill = Transplant_indication), outlier.shape = NA, alpha = 0.3) +
        geom_jitter(aes(colour = Transplant_indication), width = 0.1) +
        theme +
        labs(title = var_select, 
             
             colour = "Transplant indication",
             fill = "Transplant indication",
             x = "Transplant indication", 
             y = "LogCSS abundance") +
  plot_colours(Transplant_indication = TRUE) +
  plot_fill(Transplant_indication = TRUE) +
    theme(legend.position = "none", legend.justification = c("left"))
  
ggsave(paste0(paste0("factors-variation/", Sys.Date(), "_b_", paste(fixed_effects, paste0(random_effects, collapse = "+"), sep = "_")), "/", var_select, ".pdf"), p, width = 12, height = 8, units = 'cm')
  }
```

```{r}
## Across transplants
for (i in 1:dim(bact_maaslin[[id]]$maaslin_out)[1]){
    
  var_select <- bact_maaslin$`f_Transplant_indication_r_Record.ID+Days`$maaslin_out$Feature[i]
    
p <- ggplot(bact_maaslin[[id]]$var_counts %>% filter(ASV == var_select, First_transplant_indication != ""), aes(x = First_transplant_indication, y = Abundance)) + 
        geom_boxplot(aes(fill = First_transplant_indication), outlier.shape = NA, alpha = 0.3) +
        geom_jitter(aes(colour = First_transplant_indication), width = 0.1) +
        theme +
        labs(title = paste0(var_select, " in re-transplanted patients"), 
             x = "Indication for first transplant", 
             y = "LogCSS abundance") +
  scale_colour_manual(values = c("CF/NCFB" = "#EA9010", "ILD" = "#BEE5BF")) +
  scale_fill_manual(values = c("CF/NCFB" = "#EA9010", "ILD" = "#BEE5BF")) +
    theme(legend.position = "none", legend.justification = c("left"))
  
ggsave(paste0(paste0("factors-variation/", Sys.Date(), "_b_", paste(fixed_effects, paste0(random_effects, collapse = "+"), sep = "_")), "/", var_select, "re-tx.pdf"), p, width = 10, height = 8, units = 'cm')
  }
```

```{r}
# Over time
for (i in 1:dim(bact_maaslin$`f_Transplant_indication_r_Record.ID+Days`$maaslin_out)[1]){
    
  var_select <- bact_maaslin$`f_Transplant_indication_r_Record.ID+Days`$maaslin_out$Feature[1]
    
p <- ggplot(bact_maaslin$`f_Transplant_indication_r_Record.ID+Days`$var_counts %>% filter(ASV == var_select), aes(x = Days)) + 
        geom_density(aes(fill = Transplant_indication, group = Transplant_indication), alpha = 0.3) +
  
  #geom_smooth(aes(group = Transplant_indication), method = lm, se = FALSE, size = 1, lty = "dashed", colour = "darkgrey") +
        #geom_boxplot(aes(fill = Transplant_indication), alpha = 0.3, outlier.shape = NA) +
        #geom_jitter(aes(colour = Transplant_indication), width = 0.1) +
        theme +
        labs(title = var_select, 
             x = "Transplant indication", 
             y = "LogCSS abundance") +
  plot_colours(Transplant_indication = TRUE) +
  plot_fill(Transplant_indication = TRUE) +
  #facet_grid(.~Days2) +
    theme(legend.position = "none", legend.justification = c("left")) 
  
ggsave(paste0(paste0("factors-variation/", Sys.Date(), "_b_", paste(fixed_effects, paste0(random_effects, collapse = "+"), sep = "_")), "/", var_select, "-comparison.pdf"), p, width = 14, height = 7, units = 'cm')
}


bact_maaslin$`f_Transplant_indication_r_Record.ID+Days`$var_counts %>% filter(ASV == var_select) %>%
  filter(Abundance > 0) %>%
  
ggplot(aes(x = Days, y = Transplant_indication, fill = Abundance)) + 
  geom_density_ridges() +
  labs(x = "Days post-transplant", 
       title = "Taxa density abundance") +
  scale_x_continuous(expand = c(0,0)) +
  theme_light() +
  theme(legend.position = "none") +
  scale_fill_manual(values = colorRampPalette(tax.colours, space = 'rgb')(length(unique(bact.logcss.df$Genus))))



  var_select <- bact_maaslin$`f_Transplant_indication_r_Record.ID+Days`$maaslin_out$Feature[1]
    
p <- ggplot(bact_maaslin$`f_Transplant_indication_r_Record.ID+Days`$var_counts %>% filter(ASV == var_select), aes(x = Days, y = Abundance)) + 
        geom_smooth(aes(group = Transplant_indication, colour = Transplant_indication), method = loess, se = FALSE, size = 1, lty = "dashed") +
        geom_point(aes(colour = Transplant_indication)) +
        theme +
        labs(title = var_select, 
             x = "Transplant indication", 
             y = "LogCSS abundance") +
  plot_colours(Transplant_indication = TRUE) +
  plot_fill(Transplant_indication = TRUE) +
  #facet_grid(.~Days2) +
    theme(legend.position = "none", legend.justification = c("left")) 
  
ggsave(paste0(paste0("factors-variation/", Sys.Date(), "_b_", paste(fixed_effects, paste0(random_effects, collapse = "+"), sep = "_")), "/", var_select, "-comparison.pdf"), p, width = 14, height = 7, units = 'cm')

```

##### Pseudomonas in bal culture

```{r}
## Pseudomonas bal culture
name <- "pseudo-bal-cul-detection"
p <- 
bact_maaslin$`f_Transplant_indication_r_Days+Record.ID`$var_counts %>% filter(ASV == "Pseudomonas|g-2") %>% #, Transplant_indication %in% c("CF/NCFB", "Re-Tx")
  mutate(PseudomonasSpecies = case_when(PseudomonasSpecies == "NoPseudomonasSpecies" ~ "No",
                                        PseudomonasSpecies == "PseudomonasSpecies" ~ "Yes")) %>%
  
ggplot(aes(x = PseudomonasSpecies, y = Abundance)) +
  geom_boxplot(aes(fill = Transplant_indication), outlier.shape = NA, alpha = 0.3) +
  geom_jitter(aes(colour = Transplant_indication), width = 0.1) +
  theme +
  labs(x = " ", 
       y = "LogCSS abundance", 
       colour  = "",
       title = "Positive Pseudomonas BAL culture") +
  stat_compare_means(label = "p.signif", 
                     method = "wilcox.test",
                     label.x.npc = "centre",
                     label.y = 21,
                     ref.group = "No") +
  scale_y_continuous(limits = c(0, 22)) +
  plot_fill(Transplant_indication = TRUE) +
  plot_colours(Transplant_indication = TRUE) +
  facet_grid(.~Transplant_indication, scales = "free_x") +
  theme(legend.position = "none", legend.justification = c("left"))

ggsave(paste0(paste0("factors-variation/", Sys.Date(), "_b_", paste(fixed_effects, paste0(random_effects, collapse = "+"), sep = "_")), "/", name, ".pdf"), p, width = 12, height = 8, units = 'cm')
```

##### Sputum samples after transplant

```{r}
 sputum_metadata <- master.metadata$sputum_metadata %>%
  filter(Record.ID %in% sample_data(bact.logcss)$Record.ID) %>%
  unite(col = "Species", colnames(.)[3:11], sep = ",", na.rm = TRUE) %>%
  separate_rows(Species, sep = ",") %>%
  filter(Species != "No") %>%
  left_join(master.metadata$general_metadata[, c("Record.ID", "Transplant_indication")]) %>%
  mutate(Count = 100,
         Patient_days = paste0(Record.ID, "_", Days),
         Days2 = cut(Days, breaks = c(-1, 42, 2000),
                          labels = c("<42", ">42")),
         Days_post_transplant = cut(Days, breaks = c(-1, 42, 183, 365, 2000),
                          labels = c("<42", "42-183", "184-365", ">665")),
         Days_post_transplant = factor(Days_post_transplant, levels = c("<42", "42-183", "184-365", ">665")))
sputum_metadata$Species <- gsub("NoGrowth", "Negative", sputum_metadata$Species)
sputum_metadata$Species <- factor(sputum_metadata$Species, levels = c("StaphylococcusAureusMRSA", "StenotrophomonasMaltophilia", "PseudomonasSpecies", 
                                              "EscherichiaColi", "YeastSpecies", "AspergillusSpecies",  "ScedosporiumSpecies",  "Other", "Negative"))

name <- "micro-bact-sputum"
p <- 
  
  sputum_metadata %>%
  ggplot(aes(x = as.character(Days), y = Count, fill = Species)) +
  geom_bar(stat = 'identity', position = 'fill', alpha = 0.8) +
  labs(title = "Recipient sputum bacterial composition",
       x = "Patient",
       y = "Percentage") +
  theme +
  theme(axis.text.x = element_blank()) +
  scale_y_continuous(labels = scales::percent) +
  #facet_grid(Days2~Transplant_indication, scales = "free_x", space = "free_x") +
  scale_fill_manual(values = c(tax.colours[c(-7,-10)], "darkgrey"))

ggsave(paste0(paste0("factors-variation/", Sys.Date(), "_b_", paste(fixed_effects, paste0(random_effects, collapse = "+"), sep = "_")), "/", name, ".pdf"), p, width = 26, height = 10, units = 'cm')
```

##### Percentage infected samples

```{r}
per.inf <- data.frame(sample_data(bact.logcss)) %>%
  group_by(Transplant_indication, Class_infection) %>%
  summarise(n = n()) %>%
  mutate(Percentage = 100*round(n/ sum(n), 4))
  
ggplot(per.inf, aes(x = "", y = Percentage, fill = Class_infection)) +
  geom_bar(stat = 'identity') +
  theme +
  theme(legend.position = "bottom") +
  labs(x = " ", 
       fill = "Bronch. reason") +
  coord_polar("y", start=0) +
  facet_wrap(~Transplant_indication, nrow = 1)

name <- "bronch-reason-inf"
p <- 
ggplot(per.inf, aes(x = Transplant_indication, y = Percentage, fill = Class_infection)) +
  geom_bar(stat = 'identity', alpha = 0.8) +
  theme +
  labs(title  = "Bronchoscopy reason", 
       x = " ", 
       fill = "Reason") 
ggsave(paste0("factors-variation/", name, ".pdf"), p, width = 14, height = 8, units = 'cm')
```

# --------------------------------
# Adonis fungi

```{r}
fungi_adonis <- list()
c_list <- list()
d_list <- list()

c <- c("Recipient", "A.fungals", "Imm.suppr", "Donor")
c_list[[1]] <- 'Transplant_indication + Months + Age + Gender'  
c_list[[2]] <- 'Total_antf_num + Voriconazole + Posaconazole'
c_list[[3]] <- 'Tacrolimus_dosage + Cyclosporin_dosage + Mycophenolate_dosage + Prednisolone_dosage + Azathioprine_dosage'
c_list[[4]] <- 'GIT_ischemic_time + Donor_age + Donor_smoking + Donor_gender'

d <- c("All samples", "<6 months", ">6 months")
d_list[[1]] <- fungi.logcss
d_list[[2]] <- phyloseq::subset_samples(fungi.logcss, Days_interval == "<6 months")
d_list[[3]] <- phyloseq::subset_samples(fungi.logcss, Days_interval == ">6 months")

for (e in 1:length(d)){
  
    for (i in 1:length(c)){
      
    dist <- 'wunifrac'

    # Subset datasets 
    param <- c(unlist(strsplit(c_list[[i]], split = " "))[c(TRUE, FALSE)])
    meta <- data.frame(sample_data(d_list[[e]]), check.names = FALSE)[,param] 
    data <- phyloseq::subset_samples(d_list[[e]], Patient_days %in% rownames(meta))
    
    temp_list <- list()
    temp_list[[i]] <- c_list[[i]]
    
      #if (e == 2 & i == 3 | e == 3 & i == 2){
        # Remove columns if all the same and update model
        remove <- list()
        for (a in 1:length(colnames(meta))){
          if (meta[, a] %>% na.omit() %>% unique() %>% length() == 1){
              remove[[a]] <- colnames(meta)[a]}
        }
        
        if (length(unlist(remove)) >= 1){
          for (b in 1:length(unlist(remove))){
            meta <- meta %>% dplyr::select(!c(unlist(remove)[b]))
            temp_list[[i]] <- gsub(as.character(paste0(unlist(remove)[b]), " + "), "", temp_list[[i]], fixed = TRUE) 
          }
        }
      #}
    
      fungi_adonis[[as.character(d[e])]][[as.character(c[i])]][["samples"]] <- data.frame("Samples" = dim(otu_table(data))[2],
                                                                                         "Model" = as.character(c[i]))
    
    set.seed(2)
    fungi_adonis[[as.character(d[e])]][[as.character(c[i])]][["adonis_all"]] <- adonis2(formula = as.formula(paste('phyloseq::distance(data, method = dist) ~', temp_list[[i]])), 
                      data = meta, 
                      distance = dist, 
                      dfun = vegdist, 
                      permutations = 999,
                      na.action = na.omit,
                      parallel = 6)
    fungi_adonis[[as.character(d[e])]][[as.character(c[i])]][["adonis_all_df"]] <- data.frame(fungi_adonis[[as.character(d[e])]][[as.character(c[i])]][["adonis_all"]]) %>%
      rownames_to_column(., "Factor") %>%
      mutate(Factor = gsub("_", " ", Factor)) %>%
      mutate(Factor = gsub("GIT | cat| combined| dosage| num", "", Factor)) %>%
      mutate(Factor = gsub("Age", "Recipient age", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("Gender", "Recipient sex", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("gender", "sex", Factor)) %>%
      mutate(Factor = gsub("FEV1 pre percentage comb", "FEV1% predicted", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("\\+ ", "", Factor)) %>%
      mutate(Factor = gsub("e\\.", "e-", Factor)) %>%
      mutate(Factor = gsub(" antf", " antifungals", Factor)) %>%
      mutate(Factor = gsub(" imm", " immunosuppressants", Factor)) %>%
      mutate(Factor = str_to_sentence(Factor))  %>%
      mutate(Factor = gsub("Months", "Months post-transplant", Factor, fixed = TRUE)) %>%
      mutate(Factor = gsub("Bal", "BAL", Factor, fixed = TRUE)) %>%
      rename(pval = Pr..F.) %>%
      na.omit() %>%
      mutate(Model = c[i])
    
    }
    
    df <- fungi_adonis[[as.character(d[e])]]$Recipient$adonis_all_df %>%
      full_join(fungi_adonis[[as.character(d[e])]]$Donor$adonis_all_df) %>%
      full_join(fungi_adonis[[as.character(d[e])]]$`A.fungals`$adonis_all_df) %>%
      full_join(fungi_adonis[[as.character(d[e])]]$Imm.suppr$adonis_all_df) %>%
      mutate(Model = factor(Model, levels = c("Recipient", "Donor", "A.fungals", "Imm.suppr")),
             Significance = case_when(pval >= 0.05 ~ "",
                                      pval < 0.05 & pval >= 0.01 ~ "*",
                                      pval < 0.01 & pval >= 0.001 ~ "**",
                                      pval < 0.001 & pval >= 0.0001 ~ "***",
                                      pval < 0.0001 ~ "****")) %>%
      mutate(Dataset = d[e])
    fungi_adonis[[as.character(d[e])]][["adonis_plot"]] <- df
    
    ## Samples summary
    samples_df <- rbind(fungi_adonis[[as.character(d[e])]]$Recipient$samples, 
                        fungi_adonis[[as.character(d[e])]]$Donor$samples,
                        fungi_adonis[[as.character(d[e])]]$`A.fungals`$samples, 
                        fungi_adonis[[as.character(d[e])]]$Imm.suppr$samples) %>%
      mutate(Model = factor(Model, levels = c("Recipient", "Donor", "A.fungals", "Imm.suppr")),
             Dataset = d[e])
    fungi_adonis[[as.character(d[e])]][["samples_df"]] <- samples_df

}

df <- fungi_adonis$`All samples`$adonis_plot %>%
      full_join(fungi_adonis$`<6 months`$adonis_plot) %>%
      full_join(fungi_adonis$`>6 months`$adonis_plot) %>%
  
      full_join(rbind(fungi_adonis$`All samples`$samples_df, 
                      fungi_adonis$`<6 months`$samples_df,
                      fungi_adonis$`>6 months`$samples_df
                )) %>%
      mutate(Dataset_samples = paste0(Dataset, " n = ", Samples),
             Dataset = factor(Dataset, levels = d)) %>% 
  arrange(Dataset) %>%
  mutate(Dataset_samples = factor(Dataset_samples, levels = unique(Dataset_samples)))

    p <- 
      
    ggplot(df, aes(x = 100*R2, y = reorder(Factor, 100*R2))) +
      geom_col(fill = "#197278", alpha = 0.5) +
      geom_text(aes(label = paste0(pval, Significance)), hjust = 0, size = 3) +
      theme +
      theme(strip.text.y = element_text(size = 8)) +
      labs(title = "Factors explaining fungal variation",
           x = "R2% explained",
           y = "") +
      scale_x_continuous(limits = c(0, max(df$R2)*100+6)) +
      facet_grid(Model~Dataset_samples, scales = "free_y", space = "free_y")
    
    ggsave(paste0("factors-variation/adonis/fungi/fungi-adonis-all-datasets-6m.pdf"), p, width = 18, height = 12, units = 'cm')
```

# Ischemic time
## PCoA

```{r}
# Ischemic time
data <- phyloseq::subset_samples(fungi.logcss, Days_interval2 == "<6" & !is.na(GIT_ischemic_time)) 
d <- "wunifrac"

a <- data.frame(adonis2(formula = as.formula("phyloseq::distance(data, method = dist) ~ Months+Transplant_indication+Total_antf_cat+GIT_ischemic_time+Record.ID"), 
                    data = data.frame(sample_data(data)), 
                    distance = d, 
                    dfun = vegdist, 
                    na.action = na.omit,
                    permutations = 999,
                    parallel = 6))

annotation <- paste(paste("SumOfSqs =", round(a["GIT_ischemic_time",]$SumOfSqs, 3)),
              paste("R2 =", round(a["GIT_ischemic_time",]$R2, 3)),
              paste("p =", round(a["GIT_ischemic_time",]$Pr..F., 3)), sep = " ; " )

ord <- ordinate(data, method="PCoA", distance="unifrac", weighted=TRUE)
d <- plot_ordination(data, ord)

p <-

plot_ordination(data, ord) + 
  geom_point(aes(fill = GIT_ischemic_time), shape = 21, size = 2) +
  theme +
  theme(legend.position = "right") +
  labs(title = "Fungal ordination (<6 months)",
       caption = annotation,
       colour = "Ischemic time",
       fill = "Ischemic time",
       x = gsub("Axis.1", "PCoA1", d$labels$x),
       y = gsub("Axis.2", "PCoA2", d$labels$y)) +
  scale_fill_gradientn(colours = c("white", "grey", "#659ffc", "#3a86ff"))

ggsave("factors-variation/ischemic-time/fungi-pcoa-ischemic-time.pdf", p, width = 11, height = 7, units = 'cm')
```

## Limma

```{r}
metadata <- data.frame(sample_data(fungi.logcss)) %>% filter(!is.na(GIT_ischemic_time) & Days_interval2 == "<6")
input_data <- data.frame(otu_table(fungi.logcss), check.names = FALSE)[, metadata$Patient_days]

de_matrix <- model.matrix(~Months + Transplant_indication + Total_antf_num + GIT_ischemic_time, metadata) 
corfit <- duplicateCorrelation(input_data, design = de_matrix, block = metadata$Record.ID)
fit <- lmFit(input_data, design = de_matrix, block = metadata$Record.ID, correlation = corfit$consensus)
efit <- eBayes(fit)
summary(decideTests(efit, lfc = 0)) 

# Ischemic time
topTable(efit, coef = "GIT_ischemic_time", number = Inf, adjust = 'BH') %>%
  as.data.frame() %>%
  mutate(Direction = case_when(logFC > 0 ~ "Increased", logFC < 0 ~ "Decreased")) %>% 
  rownames_to_column("ASV")
```

# Tx indication
## PCoA

```{r}
d <- "wunifrac"

a <- data.frame(adonis2(formula = as.formula("phyloseq::distance(fungi.logcss, method = dist) ~ Months+Transplant_indication+Total_antf_cat+GIT_ischemic_time+Record.ID"), 
                    data = data.frame(sample_data(fungi.logcss)), 
                    distance = d, 
                    dfun = vegdist, 
                    na.action = na.omit,
                    permutations = 999,
                    parallel = 6))

annotation <- paste(paste("SumOfSqs =", round(a["Transplant_indication",]$SumOfSqs, 3)),
              paste("R2 =", round(a["Transplant_indication",]$R2, 3)),
              paste("p =", round(a["Transplant_indication",]$Pr..F., 3)), sep = " ; " )

ord <- ordinate(fungi.logcss, method="PCoA", distance="unifrac", weighted=TRUE)
d <- plot_ordination(fungi.logcss, ord)

p <-

plot_ordination(fungi.logcss, ord) + 
  stat_ellipse(aes(fill = Transplant_indication, colour = Transplant_indication), geom = 'polygon', type = 't', level = 0.95, alpha = 0.2) + 
  geom_point(aes(fill = Transplant_indication), shape = 21, size = 2) +
  theme +
  theme(legend.position = "right") +
  labs(title = "Fungal ordination",
       caption = annotation,
       colour = "Transplant indication",
       fill = "Transplant indication",
       x = gsub("Axis.1", "PCoA1", d$labels$x),
       y = gsub("Axis.2", "PCoA2", d$labels$y)) +
  plot_fill(Transplant_indication = TRUE) +
  plot_colours(Transplant_indication = TRUE)

ggsave("factors-variation/tx-indication/fungi-pcoa-tx-indication.pdf", p, width = 11, height = 7, units = 'cm')
```

## Limma

```{r}
metadata <- data.frame(sample_data(fungi.logcss)) %>% filter(!is.na(GIT_ischemic_time))  # & Days_interval2 == ">6"
input_data <- data.frame(otu_table(fungi.logcss), check.names = FALSE)[, metadata$Patient_days]
metadata$Transplant_indication <- fct_relevel(metadata$Transplant_indication, "COPD")

de_matrix <- model.matrix(~Months + Transplant_indication + Total_antf_cat + GIT_ischemic_time, metadata) 
corfit <- duplicateCorrelation(input_data, design = de_matrix, block = metadata$Record.ID)
fit <- lmFit(input_data, design = de_matrix, block = metadata$Record.ID, correlation = corfit$consensus)
efit <- eBayes(fit)
summary(decideTests(efit, lfc = 0)) 

topTable(efit, coef = "Transplant_indicationCF/NCFB", number = Inf, adjust = 'BH') %>% 
    as.data.frame() %>%
    mutate(Direction = case_when(logFC > 0 ~ "Increased", logFC < 0 ~ "Decreased"))

# Same result when filtering or no filtering for Days_interval2 > 6 months
```

```{r}
mm_data_da_tx %>% filter(Transplant_indication == "COPD") %>% group_by(Record.ID) %>% mutate(ASV = case_when(Abundance != 0 ~ "present",
                                                                                                             Abundance == 0 ~ "notpresent")) %>% group_by(Record.ID, ASV) %>% count() %>% filter(ASV == "present") # present at least once in 5 of 7 COPD patients 71% of patients
```

