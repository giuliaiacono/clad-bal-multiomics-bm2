---
title: "MOFA and ML"
author: "Giulia"
date: "09/05/2022"
output: html_document
---


# MACHINE LEARNING
## Combine datasets

```{r}
combined_dataset <- as.data.frame(t(as.matrix(assay(deseq_list$`group+months+tx`$vsd)[rownames(assay(deseq_list$`group+months+tx`$vsd)) %in% rna_top_hits,]))) %>%
  rownames_to_column("Patient_days") %>%
  inner_join(as.data.frame(t(as.matrix(clad_molecules[sm_combined_hits,]))) %>% rownames_to_column("Patient_days") ) %>%
  column_to_rownames("Patient_days")
dim(combined_dataset) # 123 343

combined_metadata <- clad_corr$samples[, c("Patient_days", "Days", "Months", "Group", "Record.ID", "days_to_clad")] %>% 
  inner_join(clad_molecules_metadata[, c("Patient_days", "Days", "Months", "Group", "Record.ID", "days_to_clad")])

#mofa.run.imputed <- mofa_run_list$`clad-rna-small`

ml_features <- c(rna_top_hits, sm_combined_hits)
#combined_dataset <- rbind(mofa.run.imputed@imputed_data$Genes$group1, mofa.run.imputed@imputed_data$Molecules$group1)
#combined_dataset <- combined_dataset[, !is.na(colSums(combined_dataset))] %>% as.data.frame() %>% filter(rownames(.) %in% ml_features)
dim(combined_dataset) #116 187
```

```{r}
#metadata_features_combined <- c("BAL_class_combined", 
#                   "GIT_ischemic_time", "Donor_age_days", "Donor_sex", "Donor_smoking", 
#                   "Recipient_age_days", "Recipient_sex", 
#                   "Macrophages_bal", "Monocytes_bal", "Neutrophils_bal", "T_cell_bal",
#                   "Neutrophils_blood", "Lymphocytes_blood")
ml_metadata <- combined_metadata %>% 
  filter(Patient_days %in% rownames(combined_dataset)) %>%
  mutate(Group = case_when(Group == "CLAD-free" ~ "CLADfree",
                           Group == "CLAD" ~ "CLAD"),
         Group = factor(Group, levels = c("CLADfree", "CLAD")),
         Time_interval = case_when(Days <= 60 ~ "<2 months",
                                         Days > 60 & Days <= 183 ~ "2-6 months",
                                         Days > 183 & Days <= 365 ~ "6-12 months",
                                         Days > 365 ~ ">12 months"), 
         Time_interval = factor(Time_interval, c("<2 months", "2-6 months", "6-12 months", ">12 months")) ) #%>%
  #dplyr::select(c("Patient_days", "Days", "Time_interval", "Group", "Record.ID")) #%>%
  #mutate(Neutrophils_blood = ifelse(is.na(Neutrophils_blood), 0, Neutrophils_blood),
  #       Lymphocytes_blood = ifelse(is.na(Lymphocytes_blood), 0, Lymphocytes_blood)) 

dim(ml_metadata) #123

#metadata_features_bal <- c("Macrophages_bal", "Monocytes_bal", "Neutrophils_bal", "T_cells_bal")
#metadata_features_clinical <- c("BAL_class_combined", #"BAL_class_combined_cumsum", "Hosp_admission_cumsum",
#                   "GIT_ischemic_time", "Donor_age_days", "Donor_sex", "Donor_smoking", 
#                   "Recipient_age_days", "Recipient_sex", 
#                   "Neutrophils_blood", "Lymphocytes_blood")
```

```{r}
# Set predictor
predictor <- combined_dataset %>% 
  #t() %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Patient_days") %>%
  left_join(ml_metadata, by = "Patient_days") %>%
  arrange(Group, Days)

test_set_list <- list()
for (i in 1:3){ # timepoints
  split <- levels(predictor$Time_interval)[i]
  
  test_set_list[["dataset"]][[split]] <- predictor %>% filter(Time_interval == split) %>% dplyr::select(!c("Record.ID", "Patient_days", "Days", "Months", "Time_interval"))
  test_set_list[["rownames"]][[split]] <- predictor %>% filter(Time_interval == split) %>% mutate("row" = as.character(1:dim(.)[1])) %>% dplyr::select(Patient_days, row)
}

train_set <- predictor %>% filter(Time_interval == ">12 months") %>% dplyr::select(!c("Record.ID", "Patient_days", "Days", "Months", "Time_interval"))
dim(train_set) # 23

# Confirm test set size (should be 60%) 60 samples in each split
nrow(train_set) / nrow(test_set_list[["dataset"]][["<2 months"]]) # 0.85 23 / 27
nrow(train_set) / nrow(test_set_list[["dataset"]][["2-6 months"]]) # 0.67 23 / 34
nrow(train_set) / nrow(test_set_list[["dataset"]][["6-12 months"]]) # 0.58 23 / 39
```

### Split predictor

```{r}
test_list <- list()
train_list <- list()

## TRAIN
train_list[["combined"]] <- train_set
train_list[["rna"]] <- train_set %>% dplyr::select(all_of(c(rna_top_hits, "Group")))
train_list[["met_lip"]] <- train_set %>% dplyr::select(all_of(c(sm_combined_hits, "Group")))
#train_list[["clinical"]] <- train_set %>% dplyr::select(all_of(c(metadata_features_clinical, "Group")))
#train_list[["met_lip_clinical"]] <- train_set %>% dplyr::select(all_of(c(sm_combined_hits, metadata_features_clinical, "Group")))
#train_list[["rna_clinical"]] <- train_set %>% dplyr::select(all_of(c(rna_top_hits, metadata_features_combined, "Group")))
train_list[["rna_met_lip"]] <- train_set %>% dplyr::select(all_of(c(rna_top_hits, sm_combined_hits, "Group")))


## TEST
test_list[["<2 months"]][["rna"]] <- test_set_list[["dataset"]][["<2 months"]] %>% dplyr::select(all_of(c(rna_top_hits, "Group")))
test_list[["<2 months"]][["met_lip"]] <- test_set_list[["dataset"]][["<2 months"]] %>% dplyr::select(all_of(c(sm_combined_hits, "Group")))
#test_list[["<2 months"]][["clinical"]] <- test_set_list[["dataset"]][["<2 months"]] %>% dplyr::select(all_of(c(metadata_features_clinical, "Group")))

#test_list[["<2 months"]][["met_lip_clinical"]] <- test_set_list[["dataset"]][["<2 months"]] %>% dplyr::select(all_of(c(sm_combined_hits, metadata_features_clinical, "Group")))
#test_list[["<2 months"]][["rna_clinical"]] <- test_set_list[["dataset"]][["<2 months"]] %>% dplyr::select(all_of(c(rna_top_hits, metadata_features_combined, "Group")))
test_list[["<2 months"]][["rna_met_lip"]] <- test_set_list[["dataset"]][["<2 months"]] %>% dplyr::select(all_of(c(rna_top_hits, sm_combined_hits, "Group")))
#test_list[["<2 months"]][["combined"]] <- test_set_list[["dataset"]][["<2 months"]]


test_list[["2-6 months"]][["rna"]] <- test_set_list[["dataset"]][["2-6 months"]] %>% dplyr::select(all_of(c(rna_top_hits, "Group")))
test_list[["2-6 months"]][["met_lip"]] <- test_set_list[["dataset"]][["2-6 months"]] %>% dplyr::select(all_of(c(sm_combined_hits, "Group")))
#test_list[["2-6 months"]][["clinical"]] <- test_set_list[["dataset"]][["2-6 months"]] %>% dplyr::select(all_of(c(metadata_features_clinical, "Group")))

#test_list[["2-6 months"]][["met_lip_clinical"]] <- test_set_list[["dataset"]][["2-6 months"]] %>% dplyr::select(all_of(c(sm_combined_hits, metadata_features_clinical, "Group")))
#test_list[["2-6 months"]][["rna_clinical"]] <- test_set_list[["dataset"]][["2-6 months"]] %>% dplyr::select(all_of(c(rna_top_hits, metadata_features_combined, "Group")))
test_list[["2-6 months"]][["rna_met_lip"]] <- test_set_list[["dataset"]][["2-6 months"]] %>% dplyr::select(all_of(c(rna_top_hits, sm_combined_hits, "Group")))
#test_list[["2-6 months"]][["combined"]] <- test_set_list[["dataset"]][["2-6 months"]]


test_list[["6-12 months"]][["rna"]] <- test_set_list[["dataset"]][["6-12 months"]] %>% dplyr::select(all_of(c(rna_top_hits, "Group")))
test_list[["6-12 months"]][["met_lip"]] <- test_set_list[["dataset"]][["6-12 months"]] %>% dplyr::select(all_of(c(sm_combined_hits, "Group")))
#test_list[["6-12 months"]][["clinical"]] <- test_set_list[["dataset"]][["6-12 months"]] %>% dplyr::select(all_of(c(metadata_features_clinical, "Group")))

#test_list[["6-12 months"]][["met_lip_clinical"]] <- test_set_list[["dataset"]][["6-12 months"]] %>% dplyr::select(all_of(c(sm_combined_hits, metadata_features_clinical, "Group")))
#test_list[["6-12 months"]][["rna_clinical"]] <- test_set_list[["dataset"]][["6-12 months"]] %>% dplyr::select(all_of(c(rna_top_hits, metadata_features_combined, "Group")))
test_list[["6-12 months"]][["rna_met_lip"]] <- test_set_list[["dataset"]][["6-12 months"]] %>% dplyr::select(all_of(c(rna_top_hits, sm_combined_hits, "Group")))
test_list[["6-12 months"]][["combined"]] <- test_set_list[["dataset"]][["6-12 months"]]

saveRDS(test_list, "caret/2024-06-17/test_list.rds")
saveRDS(train_list, "caret/2024-06-17/train_list.rds")
```

## Caret

```{r}
# Set parameters
set.seed(2)
trControl <- trainControl(
  method = "LGOCV", # Leave Group Out CV (MCCV)
  number = 10, # Number of folds/iterations
  summaryFunction = twoClassSummary, # to use AUC as metric 
  classProbs = TRUE, # always TRUE
  verboseIter = TRUE,
  savePredictions = TRUE
  )
```

```{r}
model_list <- list()
pred_list <- list()
resamples <- list()
t <- c("<2 months", "2-6 months", "6-12 months")
c <- c("rna", "met_lip", "rna_met_lip")  

for (a in 1:3){ # timepoint
  
  timepoint <- t[a]
  
  for (i in 1:3){ # dataset
    
  dataset <- c[i]
  
  method <- "ranger" 
  model_list[[timepoint]][[dataset]][[method]] <- caret::train(
    Group ~ ., 
    data = train_list[[dataset]],
    method = method,
    metric = "ROC",
    #tuneGrid = data.frame(mtry = c(2, 3, 4, 5, 10, 20)),
    tuneLength = 25, 
    importance = "impurity", # or permutation
    trControl = trControl)
  pred <- predict(model_list[[timepoint]][[dataset]][[method]], test_list[[timepoint]][[dataset]], type = "prob")
  pred_list[[timepoint]][[dataset]][[method]] <- data.frame(pred, "reference" = test_list[[timepoint]][[dataset]]$Group, "row" = as.character(1:nrow(test_list[[timepoint]][[dataset]])), Group = method) %>% 
    mutate("prediction" = case_when(CLAD >= 0.5 ~ "CLAD",
                                    CLAD < 0.5 ~ "CLADfree"))
  
  method <- "glm" #no tuning parameters ezist
  model_list[[timepoint]][[dataset]][[method]] <- caret::train(
    Group ~ ., 
    data = train_list[[dataset]],
    family = "binomial",
    method = method,
    metric = "ROC",
    trControl = trControl)
  pred <- predict(model_list[[timepoint]][[dataset]][[method]], test_list[[timepoint]][[dataset]], type = "prob")
  pred_list[[timepoint]][[dataset]][[method]] <- data.frame(pred, "reference" = test_list[[timepoint]][[dataset]]$Group, "row" = as.character(1:nrow(test_list[[timepoint]][[dataset]])),  Group = method) %>% 
    mutate("prediction" = case_when(CLAD >= 0.5 ~ "CLAD",
                                    CLAD < 0.5 ~ "CLADfree"))
  # glmnet is capable of fitting two different kinds of penalized models, controlled by the alpha parameter: Ridge regression (or alpha = 0), Lasso regression (or alpha = 1)
  #compared with glm, glmnet models place constraints on your coefficients, which helps prevent overfitting = “penalized” regression modeling and is a very useful technique on datasets with many predictors and few values.
  method <- "glmnet" 
  model_list[[timepoint]][[dataset]][[method]] <- caret::train(
    Group ~ ., 
    data = train_list[[dataset]],
    method = method,
    metric = "ROC",
    tuneGrid = expand.grid(alpha = 0:1, 
                          lambda = seq(0.0001, 1, length = 10)), 
    trControl = trControl)
  pred <- predict(model_list[[timepoint]][[dataset]][[method]], test_list[[timepoint]][[dataset]], type = "prob")
  pred_list[[timepoint]][[dataset]][[method]] <- data.frame(pred, "reference" = test_list[[timepoint]][[dataset]]$Group, "row" = as.character(1:nrow(test_list[[timepoint]][[dataset]])),  Group = method) %>% 
    mutate("prediction" = case_when(CLAD >= 0.5 ~ "CLAD",
                                    CLAD < 0.5 ~ "CLADfree"))
  plot(model_list[[timepoint]][[dataset]][[method]])
  max(model_list[[timepoint]][[dataset]][[method]]$results$ROC)
  
  # Compare models
  resamples[[timepoint]][[dataset]] <- caret::resamples(model_list[[timepoint]][[dataset]])
  }
}

saveRDS(model_list, "caret/2024-06-17/model_list.rds")
saveRDS(pred_list, "caret/2024-06-17/pred_list.rds")
```


```{r}
summary(resamples$`<3 months`$rna) 
summary(resamples$`<3 months`$met_lip) 
bwplot(resamples$`<3 months`$combined, metric = "ROC") 
bwplot(resamples$`<3 months`$rna, metric = "ROC") 
bwplot(resamples$`<3 months`$met_lip, metric = "ROC")

summary(resamples$`6-12 months`$rna) 
summary(resamples$`6-12 months`$met_lip) 
bwplot(resamples$`6-12 months`$combined, metric = "ROC") 
bwplot(resamples$`6-12 months`$rna, metric = "ROC") 
bwplot(resamples$`6-12 months`$met_lip, metric = "ROC")
```

## ROC curve

```{r}
# predict the outcome on the test set
roc_list <- list()
specs <- list()
c <- c("rna", "met_lip", "rna_met_lip")  
t <- c("<2 months", "2-6 months", "6-12 months")
title <- c("Genes", "Molecules", "Genes & Molecules")
m <- c("ranger", "glm", "glmnet")

for (a in 1:3){ # timepoint
  
  timepoint <- t[a]

  for (i in 1:3){ # dataset
    
  dataset <- c[i]
  
  roc_list[[timepoint]][[dataset]] <- evalm(bind_rows(pred_list[[timepoint]][[dataset]]), title = paste("Receiver operating characteristic curve (ROC)", title[i]), positive = "CLAD", rlinethick = 0.8, fsize = 8, cols = c("#184E77", "#41EAD4", "#8EA4D2"))
  
  p <- roc_list[[timepoint]][[dataset]]$roc + theme + guides(colour = guide_legend("Model")) 
  ggsave(paste0("caret/2024-06-17/roc/", timepoint, "-", dataset, "-pred-roc.pdf"), p, width = 14, height = 9, units = 'cm')
  
    # Extract features
    for (a in 1:3){
      
      method <- m[a]
      
      p <- roc_list[[timepoint]][[dataset]]$optres[[method]] 
      acc <- round((p["TP",1] + p["TN",1]) / (p["TP",1] + p["TN",1] + p["FP",1] + p["FN",1]), 2) # accuracy
      specs[[timepoint]][[dataset]][[method]] <- rbind(p[c("AUC-ROC", "SENS", "SPEC", "FPR", "PREC", "NPV", "TP", "TN", "FP", "FN"), ], "ACC" = c(acc, NA)) %>% 
        dplyr::select(Score) %>% 
        t() %>%
        as.data.frame() %>%
        remove_rownames() %>%
        #add_rownames(., var = as.character(method)) %>%
        mutate(timepoint = timepoint, dataset = dataset, method = method)
    
        roc_list[[timepoint]][[dataset]][[method]]$tpr <- p["SENS",1] #t["TP",1] / (t["TP",1] + t["FN",1]) # sensitivity/true positive rate
        roc_list[[timepoint]][[dataset]][[method]]$tnr <- p["SPEC",1] #t["TN",1] / (t["TN",1] + t["FP",1]) # specificity
        roc_list[[timepoint]][[dataset]][[method]]$fpr <- p["FPR",1] #t["FP",1] / (t["FP",1] + t["TN",1]) # false positive rate
        roc_list[[timepoint]][[dataset]][[method]]$ppv <- p["PREC",1] #t["TP",1] / (t["TP",1] + t["FP",1]) # precision/positive predictive value
        roc_list[[timepoint]][[dataset]][[method]]$npv <- p["NPV",1] # t["TN",1] / (t["TN",1] + t["FN",1]) # negative predictive value
        
        #Accuracy=TP+TN/TP+TN+FP+FN
        #TPR=TP/TP+FN (sensitivity/ recall)
        #TNR=TN/TN+FP (specificity)
        #FPR = FP/FP+TN
        #PPV=TP/TP+FP (precision/ positive predictive value)
        #NPV=TN/TN+FN (negative predictive value)
  
    }
  }
}

saveRDS(roc_list, "caret/2024-06-17/roc_list.rds")
```


```{r}
# Combined table
specs_table <- rbind(bind_rows(specs$`<2 months`$rna),
      bind_rows(specs$`<2 months`$met_lip),
      bind_rows(specs$`<2 months`$rna_met_lip),
      bind_rows(specs$`2-6 months`$rna),
      bind_rows(specs$`2-6 months`$met_lip),
      bind_rows(specs$`2-6 months`$rna_met_lip),
      bind_rows(specs$`6-12 months`$rna),
      bind_rows(specs$`6-12 months`$met_lip),
      bind_rows(specs$`6-12 months`$rna_met_lip)) %>%
  mutate(Dataset = gsub("_", " ", dataset, fixed = TRUE),
         Dataset = gsub("rna met lip", "Genes & Molecules", Dataset, fixed = TRUE),
         Dataset = gsub("rna", "Genes", Dataset, fixed = TRUE),
         Dataset = gsub("met lip", "Molecules", Dataset, fixed = TRUE) )

specs_table %>% group_by(Dataset, method) %>%
  summarise(mean = mean(`AUC-ROC`)) %>%
  arrange(desc(mean))

p <-
  ggplot(specs_table, aes(x = timepoint, y = Dataset)) +
    geom_tile(aes(fill = `AUC-ROC`)) +
    geom_text(aes(label = `AUC-ROC`), vjust = 0.5, hjust = 0.5, size = 4.5) +
    facet_wrap(~method) +
    theme +
  theme(axis.text.x = element_text(angle = -90, size = 10),
        axis.text.y = element_text(size = 10)) +
    labs(title = "AUC-ROC performance", x = "Timepoint") +
    scale_fill_gradient(low = "white", high = "#5C6378")
ggsave(paste0("caret/2024-06-17/roc/roc-table-separate.pdf"), p, width = 19, height = 7, units = 'cm')
```

```{r}
## ROC plot combined best
roc <- evalm(bind_rows(pred_list$`<2 months`$met_lip$glmnet %>% mutate(Group = "<2 months"),
                       pred_list$`2-6 months`$met_lip$glmnet %>% mutate(Group = "2-6 months"),
                       pred_list$`6-12 months`$met_lip$glmnet %>% mutate(Group = "6-12 months") ), 
             title = "Molecules ROC (glmnet)", positive = "CLAD", rlinethick = 0.8, fsize = 11, 
             cols = c("#184E77", "#41EAD4", "#8EA4D2"))
p <- roc$roc + theme + guides(colour = guide_legend("Model")) 
ggsave(paste0("caret/2024-06-17/roc/glmnet-met-lip-combined-pred-roc.pdf"), p, width = 10, height = 6, units = 'cm')

## ROC plot combined best
roc <- evalm(bind_rows(pred_list$`<2 months`$rna$glmnet %>% mutate(Group = "<2 months"),
                       pred_list$`2-6 months`$rna$glmnet %>% mutate(Group = "2-6 months"),
                       pred_list$`6-12 months`$rna$glmnet %>% mutate(Group = "6-12 months") ), 
             title = "Genes ROC (glmnet)", positive = "CLAD", rlinethick = 0.8, fsize = 11, 
             cols = c("#184E77", "#41EAD4", "#8EA4D2"))
p <- roc$roc + theme + guides(colour = guide_legend("Model")) 
ggsave(paste0("caret/2024-06-17/roc/glmnet-rna-combined-pred-roc.pdf"), p, width = 10, height = 6, units = 'cm')

## ROC plot combined best
roc <- evalm(bind_rows(pred_list$`<2 months`$rna_met_lip$glmnet %>% mutate(Group = "<2 months"),
                       pred_list$`2-6 months`$rna_met_lip$glmnet %>% mutate(Group = "2-6 months"),
                       pred_list$`6-12 months`$rna_met_lip$glmnet %>% mutate(Group = "6-12 months") ), 
             title = "Genes & Molecules ROC (glmnet)", positive = "CLAD", rlinethick = 0.8, fsize = 11, 
             cols = c("#184E77", "#41EAD4", "#8EA4D2"))
p <- roc$roc + theme + guides(colour = guide_legend("Model")) 
ggsave(paste0("caret/2024-06-17/roc/glmnet-rna-met-lip-combined-pred-roc.pdf"), p, width = 10, height = 6, units = 'cm')
```


## Trajectory alluvium 

```{r}
sep_pred <- list()
t <- c("<2 months", "2-6 months", "6-12 months")
c <- c("rna", "met_lip", "rna_met_lip")
method <- "glmnet"

for (a in 1:3){ # timepoint
  
  timepoint <- t[a]
  
  for (i in 1:3){ # dataset
    
    dataset <- c[i]
    
    sep_pred[[timepoint]][[dataset]][[method]] <- data.frame(pred_list[[timepoint]][[dataset]][[method]]) %>% 
      dplyr::select(!Group) %>%
      left_join(test_set_list[["rownames"]][[timepoint]]) %>%
      left_join(ml_metadata[, c("Record.ID", "Patient_days", "Days","Time_interval")]) %>%
      mutate(Record.ID = factor(Record.ID)) %>%
      rename(Group = reference) 
  
  }}
```


```{r}
p <- 
      
    ggplot(sep_pred[[timepoint]][[dataset]], aes(x = Days, y = as.character(Record.ID), group = Record.ID)) +
      geom_path(colour = "grey60", size = 0.8) +
      geom_point(aes(fill = prediction, group = Record.ID, shape = BAL_class_combined), size  = 2) +
      labs(x = "Days post-transplant", 
           fill = "Prediction",
           shape = "Sample class",
           title = paste("Classification at", timepoint)) +
      theme +
      theme(axis.text.y = element_blank(), 
            axis.title.y = element_blank()) +
      facet_grid(Group~., scales = "free_y", space = "free_y", switch = "y") +
      scale_shape_manual(values = c(24, 21)) +
      scale_fill_manual(values = c("CLADfree" = "#5C6378", "CLAD" = "#EA9010"))
    ggsave(paste0("caret/2024-06-17/sep-pred/", timepoint, "-", dataset, "-", method, "-separate-patient-samples.pdf"), p, width = 10, height = 6, units = 'cm')


    # Alluvium
    p <- sep_pred[[timepoint]][[dataset]] %>% 
      group_by(Group, Months) %>%
      count(prediction) %>%
      mutate(n = round(n/sum(n)*100, 2)) %>%
      rename(Patients = n) %>%
      arrange(Months) %>%
    
    ggplot(aes(x = Months, y = Patients, alluvium = prediction, fill = prediction, stratum = prediction)) +
      geom_alluvium() +
      geom_stratum() +
      theme +
      labs(x = "Months post-transplant", 
           y = "Percentage of samples",
           fill = "Prediction",
           title = paste("Classification at", timepoint)) +
      facet_grid(.~Group, space = "free", scales = "free") +
      scale_fill_manual(values = c("CLADfree" = "#5C6378", "CLAD" = "#EA9010"))
    ggsave(paste0("caret/2024-06-17/sep-pred/", timepoint, "-", dataset, "-", method, "-alluvium.pdf"), p, width = 12, height = 8, units = 'cm')
    
    # Factor 1 trajectory
    p <- 
      sep_pred[[timepoint]][[dataset]] %>%
      left_join(fact_cov_list[[1]] %>% rename(Patient_days = sample) %>% dplyr::select(Patient_days, value.factor)) %>%
      arrange(Record.ID, Days) %>%
      
      ggplot(aes(x = Days, y = value.factor)) +
      geom_path(aes(group = Record.ID), linewidth = 0.5, colour = "grey") +
      geom_point(aes(fill = prediction), shape = 21, size = 2) +
      labs(title = "Factor 1 over time", y = "Value", x = "Days post-transplant", fill = "Prediction") +
      theme +
      #theme(legend.position = "none") +
      geom_hline(yintercept = 0, lty = "dashed", linewidth = 0.5, colour = "black") +
      facet_grid(.~Group, scales = "free_x", space = "free_x") +
      scale_fill_manual(values = c("CLADfree" = "#5C6378", "CLAD" = "#EA9010"))
    ggsave(paste0("caret/2024-06-17/sep-pred/", timepoint, "-", dataset, "-", method, "-factor1-predictions.pdf"), p, width = 16, height = 8, units = 'cm')
  

saveRDS(sep_pred, "caret/2024-06-17/sep_pred.rds")
```

## Trajectory over entire time post-transplant

```{r}
method <- "glmnet"
d <- rbind(sep_pred$`<2 months`$rna_met_lip[[method]], sep_pred$`2-6 months`$rna_met_lip[[method]],  sep_pred$`6-12 months`$rna_met_lip[[method]]) %>%
  mutate(Classification = ifelse(Group == prediction, "Correct", "Misclassified")) %>% 
  left_join( combined_metadata[, c("Patient_days", "days_to_clad")]) %>% 
  mutate(CLAD_progression = ifelse(is.na(days_to_clad), "CLAD-free", 
                                     ifelse(days_to_clad > 365, "CLAD >365", "CLAD <365")),
           CLAD_progression = factor(CLAD_progression, levels = c("CLAD-free", "CLAD >365", "CLAD <365")))

p <- 
  
ggplot(d, aes(x = Days, y = as.character(Record.ID), group = Record.ID)) +
  geom_path(colour = "grey60", size = 0.8) +
  geom_point(aes(fill = Classification, group = Record.ID), shape = 21, size  = 2) +
  labs(x = "Days post-transplant", 
       fill = "Prediction",
       shape = "Sample class",
       title = paste("Sample classification")) +
  theme +
  theme(strip.text.x = element_text(size = 7),
        strip.text.y = element_text(size = 7),
        axis.text.x = element_text(size = 6),
        axis.text.y = element_blank(), 
        axis.title.y = element_blank()) +
  facet_grid(Group~Time_interval, scales = "free", space = "free", switch = "y") +
  scale_fill_manual(values = c("Correct" = "#5C6378", "Misclassified" = "#8EA4D2"))

ggsave(paste0("caret/2024-06-17/sep-pred/rna-met-lip", method, "-separate-patient-samples-all-days-classification.pdf"), p, width = 17, height = 8.5, units = 'cm')
    

# Alluvium
p <- d %>% 
  group_by(Group, Time_interval) %>%
  dplyr::count(Classification) %>%
  mutate(n = round(n/sum(n)*100, 2)) %>%
  rename(Patients = n) %>%
  arrange(Time_interval) %>%

  ggplot(aes(x = Time_interval, y = Patients, alluvium = Classification, fill = Classification, stratum = Classification)) +
    geom_alluvium() +
    geom_stratum(width = 0.8) +
    theme +
    theme(axis.text.x = element_text(angle = -90, size = 10)) +
    labs(x = "Time interval", 
         y = "Percentage of samples",
         fill = "Classification",
         title = paste("Sample classification")) +
    facet_grid(.~Group, space = "free", scales = "free") +
    #scale_fill_manual(values = c("CLADfree" = "#5C6378", "CLAD" = "#EA9010"))
    scale_fill_manual(values = c("Correct" = "#5C6378", "Misclassified" = "#8EA4D2")) 
ggsave(paste0("caret/2024-06-17/sep-pred/rna-", method, "-alluvium-all-days.pdf"), p, width = 11, height = 7, units = 'cm')


# By CLAD progression
p <- d %>% 
  group_by(Group, CLAD_progression) %>%
  dplyr::count(Classification) %>%
  mutate(n = round(n/sum(n)*100, 2)) %>%
  rename(Patients = n) %>%
  arrange(CLAD_progression) %>%

  ggplot(aes(x = CLAD_progression, y = Patients, alluvium = Classification, fill = Classification, stratum = Classification)) +
    geom_alluvium() +
    geom_stratum() +
    theme +
    theme(axis.text.x = element_text(size = 8)) +
    labs(x = "Time interval", 
         y = "Percentage of samples",
         fill = "Classification",
         title = paste("Sample classification")) +
    facet_grid(.~Group, space = "free", scales = "free") +
    #scale_fill_manual(values = c("CLADfree" = "#5C6378", "CLAD" = "#EA9010"))
    scale_fill_manual(values = c("Correct" = "#5C6378", "Misclassified" = "#8EA4D2")) 
ggsave(paste0("caret/2024-06-17/sep-pred/rna-", method, "-alluvium-progression.pdf"), p, width = 12, height = 7, units = 'cm')
```


## Parameters

```{r}
# compare predicted outcome and true outcome
conf_list <- list()
c <- c("rna_met_lip", "rna", "met_lip")
t <- c("<2 months", "2-6 months", "6-12 months")
method <- "glmnet" 

for (a in 1:3){ # timepoint
  
  timepoint <- t[a]

  for (i in 1:3){ # dataset
  
  dataset <- c[i]
  
  conf_list[[timepoint]][[dataset]][[method]] <- confusionMatrix(predict(model_list[[timepoint]][[dataset]][[method]], 
                                                                         test_list[[timepoint]][[dataset]]), 
                                                                 test_list[[timepoint]][[dataset]]$Group, positive = "CLAD", mode = "everything")
  
  # Mean Accuracy ACC
  conf_list[[timepoint]][[dataset]][[method]]$acc <- t(data.frame(conf_list[[timepoint]][[dataset]][[method]]$overall) %>% filter(rownames(.) == "Accuracy"))
  
  # False Positive Rate FPR is calculated as FP/FP+TN, where FP is the number of false positives and TN is the number of true negatives (FP+TN being the total number of negatives) 
  conf_list[[timepoint]][[dataset]][[method]]$fpr <- conf_list[[timepoint]][[dataset]][[method]]$table[1,2] /
    (conf_list[[timepoint]][[dataset]][[method]]$table[1,2]+conf_list[[timepoint]][[dataset]][[method]]$table[2,2])
  
  #True Positive Rate TPR also called sensitivity is calculated as TP/TP+FN. TPR is the probability that an actual positive will test positive.
  #The true negative rate (also called specificity), which is the probability that an actual negative will test negative. It is calculated as TN/TN+FP.
  conf_list[[timepoint]][[dataset]][[method]]$tpr <- data.frame(conf_list[[timepoint]][[dataset]][[method]]$byClass) %>% filter(rownames(.) == c("Sensitivity"))
  conf_list[[timepoint]][[dataset]][[method]]$tnr <- data.frame(conf_list[[timepoint]][[dataset]][[method]]$byClass) %>% filter(rownames(.) == c("Specificity"))
  
  #The false negative rate – also called the miss rate – is the probability that a true positive will be missed by the test. It’s calculated as FN/FN+TP, where FN is the number of false negatives and TP is the number of true positives (FN+TP being the total number of positives).
  conf_list[[timepoint]][[dataset]][[method]]$fnr <- conf_list[[timepoint]][[dataset]][[method]]$table[2,1] /
    (conf_list[[timepoint]][[dataset]][[method]]$table[2,1]+conf_list[[timepoint]][[dataset]][[method]]$table[1,1])

  }
}

saveRDS(conf_list, "caret/2024-06-17/conf_list.rds")

conf_list$`<2 months`$rna_met_lip$glmnet$fpr #79 
conf_list$`2-6 months`$rna_met_lip$glmnet$tpr #73 
conf_list$`6-12 months`$rna_met_lip$glmnet$tpr #55
```

An alternative to accuracy we showed earlier is “balanced accuracy”. Accuracy does not perform well when classes have very different numbers of samples (class imbalance). For example, if you have 90 CIMP cases and 10 noCIMP cases, classifying all the samples as CIMP gives 0.9 accuracy score by default. Using the “balanced accuracy” metric can help in such situations. This is simply (precision + sensitivity) / 2
In this case above with the class imbalance scenario, the “balanced accuracy” would be 0.5. Another metric that takes into account accuracy that could be generated by chance is the “Kappa statistic” or “Cohen’s Kappa”. This metric includes expected accuracy, which is affected by class imbalance in the training set and provides a metric corrected by that.

## Confusion matrix

```{r}
## Confusion matrix
c <- c("rna_met_lip", "rna", "met_lip")
t <- c("<2 months", "2-6 months", "6-12 months")
title <- c("Genes & Molecules", "Genes", "Molecules")
method <- "glmnet" 

for (a in 1:3){ # timepoint
  
  timepoint <- t[a]

  for (i in 1:3){ # dataset
  
  dataset <- c[i]
  
  s <- specs[[timepoint]][[dataset]][[method]] %>% dplyr::select(TP, TN, FN, FP) %>% t() %>% as.data.frame() %>% rownames_to_column(., var = "Type") %>% rename(Frequency = V1)
  
  conf <- data.frame(conf_list[[timepoint]][[dataset]][[method]]$table) %>% 
    mutate(fill = ifelse(Prediction == Reference, "filled", "empty"),
           Type = c("TN", "FP", "FN", "TP")) #%>%
    #left_join(s, by = "Type")

  
  p <- 
    
  ggplot(conf, aes(x = Reference, y = Prediction)) +
    geom_tile(aes(fill = fill, alpha = Freq), colour = "white") +
    geom_text(aes(label = Freq), vjust = 0.5, hjust = 0.5, size = 10) +
    theme_bw() + 
    theme(plot.title = element_text(face = "bold", size = 11), 
          panel.grid.major = element_blank(),
      legend.position = "none") +
    labs(title = paste("Confusion matrix", timepoint)) + #, title[i]
    scale_fill_manual(values = c("filled" = "#8EA4D2", "empty" = "white"))
  
  ggsave(paste0("caret/2024-06-17/confusion-matrix/", timepoint, "-", dataset, "-", method, "-conf-matrix.pdf"), p, width = 8, height = 6, units = 'cm')

  }

}
```

```{r}
## Combined confusion matrix
conf_combined <- 
  
rbind(data.frame(conf_list$`<2 months`$rna_met_lip$glmnet$table) %>% mutate(Group = "<2 months"),
data.frame(conf_list$`2-6 months`$rna_met_lip$glmnet$table) %>% mutate(Group = "2-6 months"),
data.frame(conf_list$`6-12 months`$rna_met_lip$glmnet$table) %>% mutate(Group = "6-12 months")) %>%
  group_by(Prediction, Reference) %>%
  summarise(Freq_sum = sum(Freq)) %>%
  ungroup() %>%
  mutate(fill = ifelse(Prediction == Reference, "filled", "empty"),
         Type = c("TN", "FP", "FN", "TP"))

  p <- 
    
  ggplot(conf_combined, aes(x = Reference, y = Prediction)) +
    geom_tile(aes(fill = fill, alpha = Freq_sum), colour = "white") +
    geom_text(aes(label = Freq_sum), vjust = 0.5, hjust = 0.5, size = 6) +
    theme_bw() + 
    theme(plot.title = element_text(face = "bold", size = 11), 
          panel.grid.major = element_blank(),
      legend.position = "none") +
    labs(title = paste("Genes & Molecules\nconfusion matrix")) + #, title[i]
    scale_fill_manual(values = c("filled" = "#8EA4D2", "empty" = "white"))
  
  ggsave(paste0("caret/2024-06-17/confusion-matrix/glmnet-rna-conf-matrix.pdf"), p, width = 7, height = 6, units = 'cm')
```


## Top features

```{r}
# Extract top features
# estimate variable importance # permutation importance to put pvalue on features
ml_importance <- list()
c <- c("rna_met_lip", "rna", "met_lip")
t <- c("<2 months", "2-6 months", "6-12 months")
method <- "glmnet" 

for (a in 1:3){ # timepoint
  
  timepoint <- t[a]

  for (i in 1:3){ # dataset
  
    dataset <- c[i]
    
    ml_importance[[timepoint]][[dataset]] <- data.frame(varImp(model_list[[timepoint]][[dataset]][[method]], scale=FALSE)$importance) %>%
      rownames_to_column("Feature") %>%
      mutate(Feature = gsub("`", "", Feature, fixed = TRUE))
    
  }}

ml_importance$`2-6 months`$rna_met_lip %>% arrange(desc(Overall)) 
ml_importance$`6-12 months`$rna_met_lip %>% arrange(desc(Overall)) 
```


```{r}
p <- 
    
      ml_importance[[timepoint]][[dataset]] %>%
      mutate(Overall_per = 100*round(Overall/max(Overall),4),
             Dataset = ifelse(Feature %in% sm_combined_hits, "Molecule", "Gene")) %>%
      arrange(desc(Overall)) %>%
      #group_by(Dataset) %>%
      head(., n = 15) %>%

    ggplot(aes(x = Overall_per, y = reorder(Feature, Overall_per))) +
      geom_col(width = 0.08) +
      geom_point(aes(fill = Dataset), shape = 21, size = 2) +
      theme +
      theme(plot.title = element_text(size = 8)) +
      labs(title = paste("Feature importance", timepoint),
           y = " ",
           x = "Importance") +
      #facet_grid(Dataset~., space = "free", scales = "free") +
      scale_x_continuous(limits = c(0,105), expand = c(0,0)) +
      scale_fill_manual(values = c("lightblue", "grey"))
      
    ggsave(paste0("caret/2024-06-17/importance/", timepoint, "-", dataset, "-", method, "-importance.pdf"), p, width = 10, height = 7, units = 'cm')
  }
}

saveRDS(ml_importance, "caret/2024-06-17/ml_importance.rds")
# ml_importance <- readRDS("caret/2024-06-17/ml_importance.rds")
```

### Are top features DE

```{r}
ml_top_genes <- ml_importance$`<2 months`$rna %>% slice_max(Overall, n = 15) %>% pull(Feature)
ml_top_sm <- ml_importance$`<2 months`$met_lip %>% slice_max(Overall, n = 15) %>% pull(Feature)

sig_ml_top_genes <- bind_rows(bp_group_list) %>%
  mutate(p_adjust = round(p.adjust(.$p, "BH"), 3)) %>%
  mutate(Significance = case_when(p_adjust >= 0.05 ~ "",
                                  p_adjust < 0.05 & p_adjust >= 0.01 ~ "*",
                                  p_adjust < 0.01 & p_adjust >= 0.001 ~ "**",
                                  p_adjust < 0.001 & p_adjust >= 0.0001 ~ "***",
                                  p_adjust < 0.0001 ~ "****")) 

sig_ml_top_genes %>% filter(p_adjust < 0.05)
```


```{r}
# backward/forward recursive feature elimination to rank importance/ accuracy 
# could retrain and see whether the performace is the same and argument that those are the top min best features
# include also logistic regression regular linear model to report baseline if gap not very big then may not have needed to use ranger (i.e. ML)
# recursive partitioning rpart
```

Building an AUC ROC curve will simply explain the maximum possible variable separability of the model. Computing the AUC ROC on train set, will tell if model is confident in it’s learning or not. This is like a student re-answering the same question when taught by teacher during the class.

AUC ROC on test set will tell, how good it performed on unknown dataset. So this is like answering a different question based upon a concept learnt.

The difference between the two if is very large, you the know the student doesn’t understand concepts well, which is nothing but model “overfitting”. However, if the training set’s AUCROC is itself bad, then the model is not learning in the first place any pattern.

It depends what you want. If your focus is just good predictions, then a decent AUC ROC on test set is good to go. But if you want to delve deeper and understand feature importance and model characteristics, check out metrics on train set too.

The best metric/method is a function both of your intended use and the class distributions

For example, accuracy is widely understood but can be misleading when class distributions are highly unbalanced

Sensitivity/Specificity are common in literatures that consider diagnosis (clinical psychology/psychiatry, medicine)

Positive/Negative predictive value are key to consider with sensitivity/specificity when classes are unbalanced

ROC curve and AUC provide nice summary visualization and metric when considering thresholds other than 50% (also common when classes are unbalanced or types of errors matter)

Gini Importance or Mean Decrease in Impurity (MDI) calculates each feature importance as the sum over the number of splits (accross all tress) that include the feature, proportionaly to the number of samples it splits.

Permutation Importance or Mean Decrease in Accuracy (MDA) is assessed for each feature by removing the association between that feature and the target. This is achieved by randomly permuting the values of the feature and measuring the resulting increase in error. The influence of the correlated features is also removed.

# ---------------------------
# Comparison with tissue microarray

```{r}
# Set predictor
metadata <- gene.corrected$samples %>% filter(Patient_days %in% microarray.metadata$Patient_days) 
countdata <- gene.corrected$counts[, metadata$Patient_days] 

predictor <- countdata[deseq_list$`group->12m-all`$GroupCLAD$sig_results_df$Gene, ] %>% 
  t() %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Patient_days") %>%
  left_join(metadata[, c("Patient_days", "Group", "Days", "Record.ID")], by = "Patient_days") %>%
  mutate(Days_interval2 = case_when(Days <= 183+21 ~ "<6 months",
                                    Days > 183+21 ~ ">12 months"), 
         Days_interval2 = factor(Days_interval2, c("<6 months", ">12 months")),
         Group = case_when(Group == "CLAD-free" ~ "CLADfree", Group == "CLAD" ~ "CLAD"),
         Group = factor(Group, levels = c("CLADfree", "CLAD"))) %>%
  arrange(Group, Days)

test_set_list <- list()
for (i in 1){ # timepoints
  split <- levels(predictor$Days_interval2)[i]
  
  test_set_list[["dataset"]][[split]] <- predictor %>% filter(Days_interval2 == split) %>% dplyr::select(!c("Record.ID", "Patient_days", "Days", "Days_interval2"))
  test_set_list[["rownames"]][[split]] <- predictor %>% filter(Days_interval2 == split) %>% mutate("row" = as.character(1:dim(.)[1])) %>% dplyr::select(Patient_days, row)
}

train_set <- predictor %>% filter(Days_interval2 == ">12 months") %>% dplyr::select(!c("Record.ID", "Patient_days", "Days", "Days_interval2"))
dim(train_set) # 21 106

# Confirm test set size (should be 60%) 60 samples in each split
nrow(train_set) / nrow(test_set_list[["dataset"]][["<6 months"]]) # 1.1
```

### Split predictor

```{r}
test_list <- list()
train_list <- list()

## TRAIN
train_list[["rna"]] <- train_set

## TEST
test_list[["<6 months"]][["rna"]] <- test_set_list[["dataset"]][["<6 months"]]

saveRDS(test_list, "caret/tissue-comparison/test_list.rds")
saveRDS(train_list, "caret/tissue-comparison/train_list.rds")
```

## Run Caret

```{r}
model_list <- list()
pred_list <- list()
resamples <- list()
t <- c("<6 months")
c <- c("rna")  

for (a in 1){ # timepoint
  
  timepoint <- t[a]
  
  for (i in 1){ # dataset
    
  dataset <- c[i]
  
  method <- "ranger" 
  model_list[[timepoint]][[dataset]][[method]] <- caret::train(
    Group ~ ., 
    data = train_list[[dataset]],
    method = method,
    metric = "ROC",
    #tuneGrid = data.frame(mtry = c(2, 3, 4, 5, 10, 20)),
    tuneLength = 25, 
    importance = "impurity", # or permutation
    trControl = trControl)
  pred <- predict(model_list[[timepoint]][[dataset]][[method]], test_list[[timepoint]][[dataset]], type = "prob")
  pred_list[[timepoint]][[dataset]][[method]] <- data.frame(pred, "reference" = test_list[[timepoint]][[dataset]]$Group, "row" = as.character(1:nrow(test_list[[timepoint]][[dataset]])), Group = method) %>% 
    mutate("prediction" = case_when(CLAD >= 0.5 ~ "CLAD",
                                    CLAD < 0.5 ~ "CLADfree"))
  
  method <- "glm" #no tuning parameters ezist
  model_list[[timepoint]][[dataset]][[method]] <- caret::train(
    Group ~ ., 
    data = train_list[[dataset]],
    family = "binomial",
    method = method,
    metric = "ROC",
    trControl = trControl)
  pred <- predict(model_list[[timepoint]][[dataset]][[method]], test_list[[timepoint]][[dataset]], type = "prob")
  pred_list[[timepoint]][[dataset]][[method]] <- data.frame(pred, "reference" = test_list[[timepoint]][[dataset]]$Group, "row" = as.character(1:nrow(test_list[[timepoint]][[dataset]])),  Group = method) %>% 
    mutate("prediction" = case_when(CLAD >= 0.5 ~ "CLAD",
                                    CLAD < 0.5 ~ "CLADfree"))

  method <- "glmnet" 
  model_list[[timepoint]][[dataset]][[method]] <- caret::train(
    Group ~ ., 
    data = train_list[[dataset]],
    method = method,
    metric = "ROC",
    tuneGrid = expand.grid(alpha = 0:1, 
                          lambda = seq(0.0001, 1, length = 10)), 
    trControl = trControl)
  pred <- predict(model_list[[timepoint]][[dataset]][[method]], test_list[[timepoint]][[dataset]], type = "prob")
  pred_list[[timepoint]][[dataset]][[method]] <- data.frame(pred, "reference" = test_list[[timepoint]][[dataset]]$Group, "row" = as.character(1:nrow(test_list[[timepoint]][[dataset]])),  Group = method) %>% 
    mutate("prediction" = case_when(CLAD >= 0.5 ~ "CLAD",
                                    CLAD < 0.5 ~ "CLADfree"))
  plot(model_list[[timepoint]][[dataset]][[method]])
  max(model_list[[timepoint]][[dataset]][[method]]$results$ROC)
  
  # Compare models
  resamples[[timepoint]][[dataset]] <- caret::resamples(model_list[[timepoint]][[dataset]])
  }
}

saveRDS(model_list, "caret/tissue-comparison/model_list.rds")
saveRDS(pred_list, "caret/tissue-comparison/pred_list.rds")
```


## ROC curve

```{r}
# predict the outcome on the test set
roc_list <- list()
specs <- list()
t <- c("<6 months")
c <- c("rna") 
title <- c("BAL DE genes")
m <- c("ranger", "glm", "glmnet")

for (a in 1){ # timepoint
  
  timepoint <- t[a]

  for (i in 1){ # dataset
    
  dataset <- c[i]
  
  roc_list[[timepoint]][[dataset]] <- evalm(bind_rows(pred_list[[timepoint]][[dataset]]), title = paste("ROC", title[i]), positive = "CLAD", rlinethick = 0.8, fsize = 8, cols = c("#184E77", "#41EAD4", "#8EA4D2"))
  
  p <- roc_list[[timepoint]][[dataset]]$roc + theme + guides(colour = guide_legend("Model")) 
  ggsave(paste0("caret/tissue-comparison/roc/", timepoint, "-", dataset, "-pred-roc.pdf"), p, width = 12, height = 6, units = 'cm')
  
    # Extract features
    for (g in 1:3){ # method
      
      method <- m[g]
      
      p <- roc_list[[timepoint]][[dataset]]$optres[[method]] 
      acc <- round((p["TP",1] + p["TN",1]) / (p["TP",1] + p["TN",1] + p["FP",1] + p["FN",1]), 2) # accuracy
      specs[[timepoint]][[dataset]][[method]] <- rbind(p[c("AUC-ROC", "SENS", "SPEC", "FPR", "PREC", "NPV", "TP", "TN", "FP", "FN"), ], "ACC" = c(acc, NA)) %>% 
        dplyr::select(Score) %>% 
        t() %>%
        as.data.frame() %>%
        remove_rownames() %>%
        #add_rownames(., var = as.character(method)) %>%
        mutate(timepoint = timepoint, dataset = dataset, method = method)
    
        roc_list[[timepoint]][[dataset]][[method]]$tpr <- p["SENS",1] #t["TP",1] / (t["TP",1] + t["FN",1]) # sensitivity/true positive rate
        roc_list[[timepoint]][[dataset]][[method]]$tnr <- p["SPEC",1] #t["TN",1] / (t["TN",1] + t["FP",1]) # specificity
        roc_list[[timepoint]][[dataset]][[method]]$fpr <- p["FPR",1] #t["FP",1] / (t["FP",1] + t["TN",1]) # false positive rate
        roc_list[[timepoint]][[dataset]][[method]]$ppv <- p["PREC",1] #t["TP",1] / (t["TP",1] + t["FP",1]) # precision/positive predictive value
        roc_list[[timepoint]][[dataset]][[method]]$npv <- p["NPV",1] # t["TN",1] / (t["TN",1] + t["FN",1]) # negative predictive value
        
        #Accuracy=TP+TN/TP+TN+FP+FN
        #TPR=TP/TP+FN (sensitivity/ recall)
        #TNR=TN/TN+FP (specificity)
        #FPR = FP/FP+TN
        #PPV=TP/TP+FP (precision/ positive predictive value)
        #NPV=TN/TN+FN (negative predictive value)
  
    }
  }
}

saveRDS(roc_list, "caret/tissue-comparison/roc_list.rds")
```


```{r}
# Combined table
specs_table <- bind_rows(specs$`<6 months`$microarray) %>%
  mutate(Dataset = gsub("microarray", "All DE genes", dataset, fixed = TRUE))

specs_table %>% group_by(Dataset, method) %>%
  summarise(mean = mean(`AUC-ROC`)) %>%
  arrange(desc(mean))

p <-
  ggplot(specs_table, aes(x = timepoint, y = Dataset)) +
    geom_tile(aes(fill = `AUC-ROC`)) +
    geom_text(aes(label = `AUC-ROC`), vjust = 0.5, hjust = 0.5, size = 4) +
    facet_wrap(~method) +
    theme +
    labs(title = "AUC-ROC performance", x = "Timepoint") +
    scale_fill_gradient(low = "white", high = "#5C6378")
ggsave(paste0("caret/tissue-comparion/roc/roc-table-separate.pdf"), p, width = 20, height = 6, units = 'cm')
```

## Trajectory alluvium 

```{r}
sep_pred <- list()
t <- c("<6 months")
c <- c("microarray") 
method <- "glmnet"

for (a in 1){ # timepoint
  
  timepoint <- t[a]
  
  for (i in 1){ # dataset
    
    dataset <- c[i]
    
    sep_pred[[timepoint]][[dataset]] <- data.frame(pred_list[[timepoint]][[dataset]][[method]]) %>% 
      dplyr::select(!Group) %>%
      left_join(test_set_list[["rownames"]][[timepoint]]) %>%
      left_join(microarray.metadata[, c("Record.ID", "Patient_days", "Days", "Days_interval2", "BAL_class_combined")]) %>%
      mutate(Record.ID = factor(Record.ID)) %>%
      rename(Group = reference) 
  

    p <- 
      
    ggplot(sep_pred[[timepoint]][[dataset]], aes(x = Days, y = as.character(Record.ID), group = Record.ID)) +
      geom_path(colour = "grey60", size = 0.8) +
      geom_point(aes(fill = prediction, group = Record.ID, shape = BAL_class_combined), size  = 2) +
      labs(x = "Days post-transplant", 
           fill = "Prediction",
           shape = "Sample class",
           title = paste("Classification at", timepoint)) +
      theme +
      theme(axis.text.y = element_blank(), 
            axis.title.y = element_blank()) +
      facet_grid(Group~., scales = "free_y", space = "free_y", switch = "y") +
      scale_shape_manual(values = c(24, 21)) +
      scale_fill_manual(values = c("CLADfree" = "#5C6378", "CLAD" = "#EA9010"))
    ggsave(paste0("caret/tissue-comparion/sep-pred/", timepoint, "-", dataset, "-", method, "-separate-patient-samples.pdf"), p, width = 12, height = 8, units = 'cm')


    # Alluvium
    p <- sep_pred[[timepoint]][[dataset]] %>% 
      group_by(Days_interval2, Group) %>%
      count(prediction) %>%
      mutate(n = round(n/sum(n)*100, 2)) %>%
      rename(Patients = n)  %>%
    
    ggplot(aes(x = Days_interval2, y = Patients, alluvium = prediction, fill = prediction, stratum = prediction)) +
      geom_alluvium() +
      geom_stratum() +
      theme +
      labs(x = "Time interval", 
           y = "Percentage of samples",
           fill = "Prediction",
           title = paste("Classification at", timepoint)) +
      facet_grid(.~Group, space = "free", scales = "free") +
      scale_fill_manual(values = c("CLADfree" = "#5C6378", "CLAD" = "#EA9010"))
    ggsave(paste0("caret/tissue-comparion/sep-pred/", timepoint, "-", dataset, "-", method, "-alluvium.pdf"), p, width = 12, height = 8, units = 'cm')
  }
}

saveRDS(sep_pred, "caret/tissue-comparion/sep_pred.rds")
```

## Trajectory over entire time post-transplant

```{r}
method <- "glmnet"
d <- rbind(sep_pred$`<6 months`$microarray) %>%
  mutate(Classification = ifelse(Group == prediction, "Correct", "Misclassified")) %>% 
  left_join(microarray.metadata[, c("Patient_days", "days_to_clad")]) %>% 
  mutate(CLAD_progression = ifelse(is.na(days_to_clad), "CLAD-free", 
                                     ifelse(days_to_clad >= 365, "CLAD >365", "CLAD <365")),
           CLAD_progression = factor(CLAD_progression, levels = c("CLAD-free", "CLAD >365", "CLAD <365")))

p <- 
  
ggplot(d, aes(x = Days, y = as.character(Record.ID), group = Record.ID)) +
  geom_path(colour = "grey60", size = 0.8) +
  geom_point(aes(fill = Classification, group = Record.ID, shape = BAL_class_combined), size  = 2) +
  labs(x = "Days post-transplant", 
       fill = "Prediction",
       shape = "Sample class",
       title = paste("Genes sample classification")) +
  theme +
  theme(strip.text.x = element_text(size = 7),
        strip.text.y = element_text(size = 7),
        axis.text.x = element_text(size = 6),
        axis.text.y = element_blank(), 
        axis.title.y = element_blank()) +
  facet_grid(Group~Days_interval2, scales = "free", space = "free", switch = "y") +
  scale_shape_manual(values = c(24, 21)) +
  scale_fill_manual(values = c("Correct" = "#5C6378", "Misclassified" = "#8EA4D2"))

ggsave(paste0("caret/tissue-comparion/sep-pred/rna-", method, "-separate-patient-samples-all-days-classification.pdf"), p, width = 10, height = 8.5, units = 'cm')
    

# Alluvium
p <- d %>% 
  group_by(Group, Days_interval2) %>%
  count(Classification) %>%
  mutate(n = round(n/sum(n)*100, 2)) %>%
  rename(Patients = n) %>%
  arrange(Days_interval2) %>%

  ggplot(aes(x = Days_interval2, y = Patients, alluvium = Classification, fill = Classification, stratum = Classification)) +
    geom_alluvium() +
    geom_stratum() +
    theme +
    theme(axis.text.x = element_text(size = 8)) +
    labs(x = "Time interval", 
         y = "Percentage of samples",
         fill = "Classification",
         title = paste("Genes sample classification")) +
    facet_grid(.~Group, space = "free", scales = "free") +
    #scale_fill_manual(values = c("CLADfree" = "#5C6378", "CLAD" = "#EA9010"))
    scale_fill_manual(values = c("Correct" = "#5C6378", "Misclassified" = "#8EA4D2")) 
ggsave(paste0("caret/tissue-comparion/sep-pred/rna-", method, "-alluvium-all-days.pdf"), p, width = 10, height = 7, units = 'cm')


# By CLAD progression
p <- d %>% 
  group_by(Group, CLAD_progression) %>%
  count(Classification) %>%
  mutate(n = round(n/sum(n)*100, 2)) %>%
  rename(Patients = n) %>%
  arrange(CLAD_progression) %>%

  ggplot(aes(x = CLAD_progression, y = Patients, alluvium = Classification, fill = Classification, stratum = Classification)) +
    geom_alluvium() +
    geom_stratum() +
    theme +
    theme(axis.text.x = element_text(size = 8)) +
    labs(x = "Time interval", 
         y = "Percentage of samples",
         fill = "Classification",
         title = paste("Genes sample classification")) +
    facet_grid(.~Group, space = "free", scales = "free") +
    #scale_fill_manual(values = c("CLADfree" = "#5C6378", "CLAD" = "#EA9010"))
    scale_fill_manual(values = c("Correct" = "#5C6378", "Misclassified" = "#8EA4D2")) 
ggsave(paste0("caret/tissue-comparion/sep-pred/met-lip-", method, "-alluvium-progression.pdf"), p, width = 10, height = 7, units = 'cm')

```

## Top features

```{r}
# Extract top features
# estimate variable importance # permutation importance to put pvalue on features
ml_importance <- list()
t <- c("<6 months")
c <- c("microarray") 
method <- "glmnet"

for (a in 1){ # timepoint
  
  timepoint <- t[a]

  for (i in 1){ # dataset
  
    dataset <- c[i]
    
    ml_importance[[timepoint]][[dataset]] <- data.frame(varImp(model_list[[timepoint]][[dataset]][[method]], scale=FALSE)$importance) %>%
      rownames_to_column("Feature")
    
    p <- 
    
      ml_importance[[timepoint]][[dataset]] %>%
      mutate(Overall_per = 100*round(Overall/max(Overall),4)) %>%
      arrange(desc(Overall)) %>%
      head(., n = 15) %>%
    ggplot(aes(x = Overall_per, y = reorder(Feature, Overall_per))) +
      geom_col(width = 0.08) +
      geom_point(fill = "#8EA4D2", shape = 21, size = 2) +
      theme +
      theme(plot.title = element_text(size = 8)) +
      labs(title = paste("Feature importance\n", timepoint),
           y = " ",
           x = "Importance") +
      scale_x_continuous(limits = c(0,105), expand = c(0,0))
      
    ggsave(paste0("caret/tissue-comparion/importance/", timepoint, "-", dataset, "-", method, "-importance.pdf"), p, width = 6, height = 7, units = 'cm')
  }
}

saveRDS(ml_importance, "caret/tissue-comparion/ml_importance.rds")
```


```{r}
p <- 

  rbind(ml_importance$`<2 months`$met_lip %>% mutate(Dataset = "Metabolites and lipids"),
        ml_importance$`<2 months`$rna %>% mutate(Dataset = "Genes")) %>%
  group_by(Dataset) %>%
  mutate(Overall_per = 100*round(Overall/max(Overall),4)) %>%
  slice_max(Overall_per, n = 15) %>%

  ggplot(aes(x = Overall_per, y = reorder(Feature, Overall_per))) +
    geom_col(width = 0.08) +
    geom_point(fill = "#8EA4D2", shape = 21, size = 2) +
    theme +
    labs(title = paste("Predictive features"),
         y = " ",
         x = "Importance") +
    scale_x_continuous(limits = c(0,105), expand = c(0,0)) +
    facet_grid(Dataset~., space = "free_y", scales = "free_y")
      
ggsave(paste0("caret/tissue-comparion/2023-05-24/importance/<2 months-met-lip-rna-facet-ranger-importance.pdf"), p, width = 9, height = 12, units = 'cm')


ml_top_genes <- ml_importance$`<2 months`$rna %>% slice_max(Overall, n = 15) %>% pull(Feature)
```


### Top predictors

```{r}
mm_data_da_groups <- as.data.frame( proteomics_data[rownames(proteomics_data) %in% c("ADGRE1", "LAYN", "CD177"), ]) %>% 
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  pivot_longer(!Patient_days, names_to = "Protein", values_to = "Expression") %>%
  left_join(proteomics_metadata[, c("Patient_days", "Group", "Days", "BAL_class_combined", "Record.ID", "Time_interval", "FEV1_pre_percentage_comb")]) 

for (i in 1:length(unique(mm_data_da_groups$Protein))){ #
  
  gene <- unique(mm_data_da_groups$Protein)[i]
  data <- mm_data_da_groups %>% filter(Protein == gene)

  mm_model_da_groups <- lmer(formula = as.formula(paste0("Expression", ' ~Group*ns(Days, df = 2) + (1|Record.ID)')), data = data) # 
  mm_da_groups <- ggpredict(mm_model_da_groups, terms = c("Days [all]", "Group [all]"))
  colnames(mm_da_groups)[1] <- "Days"
  
p <-
  
ggplot() +
  geom_point(aes(x = Days, y = Expression, fill = Group, shape = BAL_class_combined), data = data) +
  theme +
  theme(legend.position = "none") +
  labs(x = "Days post-transplant", 
       y = "Log normalised expression", 
       title = as.character(gene)) +
  geom_ribbon(aes(x = Days, y = predicted, ymin = conf.low, ymax = conf.high, group = group), data = mm_da_groups, alpha = 0.2) +
  geom_line(aes(x = Days, y = predicted, group = group, colour = group), linewidth  = 1, data = mm_da_groups) +
  scale_shape_manual(values = c(21, 24)) +
  plot_fill(Group = TRUE) +
  plot_colours(Group = TRUE)

ggsave(paste0("counts/", gene, ".pdf"), p, width = 8, height = 7, units = 'cm')

}
```




