---
title: "signature-overlap"
output: html_document
date: "2024-08-23"
---

# DE genes overlap

```{r}
l <- list("Adaptive immunity (Stable)" = gene_cluster_assignment %>% filter(Cluster_description == "Adaptive immunity") %>% pull(Gene),
          "Innate immunity (Stable)" = gene_cluster_assignment %>% filter(Cluster_description == "Innate immunity") %>% pull(Gene),
          "Cell signalling (Stable)" = gene_cluster_assignment %>% filter(Cluster_description == "Cell signalling") %>% pull(Gene),
          "DE genes (Biomarker)" = biomarker_rna_combined_df$Gene )

l_p <- process_region_data(Venn(l))$item 
names(l_p) <- process_region_data(Venn(l))$name



p <- 
  ggVennDiagram(l, label_alpha = 0, label_size = 6, label = "count", set_size = 3, set_name_position = c(0.5, 1.5)) + 
  theme(plot.title = element_text(hjust = 0.5, vjust = 1, face = "bold"), 
        legend.position = "none") +
  labs(title = "DE genes overlap across study cohorts") +
  scale_fill_gradient(low = "white", high = "lightgrey") +
  scale_x_continuous(expand = expansion(mult = c(0.4, 0.4))) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1))) 
ggsave("signature-overlap/de-genes-clusters-venn.png", p, width = 15, height = 13, units = 'cm', dpi = 500)  
```

```{r}
overlapping_genes <- c(l_p$`Innate immunity (Stable)/DE genes (Biomarker)`,
l_p$`Adaptive immunity (Stable)/DE genes (Biomarker)`,
l_p$`Cell signalling (Stable)/DE genes (Biomarker)`)
```


## Counts

```{r}
# Counts
b <- assay(deseq_list$`group+months`$vsd)[rownames(assay(deseq_list$`group+months`$vsd)) %in% c("SPHK1", "VEGFA", "S1PR1"),] %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Patient_days") %>%
  pivot_longer(cols = -Patient_days, names_to = "Gene", values_to = "Expression") %>%
  left_join(biomarker_rna_metadata[, c("Patient_days", "Months", "Days", "Group", "Record.ID")]) %>%
  group_by(Record.ID) %>% 
  arrange(Days) %>% 
  mutate(Cohort = "Biomarker")

s <- assay(deseq_list$months$vsd)[rownames(assay(deseq_list$months$vsd)) %in% c("SPHK1", "VEGFA", "S1PR1"),] %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(., var = "Patient_days") %>%
  pivot_longer(cols = -Patient_days, names_to = "Gene", values_to = "Expression") %>%
  left_join(stable_rna_metadata[, c("Patient_days", "Months", "Days", "Group", "Record.ID")]) %>%
  group_by(Record.ID) %>% 
  arrange(Days) %>% 
  mutate(Cohort = "Stable")

#for (i in 1){ #length(unique(m$Gene))
  
  gene <- unique(b$Gene)[3]
  d1 <- b %>% filter(Gene == gene) 
  d2 <- s %>% filter(Gene == gene)
  
#p <-
  
ggplot() +
  geom_smooth(aes(x = Months, y = Expression, group = Group, colour = Group), method = "lm", formula = y ~ ns(x, 3), linewidth = 0.8, data = d1) + # biomarker
  geom_smooth(aes(x = Months, y = Expression, group = Group, colour = Group), method = "lm", formula = y ~ ns(x, 3), linewidth = 0.8, data = d2) + # stable
  theme +
  labs(x = "Months post-transplant", 
       y = "Log normalised expression", 
       title = as.character(gene)) +
  plot_colours(Group = TRUE) +
  plot_fill(Group = TRUE)

#}
```

## Heatmap with intervals

```{r}
# vsd <- vst(rna_corrected$counts, blind=FALSE)

d1 <- scale(t(as.data.frame( assay(vsd)[rownames(assay(vsd)) %in% biomarker_rna_combined, ] ))) %>%
  as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  right_join(stable_rna_metadata[, c("Patient_days", "Months_grouped", "Group", "Record.ID")]) %>%
  filter(!Record.ID %in% biomarker_patients) %>% # remove CLAD-free patients that are also in biomarker cohort
  mutate(Cohort = "Stable") %>%
  dplyr::select(!c("Record.ID"))

d2 <- scale(t(as.data.frame( assay(vsd)[rownames(assay(vsd)) %in% biomarker_rna_combined, ] ))) %>%
  as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  right_join(biomarker_rna_metadata[, c("Patient_days", "Months_grouped", "Group")]) %>%
  mutate(Cohort = "Biomarker") 

identical(colnames(d1), colnames(d2))

m1 <- rbind(d1, d2) %>%
  dplyr::select(!c("Patient_days")) %>%
  group_by(Cohort, Group, Months_grouped) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  arrange(desc(Cohort), Group, Months_grouped) %>%
  mutate(Cohort_group_month = paste(Cohort, paste(Group, Months_grouped, sep = "_"), sep = "_"),
         Cohort_group_month = factor(Cohort_group_month, levels = unique(Cohort_group_month))) %>%
  dplyr::select(!c("Cohort", "Group", "Months_grouped")) %>%
  column_to_rownames("Cohort_group_month") %>%
  t() %>%
  as.data.frame()

df <- biomarker_rna_metadata[, c("Months_grouped", "Immunosuppression", "Group")] %>% distinct() %>% mutate(Cohort = "Biomarker") %>%
  full_join(stable_rna_metadata[, c("Months_grouped", "Immunosuppression", "Group")] %>% distinct() %>% mutate(Cohort = "Stable") ) %>%
  arrange(desc(Cohort), Group, Months_grouped) %>%
  mutate(Cohort_group_month = paste(Cohort, paste(Group, Months_grouped, sep = "_"), sep = "_"),
         Cohort_group_month = factor(Cohort_group_month, levels = unique(Cohort_group_month)),
         Cohort = factor(Cohort, levels = c("Stable", "Biomarker"))) %>%
  rename(`Time post-transplant (months)` = Months_grouped)
rownames(df) <- df$Cohort_group_month

identical(colnames(m1), rownames(df))

colHm <- colorRamp2(breaks = seq(min(m1, na.rm = T)-0.5, max(m1, na.rm = T)-1, length = 7), colors=c('#2166ac','#67a9cf','#d1e5f0', '#f7f7f7', '#fddbc7', '#ef8a62', '#CD0514'))

d <- gene_cluster_assignment[, c("Gene", "Cluster_description")] %>% 
  mutate(Cluster_description = as.character(Cluster_description)) %>% 
  remove_rownames() %>%
  right_join(biomarker_rna_combined_df) %>%
  mutate(Cluster_description = ifelse(is.na(Cluster_description), "Unique", Cluster_description),
         Cluster_description = factor(Cluster_description, levels = c("Adaptive immunity", "Innate immunity", "Cell signalling", "Unique")))
```

```{r} 
p <- 
  
  draw(Heatmap(as.matrix(m1), 
        col = colHm,
        name = "z-score",
        column_title = "DE genes",
        column_title_gp = gpar(fontface = "bold"),
        show_column_names = FALSE,
        show_row_names = FALSE,
        row_names_gp = gpar(fontsize = 9),
        show_row_dend = FALSE,
        show_parent_dend_line = FALSE,
        cluster_row_slices = FALSE,
        cluster_rows = TRUE,
        top_annotation = annotate_heatmap(df, c("Cohort", "Time post-transplant (months)", "Group")),
        column_order = levels(df$Cohort_group_month),
        column_split = df$Cohort,
        row_split = d %>% pull(Cluster_description),
        row_title_gp = gpar(fontface = "bold")),
     padding = unit(c(0, 0, 2, 0), "cm"),
     merge_legend = TRUE,
     heatmap_legend_side = "left")

png("signature-overlap/rna-combined-heat-interval.png", width = 20, height = 30, units = "cm", res = 500)
p
invisible(dev.off())
```

## GO

```{r}
gene.df <- rna_corrected$genes %>% filter(SYMBOL %in% overlapping_genes) 

ego <- enrichGO(gene = gene.df$ENTREZID,
                  OrgDb         = org.Hs.eg.db,
                  ont           = "BP",
                  pAdjustMethod = "BH",
                  pvalueCutoff  = 0.2,
                  qvalueCutoff  = 0.2,
                  readable = TRUE)
ego@result$log_adjpvalue <- abs(log10(ego@result$p.adjust))
if (nrow(ego@result) > 0){
  if (length(unique(ego@result$geneID)) < nrow(ego@result)){
    ego@result <- aggregate(ego@result, by = list(ego@result$geneID), FUN = function(x) {
                                                                  if (is.numeric(x))
                                                                    cbind(x[1]) #max(x)
                                                                  else if (is.character(x))
                                                                  cbind(x[1])
                                                                  }) # keep first value only
  }
}

ego@result$qvalue <- NA
ego_simp <- clusterProfiler::simplify(ego, cutoff = 0.5, by="p.adjust")
ego_simp@result$log_adjpvalue <- abs(log10(ego_simp@result$p.adjust))

ego@result
ego_simp@result %>% filter(p.adjust < 0.05, Count > 4) %>% arrange(pvalue)
```

# DA molecules overlap

```{r}
l <- list("Glycerophospholipids\nmetabolism (Stable)" = stable_molecules_combined_df %>% filter(direction == "Increased") %>% pull(Molecule),
          "Amino acids and\ncarboxylic acid\nmetabolism (Stable)" = stable_molecules_combined_df %>% filter(direction == "Decreased") %>% pull(Molecule),
          "DE genes (Biomarker)" = biomarker_classes$Molecule )

p <- 
  ggVennDiagram(l, label_alpha = 0, label_size = 6, label = "count", set_size = 3, set_name_position = c(0.5, 1.5)) + 
  theme(plot.title = element_text(hjust = 0.5, vjust = 1, face = "bold"), 
        legend.position = "none") +
  labs(title = "DA molecules overlap across study cohorts") +
  scale_fill_gradient(low = "white", high = "lightgrey") +
  scale_x_continuous(expand = expansion(mult = c(0.4, 0.4))) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1))) 

ggsave("signature-overlap/da-molecules-venn.png", p, width = 15, height = 13, units = 'cm', dpi = 500)  

l_p <- process_region_data(Venn(l))$item 
names(l_p) <- process_region_data(Venn(l))$name

l_p$`Decreased (Stable)/Increased in CLAD (Biomarker)`

length(overlapping_molecules) # 5 overlapping
```



## Heatmap with intervals

```{r}
d1 <- scale(t(as.data.frame( small_molecules[rownames(small_molecules) %in% biomarker_classes$Molecule, ] ))) %>%
  as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  right_join(stable_small_molecules_metadata[, c("Patient_days", "Months_grouped", "Group", "Record.ID")]) %>%
  filter(!Record.ID %in% biomarker_patients) %>% # remove CLAD-free patients that are also in biomarker cohort
  mutate(Cohort = "Stable") %>%
  dplyr::select(!c("Record.ID"))

d2 <- scale(t(as.data.frame( small_molecules[rownames(small_molecules) %in% biomarker_classes$Molecule, ] ))) %>%
  as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  right_join(biomarker_small_molecules_metadata[, c("Patient_days", "Months_grouped", "Group")]) %>%
  mutate(Cohort = "Biomarker") 

identical(colnames(d1), colnames(d2))

m2 <- rbind(d1, d2) %>%
  dplyr::select(!c("Patient_days")) %>%
  group_by(Cohort, Group, Months_grouped) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  arrange(desc(Cohort), Group, Months_grouped) %>%
  mutate(Cohort_group_month = paste(Cohort, paste(Group, Months_grouped, sep = "_"), sep = "_"),
         Cohort_group_month = factor(Cohort_group_month, levels = unique(Cohort_group_month))) %>%
  dplyr::select(!c("Cohort", "Group", "Months_grouped")) %>%
  column_to_rownames("Cohort_group_month") %>%
  t() %>%
  as.data.frame()

df <- biomarker_small_molecules_metadata[, c("Months_grouped", "Immunosuppression", "Group")] %>% distinct() %>% mutate(Cohort = "Biomarker") %>%
  full_join(stable_small_molecules_metadata[, c("Months_grouped", "Immunosuppression", "Group")] %>% distinct() %>% mutate(Cohort = "Stable") ) %>%
  arrange(desc(Cohort), Group, Months_grouped) %>%
  mutate(Cohort_group_month = paste(Cohort, paste(Group, Months_grouped, sep = "_"), sep = "_"),
         Cohort_group_month = factor(Cohort_group_month, levels = unique(Cohort_group_month)),
         Cohort = factor(Cohort, levels = c("Stable", "Biomarker"))) %>%
  rename(`Time post-transplant (months)` = Months_grouped)
rownames(df) <- df$Cohort_group_month

identical(colnames(m2), rownames(df))

colHm <- colorRamp2(breaks = seq(-2, 2, length = 7), colors=c('#2166ac','#67a9cf','#d1e5f0', '#f7f7f7', '#fddbc7', '#ef8a62', '#CD0514'))

d <- ms_cluster_assignment[, c("Molecule", "Cluster_description")] %>% 
  mutate(Cluster_description = as.character(Cluster_description)) %>% 
  remove_rownames() %>%
  right_join(biomarker_classes) %>%
  mutate(Cluster_description = ifelse(is.na(Cluster_description), "Unique", Cluster_description),
         Cluster_description = factor(Cluster_description, levels = c("Amino and carboxylic acid metabolism", "Glycerophospholipid metabolism", "Unique")))
```

```{r} 
p <- 
  
  draw(Heatmap(as.matrix(m2), 
        col = colHm,
        name = "z-score",
        column_title = "DA molecules",
        column_title_gp = gpar(fontface = "bold"),
        show_column_names = FALSE,
        show_row_names = FALSE,
        row_names_gp = gpar(fontsize = 6),
        show_row_dend = FALSE,
        show_parent_dend_line = FALSE,
        cluster_row_slices = FALSE,
        cluster_rows = TRUE,
        top_annotation = annotate_heatmap(df, c("Cohort", "Time post-transplant (months)", "Group")),
        column_order = levels(df$Cohort_group_month),
        column_split = df$Cohort,
        row_split = d %>% pull(Cluster_description),
        row_title_gp = gpar(fontface = "bold")),
     padding = unit(c(0, 0, 2, 0), "cm"),
     merge_legend = TRUE,
     heatmap_legend_side = "left")

png("signature-overlap/molecules-combined-heat-interval.png", width = 20, height = 30, units = "cm", res = 500)
p
invisible(dev.off())
```

# Combined heatmap

```{r}
identical(colnames(m1), colnames(m2))
m <- rbind(m2, m1)
d <- data.frame("Feature" = rownames(m)) %>%
  mutate("Dataset" = ifelse(Feature %in% rownames(m2), "Molecule", "Gene"))

colHm <- colorRamp2(breaks = seq(min(m, na.rm = T), max(m, na.rm = T)-1, length = 7), colors=c('#2166ac','#67a9cf','#d1e5f0', '#f7f7f7', '#fddbc7', '#ef8a62', '#CD0514'))

p <- 
  
  draw(Heatmap(as.matrix(m), 
        col = colHm,
        name = "z-score",
        column_title = "",
        column_title_gp = gpar(fontface = "bold"),
        show_column_names = FALSE,
        show_row_names = FALSE,
        row_names_gp = gpar(fontsize = 6),
        show_row_dend = FALSE,
        show_parent_dend_line = FALSE,
        cluster_row_slices = TRUE,
        cluster_rows = TRUE,
        top_annotation = annotate_heatmap(df, c("Cohort", "Time post-transplant (months)", "Group")),
        column_order = levels(df$Cohort_group_month),
        column_split = df$Cohort,
        row_split = d$Dataset,
        row_title_gp = gpar(fontface = "bold")),
     padding = unit(c(1, 0, 0, 0), "cm"),
     merge_legend = TRUE,
     heatmap_legend_side = "left")

png("signature-overlap/combined-heat-interval-all.png", width = 18, height = 20, units = "cm", res = 500)
p
invisible(dev.off())
```



